<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TheGame ‚Äî –£—á—ë—Ç –¥–æ—Ö–æ–¥–æ–≤</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white">
  <div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;
const tg = window.Telegram?.WebApp;

function App() {
  const [activeTab, setActiveTab] = useState('monthlyReport');
  const [loading, setLoading] = useState(true);

  const [dolgo, setDolgo] = useState([]);
  const [individuals, setIndividuals] = useState([]);
  const [rentals, setRentals] = useState([]);
  const [expenses, setExpenses] = useState([]);
  const [passive, setPassive] = useState([]);
  const [students, setStudents] = useState([]);

  const fmt = n => new Intl.NumberFormat('ru-RU').format(Number(n||0));

  const calcTeacherExpense = (income, rate) => {
    if (rate === '50%') return income * 0.5;
    if (rate === '700') return 700;
    if (rate === '1000') return 1000;
    if (rate === '100%') return income;
    const num = parseFloat(rate);
    return isNaN(num) ? 0 : num;
  };

  useEffect(() => {
    const load = key => JSON.parse(localStorage.getItem(key) || '[]');
    setDolgo(load('dolgo'));
    setIndividuals(load('individuals'));
    setRentals(load('rentals'));
    setExpenses(load('expenses'));
    setPassive(load('passive'));
    setStudents(load('students'));
    setLoading(false);
  }, []);

  useEffect(()=>localStorage.setItem('dolgo',JSON.stringify(dolgo)),[dolgo]);
  useEffect(()=>localStorage.setItem('individuals',JSON.stringify(individuals)),[individuals]);
  useEffect(()=>localStorage.setItem('rentals',JSON.stringify(rentals)),[rentals]);
  useEffect(()=>localStorage.setItem('expenses',JSON.stringify(expenses)),[expenses]);
  useEffect(()=>localStorage.setItem('passive',JSON.stringify(passive)),[passive]);
  useEffect(()=>localStorage.setItem('students',JSON.stringify(students)),[students]);

  /* ===== –ó–ê–†–ü–õ–ê–¢–´ –ü–ï–î–ê–ì–û–ì–û–í (–ê–í–¢–û) ===== */
  const teachersSalary = {};

  dolgo.forEach(r => {
    const income = Number(r.income||0);
    const salary = calcTeacherExpense(income, r.rate);
    const hall = Number(r.hallExpense||0);
    const profit = income - salary - hall;

    if (!teachersSalary[r.teacher]) {
      teachersSalary[r.teacher] = {
        teacher: r.teacher,
        location: r.location,
        days: new Set(),
        lessons: 0,
        income: 0,
        salary: 0,
        hall: 0,
        profit: 0
      };
    }

    const t = teachersSalary[r.teacher];
    t.days.add(r.date);
    t.lessons += 1;
    t.income += income;
    t.salary += salary;
    t.hall += hall;
    t.profit += profit;
  });

  const teachersSalaryList = Object.values(teachersSalary).map(t=>({
    ...t,
    days: t.days.size,
    percent: t.income ? Math.round((t.salary/t.income)*100) : 0
  }));

  const exportTeachersSalary = () => {
    let csv = '–ü–µ–¥–∞–≥–æ–≥,–õ–æ–∫–∞—Ü–∏—è,–î–Ω–µ–π,–ó–∞–Ω—è—Ç–∏–π,–î–æ—Ö–æ–¥,–ó–∞—Ä–ø–ª–∞—Ç–∞,–ó–∞–ª,–ü—Ä–∏–±—ã–ª—å,%\n';
    teachersSalaryList.forEach(t=>{
      csv += `${t.teacher},${t.location},${t.days},${t.lessons},${t.income},${t.salary},${t.hall},${t.profit},${t.percent}\n`;
    });
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = '–∑–∞—Ä–ø–ª–∞—Ç—ã_–ø–µ–¥–∞–≥–æ–≥–æ–≤.csv';
    a.click();
  };

  if (loading) return <div className="p-6">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>;

  return (
    <div className="p-4 max-w-6xl mx-auto">
      <h1 className="text-2xl font-bold mb-4">üí∞ TheGame ‚Äî –£—á—ë—Ç –¥–æ—Ö–æ–¥–æ–≤</h1>

      <div className="flex gap-2 mb-6 flex-wrap">
        {[
          ['monthlyReport','–ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç'],
          ['dolgo','–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ'],
          ['teachersSalary','–ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤']
        ].map(([id,title])=>(
          <button
            key={id}
            onClick={()=>setActiveTab(id)}
            className={`px-3 py-1 rounded ${activeTab===id?'bg-blue-600':'bg-slate-700'}`}
          >
            {title}
          </button>
        ))}
      </div>

      {activeTab==='teachersSalary' && (
        <section>
          <div className="flex justify-between mb-4">
            <h2 className="text-lg font-bold">üíº –ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤</h2>
            <button onClick={exportTeachersSalary} className="bg-green-600 px-3 py-2 rounded">
              –≠–∫—Å–ø–æ—Ä—Ç CSV
            </button>
          </div>

          <table className="w-full text-sm bg-slate-800 rounded">
            <thead className="border-b border-slate-700">
              <tr>
                <th>–ü–µ–¥–∞–≥–æ–≥</th>
                <th>–î–Ω–µ–π</th>
                <th>–ó–∞–Ω—è—Ç–∏–π</th>
                <th>–î–æ—Ö–æ–¥</th>
                <th>–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
                <th>–ó–∞–ª</th>
                <th>–ü—Ä–∏–±—ã–ª—å</th>
                <th>%</th>
              </tr>
            </thead>
            <tbody>
              {teachersSalaryList.map((t,i)=>(
                <tr key={i} className="border-b border-slate-700/40 text-center">
                  <td className="text-left">
                    <b>{t.teacher}</b>
                    <div className="text-xs text-slate-400">{t.location}</div>
                  </td>
                  <td>{t.days}</td>
                  <td>{t.lessons}</td>
                  <td className="text-green-400">{fmt(t.income)}‚ÇΩ</td>
                  <td className="text-yellow-400">{fmt(t.salary)}‚ÇΩ</td>
                  <td className="text-red-400">{fmt(t.hall)}‚ÇΩ</td>
                  <td className="text-blue-400 font-bold">{fmt(t.profit)}‚ÇΩ</td>
                  <td>{t.percent}%</td>
                </tr>
              ))}
            </tbody>
          </table>
        </section>
      )}
    </div>
  );
}

ReactDOM.render(<App/>, document.getElementById('root'));
</script>
</body>
</html>
