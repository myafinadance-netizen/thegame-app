<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TheGame ‚Äî –£—á—ë—Ç –¥–æ—Ö–æ–¥–æ–≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;
const tg = window.Telegram?.WebApp;

function App() {

  /* ================== STATES ================== */
  const [activeTab, setActiveTab] = useState('monthlyReport');
  const [dolgo, setDolgo] = useState([]);
  const [individuals, setIndividuals] = useState([]);
  const [rentals, setRentals] = useState([]);
  const [expenses, setExpenses] = useState([]);
  const [passive, setPassive] = useState([]);
  const [students, setStudents] = useState([]);

  /* ================== LOAD ================== */
  useEffect(() => {
    setDolgo(JSON.parse(localStorage.getItem('dolgo') || '[]'));
    setIndividuals(JSON.parse(localStorage.getItem('individuals') || '[]'));
    setRentals(JSON.parse(localStorage.getItem('rentals') || '[]'));
    setExpenses(JSON.parse(localStorage.getItem('expenses') || '[]'));
    setPassive(JSON.parse(localStorage.getItem('passive') || '[]'));
    setStudents(JSON.parse(localStorage.getItem('students') || '[]'));
  }, []);

  useEffect(() => localStorage.setItem('dolgo', JSON.stringify(dolgo)), [dolgo]);
  useEffect(() => localStorage.setItem('individuals', JSON.stringify(individuals)), [individuals]);
  useEffect(() => localStorage.setItem('rentals', JSON.stringify(rentals)), [rentals]);
  useEffect(() => localStorage.setItem('expenses', JSON.stringify(expenses)), [expenses]);
  useEffect(() => localStorage.setItem('passive', JSON.stringify(passive)), [passive]);
  useEffect(() => localStorage.setItem('students', JSON.stringify(students)), [students]);

  const fmt = n => new Intl.NumberFormat('ru-RU').format(n || 0);

  /* ================== BUSINESS ================== */
  const calcTeacherExpense = (income, rate) => {
    if (rate === '50%') return income * 0.5;
    if (rate === '100%') return income;
    if (!isNaN(rate)) return Number(rate);
    return 0;
  };

  /* ================== SALARY ================== */
  const salaryMap = {};

  dolgo.forEach(r => {
    if (!r.teacher) return;

    const income = r.income || 0;
    const salary = calcTeacherExpense(income, r.rate);
    const hall = r.hallExpense || 0;
    const profit = income - salary - hall;

    if (!salaryMap[r.teacher]) {
      salaryMap[r.teacher] = {
        teacher: r.teacher,
        location: r.location,
        days: new Set(),
        lessons: 0,
        income: 0,
        salary: 0,
        hall: 0,
        profit: 0
      };
    }

    salaryMap[r.teacher].days.add(r.date);
    salaryMap[r.teacher].lessons += 1;
    salaryMap[r.teacher].income += income;
    salaryMap[r.teacher].salary += salary;
    salaryMap[r.teacher].hall += hall;
    salaryMap[r.teacher].profit += profit;
  });

  const salaryList = Object.values(salaryMap).map(t => ({
    ...t,
    days: t.days.size,
    efficiency: t.income ? Math.round((t.profit / t.income) * 100) : 0
  }));

  /* ================== UI ================== */
  return (
    <div className="min-h-screen p-4 max-w-6xl mx-auto">

      <h1 className="text-2xl font-bold mb-4">üí∞ TheGame ‚Äî –£—á—ë—Ç –¥–æ—Ö–æ–¥–æ–≤</h1>

      <nav className="flex flex-wrap gap-2 mb-6">
        {[
          {id:'monthlyReport', title:'–ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç'},
          {id:'dolgo', title:'–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ'},
          {id:'individuals', title:'–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ'},
          {id:'rentals', title:'–ê—Ä–µ–Ω–¥–∞'},
          {id:'expenses', title:'–†–∞—Å—Ö–æ–¥—ã'},
          {id:'passive', title:'–ü–∞—Å—Å–∏–≤–Ω—ã–π'},
          {id:'students', title:'–£—á–µ–Ω–∏–∫–∏'},
          {id:'salary', title:'üíº –ó–∞—Ä–ø–ª–∞—Ç–∞ –ø–µ–¥–∞–≥–æ–≥–æ–≤'},
        ].map(t=>(
          <button key={t.id}
            onClick={()=>setActiveTab(t.id)}
            className={`px-3 py-1 rounded ${activeTab===t.id ? 'bg-blue-600' : 'bg-slate-700'}`}>
            {t.title}
          </button>
        ))}
      </nav>

      {activeTab === 'salary' && (
        <section>
          <h2 className="text-lg font-bold mb-4">üíº –ó–∞—Ä–ø–ª–∞—Ç–∞ –ø–µ–¥–∞–≥–æ–≥–æ–≤</h2>
          <table className="w-full text-sm">
            <thead className="text-slate-300 border-b border-slate-700">
              <tr>
                <th>–ü–µ–¥–∞–≥–æ–≥</th>
                <th className="text-center">–î–Ω–µ–π</th>
                <th className="text-center">–ó–∞–Ω—è—Ç–∏–π</th>
                <th className="text-right">–î–æ—Ö–æ–¥</th>
                <th className="text-right">–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
                <th className="text-right">–ó–∞–ª</th>
                <th className="text-right">–ü—Ä–∏–±—ã–ª—å</th>
                <th className="text-center">%</th>
              </tr>
            </thead>
            <tbody>
              {salaryList.map((t,i)=>(
                <tr key={i} className="border-b border-slate-700/40">
                  <td><b>{t.teacher}</b><div className="text-xs text-slate-400">üìç {t.location}</div></td>
                  <td className="text-center">{t.days}</td>
                  <td className="text-center">{t.lessons}</td>
                  <td className="text-right text-green-400">{fmt(t.income)}‚ÇΩ</td>
                  <td className="text-right text-yellow-400">{fmt(t.salary)}‚ÇΩ</td>
                  <td className="text-right text-red-400">{fmt(t.hall)}‚ÇΩ</td>
                  <td className="text-right text-blue-400 font-bold">{fmt(t.profit)}‚ÇΩ</td>
                  <td className="text-center font-bold">{t.efficiency}%</td>
                </tr>
              ))}
            </tbody>
          </table>
        </section>
      )}

    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
