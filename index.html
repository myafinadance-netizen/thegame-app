<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤ - –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ (—É–ª—É—á—à–µ–Ω–æ)</title>
  <style>
    /* –°—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–æ –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ + –Ω–µ–±–æ–ª—å—à–æ–π —Å–ø–∏–Ω–Ω–µ—Ä/—Ç–æ—Å—Ç */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; background:#0f172a; color:#fff; padding:10px; }
    .container { max-width:1400px; margin:0 auto; }
    .header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px; flex-wrap:wrap; gap:10px; }
    .header-left h1 { font-size:24px; margin-bottom:5px; }
    .subtitle { color:#94a3b8; font-size:13px; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; }
    .btn { background:#1e40af; color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-size:13px; font-weight:500; transition:all .15s; }
    .btn:hover{ background:#1e3a8a; }
    .btn.secondary{ background:#334155; }
    .btn.success{ background:#059669; }
    .btn.small{ padding:6px 10px; font-size:12px; }
    .stats{ display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:10px; margin-bottom:20px; }
    .stat-card{ background:linear-gradient(135deg,#1e3a8a 0%,#1e40af 100%); padding:15px; border-radius:10px; box-shadow:0 4px 6px rgba(0,0,0,.3); }
    .stat-label{ font-size:10px; text-transform:uppercase; letter-spacing:.5px; opacity:.8; margin-bottom:5px; }
    .stat-value{ font-size:24px; font-weight:bold; }
    .table-container{ background:#1e293b; border-radius:10px; padding:15px; margin-bottom:15px; overflow-x:auto; }
    table{ width:100%; border-collapse:collapse; min-width:600px; }
    th{ padding:10px 6px; text-align:left; color:#cbd5e1; font-size:12px; border-bottom:2px solid #334155; }
    td{ padding:12px 6px; border-bottom:1px solid #334155; font-size:13px; }
    .badge{ display:inline-block; background:#2563eb; color:#fff; padding:4px 10px; border-radius:15px; font-weight:bold; font-size:12px; }
    .amount{ font-weight:bold; font-size:14px; }
    .green{ color:#4ade80; } .yellow{ color:#fbbf24; } .red{ color:#f87171; } .blue{ color:#60a5fa; } .purple{ color:#a78bfa; }
    .modal{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.85); z-index:1000; overflow-y:auto; padding:10px; }
    .modal.active{ display:block; }
    .modal-content{ background:#1e293b; border-radius:12px; padding:20px; max-width:800px; width:100%; margin:20px auto; max-height:calc(100vh - 40px); overflow-y:auto; }
    .modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
    .modal-title{ font-size:18px; font-weight:bold; }
    .close-btn{ background:none; border:none; color:#94a3b8; font-size:28px; cursor:pointer; padding:0; width:30px; height:30px; line-height:1; }
    .upload-zone{ border:2px dashed #475569; border-radius:10px; padding:30px; text-align:center; background:rgba(59,130,246,.05); cursor:pointer; }
    .upload-icon{ font-size:40px; margin-bottom:10px; }
    .upload-text{ color:#cbd5e1; font-size:14px; margin-bottom:5px; }
    .upload-hint{ color:#94a3b8; font-size:12px; }
    .form-group{ margin-bottom:12px; }
    .form-group label{ display:block; color:#cbd5e1; font-size:13px; margin-bottom:5px; font-weight:500; }
    .form-group input, .form-group select{ width:100%; background:#334155; border:1px solid #475569; color:#fff; padding:10px; border-radius:6px; font-size:14px; }
    .form-actions{ display:flex; gap:8px; margin-top:15px; justify-content:flex-end; }
    .info-box{ background:rgba(59,130,246,.08); border-left:4px solid #3b82f6; padding:15px; border-radius:8px; margin-bottom:15px; }
    .preview-section{ background:#334155; padding:12px; border-radius:8px; margin-bottom:12px; }
    .preview-title{ color:#93c5fd; font-weight:bold; margin-bottom:8px; font-size:13px; }
    .preview-item{ padding:6px 0; border-bottom:1px solid #475569; font-size:13px; }
    .preview-item:last-child{ border-bottom:none; }
    .toast { position: fixed; top: 12px; right: 12px; z-index: 2000; }
    .toast .alert { background:#1e293b; border-left:4px solid #22c55e; padding:12px 16px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.5); color:#fff; margin-bottom:8px; display:flex; gap:10px; align-items:center; }
    .toast .alert.error { border-left-color:#ef4444; }
    .spinner { width:18px; height:18px; border:3px solid rgba(255,255,255,.15); border-top-color:#fff; border-radius:50%; animation:spin .9s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    @media (max-width:768px){ .header-left h1{ font-size:20px } .controls{ width:100% } .btn{ width:100% } .stats{ grid-template-columns:repeat(2,1fr) } table{ font-size:11px } th, td{ padding:8px 4px } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <h1>üíº –ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤</h1>
        <div class="subtitle">–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ</div>
      </div>
      <div class="controls">
        <button class="btn success" id="openUploadBtn">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å DOCX</button>
        <button class="btn" id="openCalendarBtn">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
        <button class="btn" id="openGroupsBtn">üìã –ì—Ä—É–ø–ø—ã</button>
        <button class="btn secondary" id="openExpenseBtn">üí∏ –†–∞—Å—Ö–æ–¥</button>
        <button class="btn secondary" id="exportBtn">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
      </div>
    </div>

    <div class="stats" id="statsContainer"></div>

    <div class="table-container">
      <h2 style="margin-bottom:15px; font-size:16px;">üìä –ü–æ –ø–µ–¥–∞–≥–æ–≥–∞–º</h2>
      <table>
        <thead>
          <tr>
            <th>–ü–µ–¥–∞–≥–æ–≥</th>
            <th class="text-center">–ó–∞–Ω—è—Ç–∏–π</th>
            <th class="text-center">–õ—é–¥–µ–π</th>
            <th class="text-right">–ì—Ä–∞–Ω—Ç</th>
            <th class="text-right">–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
            <th class="text-right">–ê—Ä–µ–Ω–¥–∞</th>
            <th class="text-right">–ü—Ä–∏–±—ã–ª—å</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot style="background:#0f172a; font-weight:bold;" id="tableFoot"></tfoot>
      </table>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal" id="uploadModal" role="dialog" aria-modal="true" aria-labelledby="uploadTitle">
    <div class="modal-content" tabindex="-1">
      <div class="modal-header">
        <div class="modal-title" id="uploadTitle">üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞</div>
        <button class="close-btn" data-close="uploadModal">√ó</button>
      </div>
      <div id="uploadContent">
        <div class="upload-zone" id="uploadZone">
          <div class="upload-icon">üìÑ</div>
          <div class="upload-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª DOCX</div>
          <div class="upload-hint">–û—Ç—á–µ—Ç –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</div>
        </div>
        <input type="file" id="docxFile" accept=".docx" style="display:none" />
      </div>
    </div>
  </div>

  <div class="modal" id="calendarModal" role="dialog" aria-modal="true" aria-labelledby="calendarTitle">
    <div class="modal-content" tabindex="-1">
      <div class="modal-header">
        <div class="modal-title" id="calendarTitle">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
        <button class="close-btn" data-close="calendarModal">√ó</button>
      </div>
      <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <button class="btn secondary small" id="prevMonth">‚Üê</button>
        <div style="font-weight:bold;" id="currentMonth"></div>
        <button class="btn secondary small" id="nextMonth">‚Üí</button>
      </div>
      <div id="calendarContent"></div>
    </div>
  </div>

  <div class="modal" id="groupsModal" role="dialog" aria-modal="true" aria-labelledby="groupsTitle">
    <div class="modal-content" tabindex="-1">
      <div class="modal-header">
        <div class="modal-title" id="groupsTitle">üìã –ì—Ä—É–ø–ø—ã</div>
        <button class="close-btn" data-close="groupsModal">√ó</button>
      </div>
      <button class="btn success" id="addGroupBtn" style="margin-bottom:15px; width:100%;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
      <div id="groupsList"></div>
    </div>
  </div>

  <div class="modal" id="groupFormModal" role="dialog" aria-modal="true" aria-labelledby="groupFormTitle">
    <div class="modal-content" tabindex="-1" style="max-width:500px;">
      <div class="modal-header">
        <div class="modal-title" id="groupFormTitle">–ì—Ä—É–ø–ø–∞</div>
        <button class="close-btn" data-close="groupFormModal">√ó</button>
      </div>
      <form id="groupForm">
        <input type="hidden" id="editGroupId" />
        <div class="form-group">
          <label>–ö–æ–¥ –≥—Ä—É–ø–ø—ã *</label>
          <input type="text" id="groupCode" placeholder="G-02250378" required />
        </div>
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
          <input type="text" id="groupName" placeholder="–¢–∞–Ω—Ü—ã" required />
        </div>
        <div class="form-group">
          <label>–ü–µ–¥–∞–≥–æ–≥ *</label>
          <input type="text" id="groupTeacher" placeholder="–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ –ò–≤–∞–Ω–æ–≤–∞" required />
        </div>
        <div class="form-group">
          <label>–õ–æ–∫–∞—Ü–∏—è *</label>
          <select id="groupLocation" required>
            <option value="–ë—É–¥–µ–Ω–Ω–æ–≥–æ">–ë—É–¥–µ–Ω–Ω–æ–≥–æ</option>
            <option value="–ß–µ—Ä–∫–∏–∑–æ–≤—Å–∫–∞—è">–ß–µ—Ä–∫–∏–∑–æ–≤—Å–∫–∞—è</option>
            <option value="–ü–∞—Ä–∫">–ü–∞—Ä–∫</option>
            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
          </select>
        </div>
        <div class="form-group">
          <label>–¢–∏–ø –æ–ø–ª–∞—Ç—ã *</label>
          <select id="groupSalaryType" onchange="toggleSalaryLabel()">
            <option value="percent">–ü—Ä–æ—Ü–µ–Ω—Ç %</option>
            <option value="fixed">–§–∏–∫—Å —Å—Ç–∞–≤–∫–∞</option>
          </select>
        </div>
        <div class="form-group">
          <label id="groupSalaryLabel">–ü—Ä–æ—Ü–µ–Ω—Ç (%) *</label>
          <input type="number" id="groupSalaryValue" min="0" step="0.01" required />
        </div>
        <div class="form-group">
          <label>–ê—Ä–µ–Ω–¥–∞ –∑–∞–ª–∞ (‚ÇΩ)</label>
          <input type="number" id="groupHallCost" min="0" value="0" />
        </div>
        <div class="form-actions">
          <button type="button" class="btn secondary" data-close="groupFormModal">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="expenseModal" role="dialog" aria-modal="true" aria-labelledby="expenseTitle">
    <div class="modal-content" tabindex="-1" style="max-width:400px;">
      <div class="modal-header">
        <div class="modal-title" id="expenseTitle">üí∏ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</div>
        <button class="close-btn" data-close="expenseModal">√ó</button>
      </div>
      <form id="expenseForm">
        <div class="form-group">
          <label>–î–∞—Ç–∞</label>
          <input type="date" id="expenseDate" required />
        </div>
        <div class="form-group">
          <label>–ì—Ä—É–ø–ø–∞</label>
          <select id="expenseGroup" required></select>
        </div>
        <div class="form-group">
          <label>–°—É–º–º–∞ (‚ÇΩ)</label>
          <input type="number" id="expenseAmount" min="0" required />
        </div>
        <div class="form-group">
          <label>–ü—Ä–∏—á–∏–Ω–∞</label>
          <input type="text" id="expenseReason" placeholder="–ê—Ä–µ–Ω–¥–∞ –æ–ø–ª–∞—á–µ–Ω–∞, –∑–∞–Ω—è—Ç–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ" />
        </div>
        <div class="form-actions">
          <button type="button" class="btn secondary" data-close="expenseModal">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast area -->
  <div class="toast" id="toastArea" aria-live="polite"></div>

  <script>
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –¥–∞–Ω–Ω—ã–µ
    const GRANT_PER_PERSON = 280;
    const MONTHS = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];

    let groups = [], calendar = [], sessions = [], expenses = [];
    let currentMonth = new Date(2025,0,1);
    let lastImport = []; // –º–∞—Å—Å–∏–≤ id —Å–µ—Å—Å–∏–π, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ–¥–Ω–∏–º –∏–º–ø–æ—Ä—Ç–æ–º
    let mammothLoaded = false;

    // -------------------------------
    // Storage
    // -------------------------------
    function loadData() {
      groups = JSON.parse(localStorage.getItem('groups') || '[]');
      calendar = JSON.parse(localStorage.getItem('calendar') || '[]');
      sessions = JSON.parse(localStorage.getItem('sessions') || '[]');
      expenses = JSON.parse(localStorage.getItem('expenses') || '[]');

      if (groups.length === 0) {
        groups = [{
          id: generateId(),
          code: "G-02250378",
          name: "–¢–∞–Ω—Ü—ã",
          teacher: "–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ –ò–≤–∞–Ω–æ–≤–∞",
          location: "–ë—É–¥–µ–Ω–Ω–æ–≥–æ",
          salaryType: "percent",
          salaryValue: 50,
          hallCost: 0
        }];
      }

      saveData();
      updateDisplay();
    }

    function saveData() {
      localStorage.setItem('groups', JSON.stringify(groups));
      localStorage.setItem('calendar', JSON.stringify(calendar));
      localStorage.setItem('sessions', JSON.stringify(sessions));
      localStorage.setItem('expenses', JSON.stringify(expenses));
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2,9);
    }

    // -------------------------------
    // UI utilities (XSS-safe)
    // -------------------------------
    function escapeHtml(str = '') {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function createAlertNode(message, type = 'success', actions = []) {
      const el = document.createElement('div');
      el.className = `alert ${type === 'error' ? 'error' : ''}`;
      const text = document.createElement('div');
      text.style.flex = '1';
      text.textContent = message;
      el.appendChild(text);
      actions.forEach(a => {
        const btn = document.createElement('button');
        btn.className = 'btn small';
        btn.textContent = a.label;
        btn.onclick = a.onClick;
        el.appendChild(btn);
      });
      return el;
    }

    function showToast(message, type = 'success', actions = [], timeout = 4000) {
      const area = document.getElementById('toastArea');
      const node = createAlertNode(message, type, actions);
      area.appendChild(node);
      if (timeout > 0) {
        setTimeout(() => {
          node.remove();
        }, timeout);
      }
      return node;
    }

    // -------------------------------
    // Modal handling + focus trap
    // -------------------------------
    let activeModal = null;
    let lastFocused = null;

    function openModal(id) {
      const modal = document.getElementById(id);
      if (!modal) return;
      lastFocused = document.activeElement;
      modal.classList.add('active');
      activeModal = modal;
      const firstFocusable = modal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      if (firstFocusable) firstFocusable.focus();
      document.addEventListener('keydown', modalKeyHandler);
    }

    function closeModal(id) {
      const modal = document.getElementById(id);
      if (!modal) return;
      modal.classList.remove('active');
      activeModal = null;
      if (lastFocused && lastFocused.focus) lastFocused.focus();
      document.removeEventListener('keydown', modalKeyHandler);
    }

    function modalKeyHandler(e) {
      if (e.key === 'Escape') {
        if (activeModal) activeModal.classList.remove('active');
        activeModal = null;
        document.removeEventListener('keydown', modalKeyHandler);
      } else if (e.key === 'Tab' && activeModal) {
        // focus-trap
        const focusables = activeModal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        if (focusables.length === 0) return;
        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      }
    }

    // close buttons
    document.addEventListener('click', e => {
      const close = e.target.closest('[data-close]');
      if (close) {
        closeModal(close.getAttribute('data-close'));
      }
      // close modal when clicking backdrop
      if (e.target.classList && e.target.classList.contains('modal')) {
        e.target.classList.remove('active');
      }
    });

    // -------------------------------
    // Groups (render XSS-safe)
    // -------------------------------
    function renderGroupsList() {
      const container = document.getElementById('groupsList');
      container.innerHTML = '';
      if (groups.length === 0) {
        const p = document.createElement('p');
        p.style.color = '#94a3b8';
        p.style.textAlign = 'center';
        p.style.padding = '20px';
        p.textContent = '–ù–µ—Ç –≥—Ä—É–ø–ø';
        container.appendChild(p);
        return;
      }
      groups.forEach(g => {
        const card = document.createElement('div');
        card.className = 'group-card';
        card.style.background = '#334155';
        card.style.padding = '12px';
        card.style.borderRadius = '8px';
        card.style.marginBottom = '8px';

        const h3 = document.createElement('h3');
        h3.textContent = `${g.code} - ${g.name}`;
        h3.style.fontSize = '14px';
        h3.style.marginBottom = '5px';
        card.appendChild(h3);

        const p = document.createElement('p');
        p.style.color = '#94a3b8';
        p.style.fontSize = '12px';
        p.style.marginBottom = '8px';
        const salaryStr = g.salaryType === 'percent' ? `${g.salaryValue}%` : `${formatNumber(g.salaryValue)}‚ÇΩ`;
        p.innerHTML = `üë§ ${escapeHtml(g.teacher)} ‚Ä¢ üìç ${escapeHtml(g.location)}<br>üí∞ ${escapeHtml(salaryStr)} ${g.hallCost > 0 ? ' ‚Ä¢ üè¢ ' + escapeHtml(formatNumber(g.hallCost) + '‚ÇΩ') : ''}`;
        card.appendChild(p);

        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '5px';

        const editBtn = document.createElement('button');
        editBtn.className = 'btn secondary small';
        editBtn.textContent = '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å';
        editBtn.onclick = () => showEditGroupForm(g.id);

        const delBtn = document.createElement('button');
        delBtn.className = 'btn secondary small';
        delBtn.textContent = 'üóëÔ∏è';
        delBtn.onclick = () => {
          if (!confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?')) return;
          groups = groups.filter(x => x.id !== g.id);
          saveData();
          renderGroupsList();
          updateDisplay();
        };

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        card.appendChild(actions);

        container.appendChild(card);
      });
    }

    function showAddGroupForm() {
      document.getElementById('groupFormTitle').textContent = '–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞';
      document.getElementById('editGroupId').value = '';
      document.getElementById('groupCode').value = '';
      document.getElementById('groupName').value = '';
      document.getElementById('groupTeacher').value = '';
      document.getElementById('groupLocation').value = '–ë—É–¥–µ–Ω–Ω–æ–≥–æ';
      document.getElementById('groupSalaryType').value = 'percent';
      document.getElementById('groupSalaryValue').value = '50';
      document.getElementById('groupHallCost').value = '0';
      toggleSalaryLabel();
      openModal('groupFormModal');
    }

    function showEditGroupForm(id) {
      const g = groups.find(x => x.id === id);
      if (!g) return;
      document.getElementById('groupFormTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
      document.getElementById('editGroupId').value = g.id;
      document.getElementById('groupCode').value = g.code;
      document.getElementById('groupName').value = g.name;
      document.getElementById('groupTeacher').value = g.teacher;
      document.getElementById('groupLocation').value = g.location;
      document.getElementById('groupSalaryType').value = g.salaryType;
      document.getElementById('groupSalaryValue').value = g.salaryValue;
      document.getElementById('groupHallCost').value = g.hallCost;
      toggleSalaryLabel();
      openModal('groupFormModal');
    }

    function toggleSalaryLabel() {
      const type = document.getElementById('groupSalaryType').value;
      document.getElementById('groupSalaryLabel').textContent = type === 'percent' ? '–ü—Ä–æ—Ü–µ–Ω—Ç (%) *' : '–°—Ç–∞–≤–∫–∞ (‚ÇΩ) *';
    }

    document.getElementById('groupForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const editId = document.getElementById('editGroupId').value;
      const data = {
        code: document.getElementById('groupCode').value.trim(),
        name: document.getElementById('groupName').value.trim(),
        teacher: document.getElementById('groupTeacher').value.trim(),
        location: document.getElementById('groupLocation').value,
        salaryType: document.getElementById('groupSalaryType').value,
        salaryValue: parseFloat(document.getElementById('groupSalaryValue').value),
        hallCost: parseFloat(document.getElementById('groupHallCost').value) || 0
      };
      if (editId) {
        const g = groups.find(x => x.id === editId);
        if (g) Object.assign(g, data);
      } else {
        data.id = generateId();
        groups.push(data);
      }
      saveData();
      closeModal('groupFormModal');
      showToast(editId ? '–û–±–Ω–æ–≤–ª–µ–Ω–æ!' : '–ì—Ä—É–ø–ø–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
      renderGroupsList();
      updateDisplay();
    });

    // -------------------------------
    // Calendar (unchanged logic but XSS-safe rendering)
    // -------------------------------
    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      document.getElementById('currentMonth').textContent = `${MONTHS[month]} ${year}`;
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startDay = firstDay.getDay(); // 0..6 (–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ..–°—É–±–±–æ—Ç–∞)
      let wrapper = document.createElement('div');
      wrapper.className = 'calendar-grid';
      ['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'].forEach(d => {
        const hd = document.createElement('div');
        hd.style.fontWeight = 'bold';
        hd.style.textAlign = 'center';
        hd.style.padding = '5px';
        hd.style.fontSize = '11px';
        hd.textContent = d;
        wrapper.appendChild(hd);
      });
      for (let i = 0; i < startDay; i++) {
        wrapper.appendChild(document.createElement('div'));
      }
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const cals = calendar.filter(c => c.date === dateStr);
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        if (cals.length > 0) dayEl.classList.add('has-schedule');
        dayEl.onclick = () => showAddToCalendar(dateStr);
        const num = document.createElement('div');
        num.className = 'calendar-day-number';
        num.textContent = day;
        dayEl.appendChild(num);
        cals.forEach(c => {
          const g = groups.find(x => x.id === c.groupId);
          if (!g) return;
          const div = document.createElement('div');
          div.className = 'calendar-class';
          div.textContent = `${c.time || '09:00'} ${g.teacher.split(' ')[0]}`;
          dayEl.appendChild(div);
        });
        wrapper.appendChild(dayEl);
      }
      const content = document.getElementById('calendarContent');
      content.innerHTML = '';
      content.appendChild(wrapper);
    }

    function showAddToCalendar(dateStr) {
      const title = new Date(dateStr).toLocaleDateString('ru-RU');
      const modal = document.getElementById('addToCalendarModal');
      // create small modal dynamically (to avoid many static modals)
      const html = `
        <div class="modal" id="tmpAddCal" style="display:block;">
          <div class="modal-content" style="max-width:400px;">
            <div class="modal-header">
              <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å ‚Äî ${escapeHtml(title)}</div>
              <button class="close-btn" id="tmpClose">√ó</button>
            </div>
            <form id="tmpCalForm">
              <input type="hidden" id="tmpCalDate" value="${escapeHtml(dateStr)}"/>
              <div class="form-group">
                <label>–ì—Ä—É–ø–ø–∞</label>
                <select id="tmpCalGroup" required>
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                  ${groups.map(g => `<option value="${g.id}">${escapeHtml(g.code)} - ${escapeHtml(g.name)}</option>`).join('')}
                </select>
              </div>
              <div class="form-group">
                <label>–í—Ä–µ–º—è</label>
                <input type="time" id="tmpCalTime" value="09:00"/>
              </div>
              <div class="form-actions">
                <button type="button" class="btn secondary" id="tmpCancel">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
            </form>
          </div>
        </div>
      `;
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      document.body.appendChild(wrapper.firstElementChild);
      const tmp = document.getElementById('tmpAddCal');
      const form = document.getElementById('tmpCalForm');
      tmp.querySelector('#tmpClose').addEventListener('click', () => tmp.remove());
      tmp.querySelector('#tmpCancel').addEventListener('click', () => tmp.remove());
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const groupId = form.querySelector('#tmpCalGroup').value;
        const time = form.querySelector('#tmpCalTime').value;
        if (!groupId) { showToast('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É', 'error'); return; }
        calendar.push({ id: generateId(), date: dateStr, time, groupId });
        saveData();
        tmp.remove();
        renderCalendar();
        showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å!');
      });
    }

    document.getElementById('prevMonth').addEventListener('click', () => {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
      renderCalendar();
    });
    document.getElementById('nextMonth').addEventListener('click', () => {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
      renderCalendar();
    });

    // -------------------------------
    // Expenses
    // -------------------------------
    function showAddExpenseModal() {
      document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
      const select = document.getElementById('expenseGroup');
      select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>' + groups.map(g => `<option value="${g.id}">${escapeHtml(g.code)} - ${escapeHtml(g.name)}</option>`).join('');
      openModal('expenseModal');
    }

    document.getElementById('expenseForm').addEventListener('submit', function(e) {
      e.preventDefault();
      expenses.push({
        id: generateId(),
        date: document.getElementById('expenseDate').value,
        groupId: document.getElementById('expenseGroup').value,
        amount: parseFloat(document.getElementById('expenseAmount').value),
        reason: document.getElementById('expenseReason').value
      });
      saveData();
      closeModal('expenseModal');
      updateDisplay();
      showToast('–†–∞—Å—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω!');
    });

    // -------------------------------
    // Upload DOCX - lazy load mammoth + improved parsing
    // -------------------------------
    async function ensureMammoth() {
      if (window.mammoth) { mammothLoaded = true; return; }
      if (mammothLoaded) return;
      return new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js';
        s.onload = () => { mammothLoaded = true; res(); };
        s.onerror = () => rej(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å mammoth.js'));
        document.head.appendChild(s);
      });
    }

    document.getElementById('openUploadBtn').addEventListener('click', () => {
      // set up upload area and file input
      openModal('uploadModal');
    });

    document.getElementById('uploadZone').addEventListener('click', () => {
      document.getElementById('docxFile').click();
    });

    document.getElementById('docxFile').addEventListener('change', handleFileUpload);

    async function handleFileUpload(event) {
      const file = event.target.files ? event.target.files[0] : null;
      if (!file) return;
      // lazy load mammoth
      try {
        const loading = showToast('–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞...', 'success', [], 2000);
        await ensureMammoth();
        loading.remove();
      } catch (err) {
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä—Å–µ—Ä–∞', 'error');
        return;
      }

      const processingToast = showToast('–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...', 'success', [], 0);
      try {
        const arrayBuffer = await file.arrayBuffer();
        const result = await window.mammoth.extractRawText({ arrayBuffer });
        const text = result.value || '';
        const parsedData = parseReport(text);
        processingToast.remove();
        if (!parsedData) {
          showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç', 'error');
          return;
        }
        showPreview(parsedData);
      } catch (err) {
        processingToast.remove();
        showToast('–û—à–∏–±–∫–∞: ' + (err.message || err), 'error');
        console.error(err);
      } finally {
        // reset input
        event.target.value = '';
      }
    }

    // Improved parser: tolerant to several formats, counts '+', '‚úì', explicit numbers (e.g. "3 —á–µ–ª")
    function parseReport(text) {
      console.log('Parsing document...');
      if (!text || text.trim().length === 0) { showToast('–ü—É—Å—Ç–æ–π –¥–æ–∫—É–º–µ–Ω—Ç', 'error'); return null; }
      const norm = text.replace(/\r/g, '\n');

      // 1) Find group code (several heuristics)
      const codeMatch = norm.match(/–∫–æ–¥\s*–≥—Ä—É–ø–ø[–∞-—è]*\s*[:\-\s]*([A-Za-z–ê-–Ø–∞-—è0-9\-\u0400-\u04FF]+)/i)
        || norm.match(/([A-Z–ê-–Ø–Å][A-Z–ê-–Ø–Å0-9\-]{1,}[-‚Äì‚Äî]\d{4,})/i)
        || norm.match(/([A-Z]-\d{8})/i)
        || norm.match(/(G-\d{8})/i);

      if (!codeMatch) {
        showToast('–ö–æ–¥ –≥—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ', 'error');
        return null;
      }
      const code = codeMatch[1].trim();
      const group = groups.find(g => g.code.toLowerCase() === code.toLowerCase());
      if (!group) {
        showToast(`–ì—Ä—É–ø–ø–∞ ${code} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ`, 'error');
        return null;
      }

      // 2) Find dates: accept DD.MM.YYYY or DD.MM (with optional year)
      const dateRegex = /(\b\d{1,2})\.(\d{1,2})(?:\.(\d{2,4}))?/g;
      const dates = [];
      for (const m of norm.matchAll(dateRegex)) {
        const day = parseInt(m[1], 10);
        const month = parseInt(m[2], 10);
        const year = m[3] ? parseInt(m[3], 10) : null;
        if (day >= 1 && day <= 31 && month >= 1 && month <= 12) {
          dates.push({ raw: m[0], day, month, year, index: m.index });
        }
      }
      if (dates.length === 0) { showToast('–î–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ', 'error'); return null; }

      // Guess year from document (most common 4-digit year) or fallback to current year
      const yearMatchAll = [...norm.matchAll(/\b(19|20)\d{2}\b/g)];
      let guessedYear = null;
      if (yearMatchAll.length > 0) {
        // choose most frequent
        const counts = {};
        yearMatchAll.forEach(m => counts[m[0]] = (counts[m[0]] || 0) + 1);
        guessedYear = Object.keys(counts).reduce((a,b) => counts[a] > counts[b] ? a : b);
        guessedYear = parseInt(guessedYear, 10);
      } else {
        guessedYear = new Date().getFullYear();
      }

      // 3) For each date, extract segment until next date and count attendance:
      //    - count occurrences of '+', '‚úì'
      //    - find explicit numbers followed by "—á–µ–ª", "—á–µ–ª–æ–≤–µ–∫", or standalone small numbers in the segment
      const sessionsFound = [];
      for (let i = 0; i < dates.length; i++) {
        const d = dates[i];
        const nextIndex = i + 1 < dates.length ? dates[i+1].index : norm.length;
        const segment = norm.slice(d.index, nextIndex);

        let count = 0;
        // marks
        count += (segment.match(/[+‚úì]/g) || []).length;
        // numbers with "—á–µ–ª" or "—á–µ–ª–æ–≤–µ–∫" or "—á"
        const numWithLabel = [...segment.matchAll(/(\d{1,3})\s*(?:—á–µ–ª|—á–µ–ª–æ–≤–µ–∫|—á)\b/ig)];
        if (numWithLabel.length) {
          count = Math.max(count, numWithLabel.reduce((s,m) => s + parseInt(m[1],10), 0));
        } else {
          // standalone small numbers (avoid matching years like 2025 by limiting 1-3 digits but ignore >300)
          const nums = [...segment.matchAll(/\b(\d{1,3})\b/g)].map(m => parseInt(m[1],10)).filter(n => n > 0 && n < 300);
          if (nums.length) {
            // sum if many single-digit per-row marks; otherwise take biggest plausible
            const sumNums = nums.reduce((s,n) => s + n, 0);
            count = Math.max(count, sumNums);
          }
        }

        if (count === 0) continue;

        const year = d.year || guessedYear;
        const monthStr = String(d.month).padStart(2,'0');
        const dayStr = String(d.day).padStart(2,'0');
        const fullDate = `${year}-${monthStr}-${dayStr}`;

        const calEntry = calendar.find(c => c.date === fullDate);
        const finalGroup = calEntry ? groups.find(g => g.id === calEntry.groupId) : group;
        const time = calEntry?.time || '09:00';

        sessionsFound.push({ date: fullDate, time, people: count, group: finalGroup || group });
      }

      if (sessionsFound.length === 0) { showToast('–í –¥–æ–∫—É–º–µ–Ω—Ç–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π —Å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å—é', 'error'); return null; }

      return { sessions: sessionsFound, detectedGroupCode: code, guessedYear };
    }

    // -------------------------------
    // Preview (safe DOM build) + confirmImport with duplicate detection + undo
    // -------------------------------
    function showPreview(data) {
      openModal('uploadModal'); // keep modal open to show preview inside uploadContent
      const container = document.getElementById('uploadContent');
      container.innerHTML = ''; // clear
      const { sessions: parsed } = data;
      const totalPeople = parsed.reduce((s, x) => s + x.people, 0);
      const totalIncome = totalPeople * GRANT_PER_PERSON;

      // Info box
      const info = document.createElement('div');
      info.className = 'info-box';
      const infoTitle = document.createElement('div');
      infoTitle.className = 'info-title';
      infoTitle.textContent = '‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ!';
      info.appendChild(infoTitle);
      container.appendChild(info);

      // Summary section
      const summary = document.createElement('div');
      summary.className = 'preview-section';
      const st = document.createElement('div');
      st.className = 'preview-title';
      st.textContent = 'üìä –î–∞–Ω–Ω—ã–µ';
      summary.appendChild(st);
      const s1 = document.createElement('div');
      s1.className = 'preview-item';
      s1.innerHTML = `<strong>–ó–∞–Ω—è—Ç–∏–π:</strong> ${parsed.length}`;
      summary.appendChild(s1);
      const s2 = document.createElement('div');
      s2.className = 'preview-item';
      s2.innerHTML = `<strong>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> <span style="font-size:20px; color:#4ade80; font-weight:bold;">${totalPeople}</span>`;
      summary.appendChild(s2);
      const s3 = document.createElement('div');
      s3.className = 'preview-item';
      s3.innerHTML = `<strong>–ì—Ä–∞–Ω—Ç:</strong> <span class="green">${formatNumber(totalIncome)}‚ÇΩ</span>`;
      summary.appendChild(s3);
      container.appendChild(summary);

      // By-dates
      const datesSection = document.createElement('div');
      datesSection.className = 'preview-section';
      datesSection.style.maxHeight = '250px';
      datesSection.style.overflowY = 'auto';
      const dt = document.createElement('div');
      dt.className = 'preview-title';
      dt.textContent = 'üìÖ –ü–æ –¥–∞—Ç–∞–º';
      datesSection.appendChild(dt);
      parsed.forEach(s => {
        const block = document.createElement('div');
        block.style.padding = '6px';
        block.style.background = '#1e293b';
        block.style.borderRadius = '4px';
        block.style.marginBottom = '3px';
        block.style.fontSize = '12px';
        block.innerHTML = `<strong>${escapeHtml(s.date)}</strong> ${escapeHtml(s.time)} ‚Ä¢ ${escapeHtml(s.group.name)} ‚Ä¢ <span style="color:#4ade80; font-weight:bold;">${s.people} —á–µ–ª.</span>`;
        datesSection.appendChild(block);
      });
      container.appendChild(datesSection);

      // By teacher
      const byTeacher = {};
      parsed.forEach(s => {
        const t = s.group.teacher;
        if (!byTeacher[t]) byTeacher[t] = { teacher: t, sessions: [], income: 0, salary: 0 };
        byTeacher[t].sessions.push(s);
        const inc = s.people * GRANT_PER_PERSON;
        byTeacher[t].income += inc;
        if (s.group.salaryType === 'fixed') {
          byTeacher[t].salary += s.group.salaryValue;
        } else {
          byTeacher[t].salary += Math.round((inc * s.group.salaryValue) / 100);
        }
      });

      Object.values(byTeacher).forEach(t => {
        const sect = document.createElement('div');
        sect.className = 'preview-section';
        const title = document.createElement('div');
        title.className = 'preview-title';
        title.textContent = `üë§ ${t.teacher}`;
        sect.appendChild(title);
        const it1 = document.createElement('div'); it1.className = 'preview-item'; it1.innerHTML = `<strong>–ó–∞–Ω—è—Ç–∏–π:</strong> ${t.sessions.length}`; sect.appendChild(it1);
        const it2 = document.createElement('div'); it2.className = 'preview-item'; it2.innerHTML = `<strong>–õ—é–¥–µ–π:</strong> ${t.sessions.reduce((s,x)=>s+x.people,0)}`; sect.appendChild(it2);
        const it3 = document.createElement('div'); it3.className = 'preview-item'; it3.innerHTML = `<strong>–ì—Ä–∞–Ω—Ç:</strong> <span class="green">${formatNumber(t.income)}‚ÇΩ</span>`; sect.appendChild(it3);
        const it4 = document.createElement('div'); it4.className = 'preview-item'; it4.innerHTML = `<strong>–ó–∞—Ä–ø–ª–∞—Ç–∞:</strong> <span class="yellow">${formatNumber(t.salary)}‚ÇΩ</span>`; sect.appendChild(it4);
        container.appendChild(sect);
      });

      // Actions: Cancel, Add (with duplicates handling)
      const actions = document.createElement('div');
      actions.className = 'form-actions';
      actions.style.marginTop = '12px';
      actions.style.marginBottom = '6px';
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn secondary';
      cancelBtn.textContent = '–û—Ç–º–µ–Ω–∞';
      cancelBtn.onclick = () => closeModal('uploadModal');
      const addBtn = document.createElement('button');
      addBtn.className = 'btn success';
      addBtn.textContent = '‚úÖ –î–æ–±–∞–≤–∏—Ç—å';
      addBtn.onclick = () => confirmImport({ sessions: parsed });
      actions.appendChild(cancelBtn);
      actions.appendChild(addBtn);
      container.appendChild(actions);
    }

    function confirmImport(data) {
      // check duplicates by date + groupId
      const toAdd = [];
      const duplicates = [];
      data.sessions.forEach(s => {
        const exists = sessions.find(x => x.date === s.date && x.groupId === s.group.id);
        if (exists) duplicates.push(s);
        else toAdd.push(s);
      });

      if (toAdd.length === 0) {
        showToast('–ù–µ—á–µ–≥–æ –¥–æ–±–∞–≤–ª—è—Ç—å ‚Äî –≤—Å–µ –∑–∞–Ω—è—Ç–∏—è —É–∂–µ –µ—Å—Ç—å', 'error');
        return;
      }

      let addOnlyNew = true;
      if (duplicates.length > 0) {
        // ask user: add all (overwrite?) or add only new
        addOnlyNew = confirm(`${toAdd.length} –Ω–æ–≤—ã—Ö, ${duplicates.length} –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π –Ω–∞–π–¥–µ–Ω—ã.\n\n–ù–∞–∂–º–∏—Ç–µ OK —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ; –û—Ç–º–µ–Ω–∞ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–µ (–≤–∫–ª—é—á–∞—è –¥—É–±–ª–∏).`);
      }

      const actuallyToAdd = addOnlyNew ? toAdd : data.sessions;
      const addedIds = [];
      actuallyToAdd.forEach(s => {
        const id = generateId();
        sessions.push({
          id,
          groupId: s.group.id,
          date: s.date,
          time: s.time,
          people: s.people,
          teacher: s.group.teacher
        });
        addedIds.push(id);
      });
      saveData();
      closeModal('uploadModal');
      updateDisplay();
      lastImport = addedIds;
      // store last import for undo
      localStorage.setItem('lastImport', JSON.stringify(addedIds));
      const undoNode = showToast(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${actuallyToAdd.length} –∑–∞–Ω—è—Ç–∏–π`, 'success', [
        { label: '–û—Ç–º–µ–Ω–∏—Ç—å', onClick: undoLastImport }
      ], 10000);
    }

    function undoLastImport() {
      const ids = JSON.parse(localStorage.getItem('lastImport') || '[]');
      if (!ids || ids.length === 0) { showToast('–ù–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã', 'error'); return; }
      sessions = sessions.filter(s => !ids.includes(s.id));
      saveData();
      localStorage.removeItem('lastImport');
      updateDisplay();
      showToast('–ò–º–ø–æ—Ä—Ç –æ—Ç–º–µ–Ω—ë–Ω');
    }

    // -------------------------------
    // Rendering stats & table
    // -------------------------------
    function formatNumber(num) {
      return Number(num).toLocaleString('ru-RU');
    }

    function renderStats() {
      const totalSessions = sessions.length;
      const totalPeople = sessions.reduce((s,x)=>s+x.people,0);
      const totalIncome = totalPeople * GRANT_PER_PERSON;
      let totalSalary = 0;
      let totalHallCost = 0;

      sessions.forEach(s => {
        const g = groups.find(x => x.id === s.groupId);
        if (!g) return;
        const inc = s.people * GRANT_PER_PERSON;
        if (g.salaryType === 'fixed') totalSalary += g.salaryValue;
        else totalSalary += Math.round((inc * g.salaryValue) / 100);
        totalHallCost += g.hallCost || 0;
      });
      expenses.forEach(e => totalHallCost += e.amount || 0);

      const totalProfit = totalIncome - totalSalary - totalHallCost;
      const teachers = new Set(sessions.map(s=>s.teacher)).size;

      const container = document.getElementById('statsContainer');
      container.innerHTML = `
        <div class="stat-card"><div class="stat-label">–ü–µ–¥–∞–≥–æ–≥–æ–≤</div><div class="stat-value">${teachers}</div></div>
        <div class="stat-card purple"><div class="stat-label">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div><div class="stat-value">${totalPeople}</div><div class="stat-change">${totalSessions} –∑–∞–Ω—è—Ç–∏–π</div></div>
        <div class="stat-card green"><div class="stat-label">–ì—Ä–∞–Ω—Ç</div><div class="stat-value">${formatNumber(totalIncome)}‚ÇΩ</div></div>
        <div class="stat-card yellow"><div class="stat-label">–ó–∞—Ä–ø–ª–∞—Ç—ã</div><div class="stat-value">${formatNumber(totalSalary)}‚ÇΩ</div></div>
        <div class="stat-card red"><div class="stat-label">–ê—Ä–µ–Ω–¥–∞</div><div class="stat-value">${formatNumber(totalHallCost)}‚ÇΩ</div><div class="stat-change">${expenses.length > 0 ? '+ —Ä–∞—Å—Ö–æ–¥—ã' : ''}</div></div>
        <div class="stat-card" style="background:linear-gradient(135deg,#0e7490,#0891b2);"><div class="stat-label">–ü—Ä–∏–±—ã–ª—å</div><div class="stat-value">${formatNumber(totalProfit)}‚ÇΩ</div></div>
      `;
    }

    function renderTable() {
      const byTeacher = {};
      sessions.forEach(s => {
        const t = s.teacher;
        if (!byTeacher[t]) byTeacher[t] = { teacher: t, groups: new Set(), sessions: 0, people: 0, income: 0, salary: 0, hallCost: 0 };
        byTeacher[t].groups.add(s.groupId);
        byTeacher[t].sessions++;
        byTeacher[t].people += s.people;
        const g = groups.find(x => x.id === s.groupId);
        if (g) {
          const inc = s.people * GRANT_PER_PERSON;
          byTeacher[t].income += inc;
          if (g.salaryType === 'fixed') byTeacher[t].salary += g.salaryValue;
          else byTeacher[t].salary += Math.round((inc * g.salaryValue) / 100);
          byTeacher[t].hallCost += g.hallCost || 0;
        }
      });

      const teacherData = Object.values(byTeacher).map(t => ({
        ...t,
        groups: t.groups.size,
        profit: t.income - t.salary - t.hallCost
      }));

      const tbody = document.getElementById('tableBody');
      const tfoot = document.getElementById('tableFoot');

      if (teacherData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#94a3b8; padding:30px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        tfoot.innerHTML = '';
        return;
      }

      tbody.innerHTML = teacherData.map(t => `
        <tr>
          <td style="font-weight:bold;">${escapeHtml(t.teacher)}</td>
          <td class="text-center">${t.sessions}</td>
          <td class="text-center"><span class="badge" style="background:#7c3aed;">${t.people}</span></td>
          <td class="text-right"><span class="amount green">${formatNumber(t.income)}‚ÇΩ</span></td>
          <td class="text-right"><span class="amount yellow">${formatNumber(t.salary)}‚ÇΩ</span></td>
          <td class="text-right"><span class="amount red">${formatNumber(t.hallCost)}‚ÇΩ</span></td>
          <td class="text-right"><span class="amount blue">${formatNumber(t.profit)}‚ÇΩ</span></td>
        </tr>
      `).join('');

      const totals = {
        sessions: sessions.length,
        people: sessions.reduce((s,x)=>s+x.people,0),
        income: teacherData.reduce((s,t)=>s+t.income,0),
        salary: teacherData.reduce((s,t)=>s+t.salary,0),
        hallCost: teacherData.reduce((s,t)=>s+t.hallCost,0) + expenses.reduce((s,e)=>s+e.amount,0),
        profit: teacherData.reduce((s,t)=>s+t.profit,0) - expenses.reduce((s,e)=>s+e.amount,0)
      };

      tfoot.innerHTML = `
        <tr>
          <td>–ò–¢–û–ì–û:</td>
          <td class="text-center">${totals.sessions}</td>
          <td class="text-center purple">${totals.people}</td>
          <td class="text-right green">${formatNumber(totals.income)}‚ÇΩ</td>
          <td class="text-right yellow">${formatNumber(totals.salary)}‚ÇΩ</td>
          <td class="text-right red">${formatNumber(totals.hallCost)}‚ÇΩ</td>
          <td class="text-right blue">${formatNumber(totals.profit)}‚ÇΩ</td>
        </tr>
      `;
    }

    function updateDisplay() {
      renderStats();
      renderTable();
    }

    // -------------------------------
    // Export / Import data (JSON)
    // -------------------------------
    document.getElementById('exportBtn').addEventListener('click', () => {
      const data = { groups, calendar, sessions, expenses };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'md_salaries_backup.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast('–≠–∫—Å–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω');
    });

    // -------------------------------
    // Init & event wiring
    // -------------------------------
    document.getElementById('openCalendarBtn').addEventListener('click', () => { renderCalendar(); openModal('calendarModal'); });
    document.getElementById('openGroupsBtn').addEventListener('click', () => { renderGroupsList(); openModal('groupsModal'); });
    document.getElementById('addGroupBtn').addEventListener('click', showAddGroupForm);
    document.getElementById('openExpenseBtn').addEventListener('click', showAddExpenseModal);

    // Close buttons wired by attribute data-close
    document.querySelectorAll('.close-btn').forEach(b => {
      b.addEventListener('click', (e) => {
        const parent = e.target.closest('.modal');
        if (parent && parent.id) parent.classList.remove('active');
      });
    });

    // initial load
    loadData();
  </script>
</body>
</html>
