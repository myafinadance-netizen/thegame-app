<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TheGame ‚Äî –£—á—ë—Ç + –ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤</title>

  <!-- Telegram -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;
const tg = window.Telegram?.WebApp;

/* helpers */
const fmt = n => new Intl.NumberFormat('ru-RU').format(Number(n||0));

const calcTeacherExpense = (income, rate) => {
  if (rate === '50%') return Math.round(income * 0.5);
  if (rate === '700') return 700;
  if (rate === '1000') return 1000;
  if (rate === '100%') return income;
  const n = Number(rate);
  return isNaN(n) ? 0 : n;
};

const loadKey = async (key, fallback) => {
  if (tg?.CloudStorage) {
    return await new Promise(res => {
      tg.CloudStorage.getItem(key, (_, v) => {
        try { res(v ? JSON.parse(v) : fallback); }
        catch { res(fallback); }
      });
    });
  }
  const raw = localStorage.getItem(key);
  return raw ? JSON.parse(raw) : fallback;
};

const saveKey = (key, data) => {
  const v = JSON.stringify(data);
  tg?.CloudStorage?.setItem(key, v);
  localStorage.setItem(key, v);
};

function App() {
  const [tab, setTab] = useState('dolgo');
  const [dolgo, setDolgo] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    (async () => {
      setDolgo(await loadKey('dolgo', []));
      setLoading(false);
      tg?.expand();
    })();
  }, []);

  useEffect(() => {
    if (!loading) saveKey('dolgo', dolgo);
  }, [dolgo]);

  /* ===== –ó–ê–†–ü–õ–ê–¢–´ –ü–ï–î–ê–ì–û–ì–û–í ===== */
  const teachersMap = {};
  dolgo.forEach(r => {
    const income = r.people * 280;
    const salary = calcTeacherExpense(income, r.rate);
    const hall = Number(r.hall||0);
    const profit = income - salary - hall;

    if (!teachersMap[r.teacher]) {
      teachersMap[r.teacher] = {
        teacher: r.teacher,
        location: r.location,
        days: new Set(),
        lessons: 0,
        income: 0,
        salary: 0,
        hall: 0,
        profit: 0
      };
    }
    const t = teachersMap[r.teacher];
    t.days.add(r.date);
    t.lessons++;
    t.income += income;
    t.salary += salary;
    t.hall += hall;
    t.profit += profit;
  });

  const teachers = Object.values(teachersMap).map(t => ({
    ...t,
    days: t.days.size,
    rent: t.income ? Math.round(t.profit / t.income * 100) : 0
  }));

  if (loading) return <div className="p-6">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>;

  return (
    <div className="p-4 max-w-6xl mx-auto">
      <h1 className="text-2xl font-bold mb-4">üí∞ –£—á—ë—Ç –¥–æ—Ö–æ–¥–æ–≤</h1>

      <div className="flex gap-2 mb-4">
        <button onClick={()=>setTab('dolgo')} className={`px-3 py-1 rounded ${tab==='dolgo'?'bg-blue-600':'bg-slate-700'}`}>–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ</button>
        <button onClick={()=>setTab('teachers')} className={`px-3 py-1 rounded ${tab==='teachers'?'bg-blue-600':'bg-slate-700'}`}>–ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤</button>
      </div>

      {/* –î–û–õ–ì–û–õ–ï–¢–ò–ï */}
      {tab==='dolgo' && (
        <table className="w-full text-sm">
          <thead className="border-b border-slate-700 text-slate-300">
            <tr>
              <th>–î–∞—Ç–∞</th><th>–õ–æ–∫–∞—Ü–∏—è</th><th>–ü–µ–¥–∞–≥–æ–≥</th>
              <th>–°—Ç–∞–≤–∫–∞</th><th>–õ—é–¥–µ–π</th><th className="text-right">–î–æ—Ö–æ–¥</th>
            </tr>
          </thead>
          <tbody>
            {dolgo.map((r,i)=>(
              <tr key={i} className="border-b border-slate-700/40">
                <td>{r.date}</td>
                <td>{r.location}</td>
                <td>{r.teacher}</td>
                <td>{r.rate}</td>
                <td>{r.people}</td>
                <td className="text-right text-green-400">{fmt(r.people*280)}‚ÇΩ</td>
              </tr>
            ))}
          </tbody>
        </table>
      )}

      {/* –ó–ê–†–ü–õ–ê–¢–´ */}
      {tab==='teachers' && (
        <table className="w-full text-sm">
          <thead className="border-b border-slate-700 text-slate-300">
            <tr>
              <th>–ü–µ–¥–∞–≥–æ–≥</th>
              <th className="text-center">–î–Ω–µ–π</th>
              <th className="text-center">–ó–∞–Ω—è—Ç–∏–π</th>
              <th className="text-right">–î–æ—Ö–æ–¥</th>
              <th className="text-right">–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
              <th className="text-right">–ó–∞–ª</th>
              <th className="text-right">–ü—Ä–∏–±—ã–ª—å</th>
              <th className="text-center">%</th>
            </tr>
          </thead>
          <tbody>
            {teachers.map((t,i)=>(
              <tr key={i} className="border-b border-slate-700/40">
                <td>
                  <b>{t.teacher}</b>
                  <div className="text-xs text-slate-400">üìç {t.location}</div>
                </td>
                <td className="text-center">{t.days}</td>
                <td className="text-center">{t.lessons}</td>
                <td className="text-right text-green-400">{fmt(t.income)}‚ÇΩ</td>
                <td className="text-right text-yellow-400">{fmt(t.salary)}‚ÇΩ</td>
                <td className="text-right text-red-400">{fmt(t.hall)}‚ÇΩ</td>
                <td className="text-right text-blue-400 font-bold">{fmt(t.profit)}‚ÇΩ</td>
                <td className="text-center font-bold">{t.rent}%</td>
              </tr>
            ))}
          </tbody>
        </table>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html
