<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TheGame ‚Äî –ï–¥–∏–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- React + Tailwind -->
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* minimal overrides to keep tidy mobile spacing */
    html,body,#root { height: 100%; }
    body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    /* small helper for message avatars */
    .avatar { width: 36px; height: 36px; border-radius: 999px; display:inline-flex; align-items:center; justify-content:center; font-size:18px; }
    /* hide outline on buttons when tapped in Telegram mobile */
    button:focus { outline: none; }
  </style>
</head>
<body class="bg-slate-900 text-white">
  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useRef } = React;
  const tg = window.Telegram?.WebApp;

  // Simple Cloud/local storage helpers (compatible with earlier code)
  const loadKey = async (key, fallback) => {
    try {
      if (tg?.CloudStorage && tg.CloudStorage.getItem) {
        return await new Promise((resolve) => {
          tg.CloudStorage.getItem(key, (err, val) => {
            if (!err && val) {
              try { resolve(JSON.parse(val)); } catch { resolve(fallback); }
            } else resolve(fallback);
          });
        });
      } else {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      }
    } catch {
      return fallback;
    }
  };

  const saveKey = async (key, data) => {
    try {
      const val = JSON.stringify(data);
      if (tg?.CloudStorage && tg.CloudStorage.setItem) tg.CloudStorage.setItem(key, val);
      localStorage.setItem(key, val);
    } catch (e) {
      console.error('saveKey error', e);
    }
  };

  function App() {
    const [activeTab, setActiveTab] = useState('monthlyReport');
    const [loading, setLoading] = useState(true);

    // finance states from the second file
    const [dolgo, setDolgo] = useState([]);
    const [individuals, setIndividuals] = useState([]);
    const [rentals, setRentals] = useState([]);
    const [expenses, setExpenses] = useState([]);
    const [passive, setPassive] = useState([]);
    const [students, setStudents] = useState([]);
    const [monthlyArchive, setMonthlyArchive] = useState([]);

    // teachers + chat (from first file)
    const defaultTeachers = [
      {name:"–û–ª—å–≥–∞", direction:"–•–æ—Ä–µ–æ–≥—Ä–∞—Ñ–∏—è", students:10, limit:25, status:"critical"},
      {name:"–•–µ–ª–µ–Ω–∞", direction:"–§–ª–∞–º–µ–Ω–∫–æ", students:15, limit:25, status:"warning"},
      {name:"–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞", direction:"–°—Ç–∞–Ω–¥–∞—Ä—Ç", students:22, limit:25, status:"good"},
      {name:"–õ–∏–∑–∞", direction:"–õ–∞—Ç–∏–Ω–∞", students:20, limit:25, status:"good"}
    ];
    const [teachers, setTeachers] = useState([]);
    const [chatMessages, setChatMessages] = useState([
      {who:'bot', text:'–ü—Ä–∏–≤–µ—Ç! –û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–µ–¥–∞–≥–æ–≥–∞.', time: new Date().toISOString()}
    ]);

    // modal and form states reused from second file pattern (kept minimal)
    const [showModal, setShowModal] = useState(false);
    const [modalType, setModalType] = useState(null);
    const [editingIndex, setEditingIndex] = useState(null);
    const [form, setForm] = useState({});

    const locationDefaults = { "–ë—É–¥–µ–Ω–Ω–æ–≥–æ":0, "–ß–µ—Ä–∫–∏–∑–æ–≤—Å–∫–∞—è":0, "–ü–∞—Ä–∫":0 };

    // load all data on mount
    useEffect(()=>{
      (async ()=>{
        const [
          _dolgo, _ind, _rent, _exp, _pass, _stud, _arch, _teachers, _chat
        ] = await Promise.all([
          loadKey('dolgo', []),
          loadKey('individuals', []),
          loadKey('rentals', []),
          loadKey('expenses', []),
          loadKey('passive', []),
          loadKey('students', []),
          loadKey('monthlyArchive', []),
          loadKey('teachers', defaultTeachers),
          loadKey('chatMessages', [
            {who:'bot', text:'–ü—Ä–∏–≤–µ—Ç! –û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–µ–¥–∞–≥–æ–≥–∞.', time: new Date().toISOString()}
          ])
        ]);
        setDolgo(_dolgo);
        setIndividuals(_ind);
        setRentals(_rent);
        setExpenses(_exp);
        setPassive(_pass);
        setStudents(_stud);
        setMonthlyArchive(_arch);
        setTeachers(_teachers);
        setChatMessages(_chat);
        setLoading(false);
        try { tg?.expand && tg.expand(); } catch {}
      })();
    },[]);

    // autosave for major datasets
    useEffect(()=>{ if(!loading) saveKey('dolgo', dolgo); }, [dolgo]);
    useEffect(()=>{ if(!loading) saveKey('individuals', individuals); }, [individuals]);
    useEffect(()=>{ if(!loading) saveKey('rentals', rentals); }, [rentals]);
    useEffect(()=>{ if(!loading) saveKey('expenses', expenses); }, [expenses]);
    useEffect(()=>{ if(!loading) saveKey('passive', passive); }, [passive]);
    useEffect(()=>{ if(!loading) saveKey('students', students); }, [students]);
    useEffect(()=>{ if(!loading) saveKey('monthlyArchive', monthlyArchive); }, [monthlyArchive]);
    useEffect(()=>{ if(!loading) saveKey('teachers', teachers); }, [teachers]);
    useEffect(()=>{ if(!loading) saveKey('chatMessages', chatMessages); }, [chatMessages]);

    // helper format
    const fmt = (n) => new Intl.NumberFormat('ru-RU').format(Number(n || 0));

    // calc helpers from second file
    const calcTeacherExpense = (income, rate) => {
      if (!rate) return 0;
      if (rate === '50%') return Math.round(income * 0.5);
      if (rate === '700') return 700;
      if (rate === '1000') return 1000;
      if (rate === '100%') return Math.round(income * 1.0);
      const parsed = parseFloat(rate);
      return Number.isFinite(parsed) ? parsed : 0;
    };

    // totals
    const totalDolgoIncome = dolgo.reduce((s,r)=> s + (Number(r.income)||0), 0);
    const totalDolgoTeacherExpense = dolgo.reduce((s,r)=> s + calcTeacherExpense(Number(r.income)||0, r.rate), 0);
    const totalDolgoHallExpense = dolgo.reduce((s,r)=> s + (Number(r.hallExpense)||0), 0);
    const totalDolgoProfit = totalDolgoIncome - totalDolgoTeacherExpense - totalDolgoHallExpense;

    const totalIndividualIncome = individuals.reduce((s,r)=> s + (Number(r.amount)||0), 0);
    const totalRentalsIncome = rentals.reduce((s,r)=> s + (Number(r.amount)||0), 0);
    const totalPassiveIncome = passive.reduce((s,r)=> s + (Number(r.monthly)||0), 0);
    const totalExpenses = expenses.reduce((s,r)=> s + (Number(r.amount)||0), 0);

    const monthlyReport = [
      { category: '–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ', income: totalDolgoIncome, expense: totalDolgoTeacherExpense + totalDolgoHallExpense, profit: totalDolgoProfit },
      { category: '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —É—Ä–æ–∫–∏', income: totalIndividualIncome, expense: 0, profit: totalIndividualIncome },
      { category: '–ê—Ä–µ–Ω–¥–∞ –∑–∞–ª–∞', income: totalRentalsIncome, expense: 0, profit: totalRentalsIncome },
      { category: '–ü–∞—Å—Å–∏–≤–Ω—ã–π', income: totalPassiveIncome, expense: 0, profit: totalPassiveIncome },
      { category: '–†–∞—Å—Ö–æ–¥—ã', income: 0, expense: totalExpenses, profit: -totalExpenses },
    ];
    const totalReportIncome = monthlyReport.reduce((s,r)=> s + (r.income||0), 0);
    const totalReportExpense = monthlyReport.reduce((s,r)=> s + (r.expense||0), 0);
    const totalReportProfit = monthlyReport.reduce((s,r)=> s + (r.profit||0), 0);

    const baseStart = 385000;
    const currentTotal = baseStart + (totalReportProfit);
    const goal = 1000000;
    const progressPercent = Math.round((currentTotal / goal) * 100);

    // simple teacher functions (based on first file)
    const toggleAddTeacherUI = () => {
      setShowModal(true);
      setModalType('addTeacher');
      setEditingIndex(null);
      setForm({});
    };

    const saveTeacher = () => {
      const name = form.name?.trim();
      const direction = form.direction?.trim();
      const studentsCount = Number(form.students||0);
      const limit = Number(form.limit||25);
      if (!name || !direction) {
        if (tg) tg.showAlert && tg.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ');
        return;
      }
      const loadPercent = studentsCount / (limit || 1);
      const status = loadPercent < 0.5 ? 'critical' : loadPercent < 0.75 ? 'warning' : 'good';
      const newTeacher = { name, direction, students: studentsCount, limit, status };
      if (editingIndex !== null) {
        const copy = [...teachers]; copy[editingIndex] = newTeacher; setTeachers(copy);
      } else {
        setTeachers([...teachers, newTeacher]);
      }
      setShowModal(false); setForm({}); setModalType(null); setEditingIndex(null);
    };

    const deleteTeacher = (idx) => {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–µ–¥–∞–≥–æ–≥–∞?')) return;
      setTeachers(teachers.filter((_,i)=>i!==idx));
    };

    // chat logic (adapted from first file)
    const teacherNamesLower = () => teachers.map(t => t.name.toLowerCase());

    const analyzeMessage = (text) => {
      const lowerText = text.toLowerCase();
      const teacherList = teacherNamesLower();
      const foundTeach = teacherList.find(name => lowerText.includes(name));
      // simple heuristics
      if (lowerText.includes('–Ω–µ –º–æ–≥—É') || lowerText.includes('–Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è') || lowerText.includes('—Å–ª–æ–∂–Ω–æ')) {
        return generateExcuseResponse(foundTeach);
      } else if (lowerText.includes('–ø–æ–≤—ã—à–µ–Ω–∏–µ') || lowerText.includes('–º–æ–∂–Ω–æ') || lowerText.includes('—Ö–æ—á—É')) {
        return generateRequestResponse(foundTeach);
      } else if (lowerText.includes('–Ω–∞–±—Ä–∞–ª') || lowerText.includes('–ø—Ä–∏—à–ª–æ') || lowerText.includes('–Ω–æ–≤—ã—Ö')) {
        return generateReportResponse(foundTeach);
      } else {
        return generateGeneralResponse(foundTeach);
      }
    };

    // responses (small safe HTML fragments)
    const sanitize = (s) => s; // trust internal strings ‚Äî kept minimal; escape if needed later
    const generateExcuseResponse = (teacher) => {
      return [
        { title: '‚ö†Ô∏è –ê–ù–ê–õ–ò–ó: –û—Ç–≥–æ–≤–æ—Ä–∫–∏/—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ', text: '–ü–µ–¥–∞–≥–æ–≥ –Ω–µ –±–µ—Ä—ë—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.' },
        { title: 'üí¨ –í–ê–†–ò–ê–ù–¢ –û–¢–í–ï–¢–û–í', variants: [
          {title:'üí™ –ñ—ë—Å—Ç–∫–∏–π –ø–æ–¥—Ö–æ–¥', text: '"–ü–æ–Ω–∏–º–∞—é, —á—Ç–æ —Å–ª–æ–∂–Ω–æ. –ù–æ —É –Ω–∞—Å –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω—É–∂–µ–Ω. –ß—Ç–æ –ö–û–ù–ö–†–ï–¢–ù–û —Ç—ã —Å–¥–µ–ª–∞–µ—à—å –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ? –ù—É–∂–µ–Ω –ø–ª–∞–Ω —Å —Ü–∏—Ñ—Ä–∞–º–∏ –¥–æ –∑–∞–≤—Ç—Ä–∞."'},
          {title:'ü§ù –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–π', text: '"–°–ª—ã—à—É —Ç–µ–±—è. –î–∞–≤–∞–π –ø–æ–¥—É–º–∞–µ–º –≤–º–µ—Å—Ç–µ: —á—Ç–æ –∏–∑ –Ω–∞–±–æ—Ä–∞ –ø—Ä–æ–±–æ–≤–∞–ª–∞? –ì–¥–µ –∑–∞—Å—Ç—Ä—è–ª–∞? –ö–∞–∫–∞—è –ø–æ–º–æ—â—å –Ω—É–∂–Ω–∞? –Ø –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å —Ä–µ–∫–ª–∞–º–æ–π."'},
          {title:'üìä –ß–µ—Ä–µ–∑ —Ü–∏—Ñ—Ä—ã', text: '"–ü–æ—Å—á–∏—Ç–∞–µ–º: —Å–µ–π—á–∞—Å X —á–µ–ª–æ–≤–µ–∫, –Ω—É–∂–Ω–æ Y. –≠—Ç–æ +Z —É—á–µ–Ω–∏–∫–æ–≤. –†–µ–∞–ª—å–Ω–æ –∑–∞ 2 –º–µ—Å—è—Ü–∞. –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ?"'}
        ]},
        { title:'‚úÖ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò', list: ['–ù–∞–∑–Ω–∞—á–∏—Ç—å 1-–Ω–∞-1', '–î–∞—Ç—å –¥–µ–¥–ª–∞–π–Ω: –ø–ª–∞–Ω –Ω–∞–±–æ—Ä–∞ –¥–æ [–¥–∞—Ç–∞]', '–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–º–æ—â—å —Å —Ä–µ–∫–ª–∞–º–æ–π', '–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å KPI'] }
      ];
    };
    const generateRequestResponse = (teacher) => {
      return [
        { title:'ü§≤ –ê–ù–ê–õ–ò–ó: –ü—Ä–æ—Å—å–±–∞/–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ', text:'–ù—É–∂–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å –≤—ã–≥–æ–¥—É –¥–ª—è –±–∏–∑–Ω–µ—Å–∞.'},
        { title:'üí¨ –í–ê–†–ò–ê–ù–¢ –û–¢–í–ï–¢–û–í', variants:[
          {title:'‚úÖ –û–¥–æ–±—Ä–∏—Ç—å —Å —É—Å–ª–æ–≤–∏–µ–º', text:'"–•–æ—Ä–æ—à–∞—è –∏–¥–µ—è! –î–∞–≤–∞–π —Ç–∞–∫: —è [—á—Ç–æ –ø—Ä–æ—Å–∏—Ç], –µ—Å–ª–∏ —Ç—ã [–≤—Å—Ç—Ä–µ—á–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ]. –ù–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–≤—ã—à–µ–Ω–∏–µ –Ω–∞ 10% ‚Üí –µ—Å–ª–∏ –Ω–∞–±–µ—Ä—ë—à—å –≥—Ä—É–ø–ø—É –¥–æ 25 —á–µ–ª–æ–≤–µ–∫."'},
          {title:'ü§î –£—Ç–æ—á–Ω–∏—Ç—å', text:'"–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ. –î–∞–≤–∞–π –ø–æ—Å—á–∏—Ç–∞–µ–º: —Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç? –ö–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–∞—Å—Ç? –ö–æ–≥–¥–∞ –æ–∫—É–ø–∏—Ç—Å—è? –ï—Å–ª–∏ —Ü–∏—Ñ—Ä—ã —Å–æ–π–¥—É—Ç—Å—è ‚Äî –¥–µ–ª–∞–µ–º."'},
          {title:'‚ùå –û—Ç–∫–∞–∑–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ', text:'"–¶–µ–Ω—é –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É, –Ω–æ —Å–µ–π—á–∞—Å –Ω–µ –ª—É—á—à–∏–π –º–æ–º–µ–Ω—Ç. –ü—Ä–∏—á–∏–Ω–∞: [–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ]. –î–∞–≤–∞–π –≤–µ—Ä–Ω—ë–º—Å—è –∫ —ç—Ç–æ–º—É, –∫–æ–≥–¥–∞ [—É—Å–ª–æ–≤–∏–µ]."'}
        ]},
        { title:'‚úÖ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò', list: ['–ü–æ—Å—á–∏—Ç–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å—ã: —Å—Ç–æ–∏–º–æ—Å—Ç—å vs –≤—ã–≥–æ–¥–∞','–û—Ü–µ–Ω–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç','–°–≤—è–∑–∞—Ç—å —Å KPI –ø–µ–¥–∞–≥–æ–≥–∞','–î–∞—Ç—å –æ—Ç–≤–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤'] }
      ];
    };
    const generateReportResponse = (teacher) => {
      return [
        { title:'üìä –ê–ù–ê–õ–ò–ó: –û—Ç—á—ë—Ç –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö', text:'–£—Å–∏–ª–∏—Ç—å –º–æ—Ç–∏–≤–∞—Ü–∏—é –∏ –¥–∞—Ç—å –Ω–æ–≤–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.'},
        { title:'üí¨ –í–ê–†–ò–ê–ù–¢ –û–¢–í–ï–¢–û–í', variants:[
          {title:'üéâ –ü–æ—Ö–≤–∞–ª–∏—Ç—å + –Ω–æ–≤–∞—è —Ü–µ–ª—å', text:'"–û—Ç–ª–∏—á–Ω–æ! –≠—Ç–æ —Ä–æ—Å—Ç! –¢–µ–ø–µ—Ä—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –∑–∞ 2 –Ω–µ–¥–µ–ª–∏ –¥–æ–±–µ—Ä—ë–º –µ—â—ë +5. –£–≤–µ—Ä–µ–Ω, –ø–æ–ª—É—á–∏—Ç—Å—è! üî•"'},
          {title:'üìà –£—Å–∏–ª–∏—Ç—å –∏–º–ø—É–ª—å—Å', text:'"–ö—Ä—É—Ç–æ! –í–∏–¥–∏—à—å, —Ä–∞–±–æ—Ç–∞–µ—Ç? üí™ –ï—Å–ª–∏ —Ç–∞–∫ –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é, —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü –±—É–¥–µ—Ç –ø–æ–ª–Ω–∞—è –≥—Ä—É–ø–ø–∞. –ß—Ç–æ –µ—â—ë –ø–æ–ø—Ä–æ–±—É–µ–º?"'},
          {title:'üî• –í—ã–∑–æ–≤', text:'"–•–æ—Ä–æ—à–∏–π —Å—Ç–∞—Ä—Ç! –ê –¥–∞–≤–∞–π —É—Å–∏–ª–∏–º: –¥–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞ –¥–æ–±–µ—Ä—ë–º –¥–æ 25 —á–µ–ª–æ–≤–µ–∫. –ì–æ—Ç–æ–≤(–∞) –ø–æ–±–∏—Ç—å —Å–≤–æ–π —Ä–µ–∫–æ—Ä–¥? üéØ"'}
        ]},
        { title:'‚úÖ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò', list: ['–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —É—Å–ø–µ—Ö –≤ –æ–±—â–µ–º —á–∞—Ç–µ','–ï—Å–ª–∏ –µ—Å—Ç—å –±–æ–Ω—É—Å—ã ‚Äî –Ω–∞—á–∏—Å–ª–∏—Ç—å','–ü–æ—Å—Ç–∞–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â—É—é —Ü–µ–ª—å','–ü–æ–ø—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π'] }
      ];
    };
    const generateGeneralResponse = (teacher) => {
      return [{ title:'üìù –û–ë–©–ê–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø', text:'–£—Ç–æ—á–Ω–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ —Å–∏—Ç—É–∞—Ü–∏–∏ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.'},
              { title:'üí¨ –ë–ê–ó–û–í–´–ô –û–¢–í–ï–¢', text:'"–ü–æ–Ω—è–ª. –î–∞–≤–∞–π —Å–æ–∑–≤–æ–Ω–∏–º—Å—è —Å–µ–≥–æ–¥–Ω—è –≤ [–≤—Ä–µ–º—è] –∏ –æ–±—Å—É–¥–∏–º –¥–µ—Ç–∞–ª–∏? –ò–ª–∏ –Ω–∞–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ, —á—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –Ω—É–∂–Ω–æ."'}];
    };

    // send chat message (user) and auto-response
    const sendChatMessage = (text) => {
      if (!text || !text.trim()) return;
      const userMsg = { who:'user', text: text.trim(), time: new Date().toISOString() };
      setChatMessages(prev => [...prev, userMsg]);
      // auto response after short delay
      setTimeout(()=>{
        const respParts = analyzeMessage(text);
        // build a readable HTML/text from respParts
        let responseText = respParts.map(p=>{
          if (p.variants) {
            return p.variants.map(v => `${v.title}\n${v.text}`).join('\n\n');
          }
          if (p.list) return p.title + '\n' + p.list.map(l=>'‚Ä¢ '+l).join('\n');
          return (p.title ? p.title + '\n' : '') + (p.text || '');
        }).join('\n\n');
        const botMsg = { who:'bot', text: responseText, time: new Date().toISOString() };
        setChatMessages(prev => [...prev, botMsg]);
      }, 600);
    };

    // small exports
    const exportData = () => {
      const csv = 'Type,Amount,Category,Date\n' +
        [].concat(rentals.map(r=>['rental', r.amount, r.name, r.date].join(',')))
          .concat(individuals.map(i=>['individual', i.amount, i.type, i.date].join(',')))
          .join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'thegame_export.csv';
      a.click();
      URL.revokeObjectURL(url);
      if (tg) tg.showAlert && tg.showAlert('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
    };

    // modal save for finance items simplified (we reuse logic from second file but keep minimal here)
    const openModal = (type, idx=null) => {
      setModalType(type);
      setEditingIndex(idx);
      let data = {};
      if (idx !== null) {
        if (type === 'dolgo') data = {...dolgo[idx]};
        if (type === 'individual') data = {...individuals[idx]};
        if (type === 'rental') data = {...rentals[idx]};
        if (type === 'expense') data = {...expenses[idx]};
        if (type === 'passive') data = {...passive[idx]};
        if (type === 'student') data = {...students[idx]};
        if (type === 'archive') data = {...monthlyArchive[idx]};
      } else data = {};
      setForm(data);
      setShowModal(true);
    };

    const closeModal = () => { setShowModal(false); setModalType(null); setEditingIndex(null); setForm({}); };

    const saveModal = () => {
      // handle only a few modal types here; full logic from second file can be used if needed
      if (modalType === 'dolgo') {
        const people = Number(form.people || 0);
        const income = (people * 280) || Number(form.income || 0);
        const row = {
          date: form.date || '',
          location: form.location || '',
          teacher: form.teacher || '',
          rate: form.rate || '50%',
          people,
          income,
          hallExpense: Number(form.hallExpense || locationDefaults[form.location] || 0),
          comment: form.comment || ''
        };
        if (editingIndex !== null) { const copy=[...dolgo]; copy[editingIndex]=row; setDolgo(copy); } else setDolgo([...dolgo, row]);
      }
      if (modalType === 'individual') {
        const row = { date: form.date||'', type: form.type||'–û—Å—Ç–∞–ª—å–Ω—ã–µ', client: form.client||'', teacher: form.teacher||'', amount: Number(form.amount||0), comment: form.comment||'' };
        if (editingIndex !== null) { const copy=[...individuals]; copy[editingIndex]=row; setIndividuals(copy);} else setIndividuals([...individuals, row]);
      }
      if (modalType === 'expense') {
        const row = { date: form.date||'', type: form.type||'', what: form.what||'', amount: Number(form.amount||0), comment: form.comment||'' };
        if (editingIndex !== null) { const copy=[...expenses]; copy[editingIndex]=row; setExpenses(copy);} else setExpenses([...expenses, row]);
      }
      if (modalType === 'rental') {
        const row = { date: form.date||'', name: form.name||'', amount: Number(form.amount||0), comment: form.comment||'' };
        if (editingIndex !== null) { const copy=[...rentals]; copy[editingIndex]=row; setRentals(copy);} else setRentals([...rentals, row]);
      }
      if (modalType === 'passive') {
        const row = { date: form.date||'', source: form.source||'', monthly: Number(form.monthly||0), comment: form.comment||'' };
        if (editingIndex !== null) { const copy=[...passive]; copy[editingIndex]=row; setPassive(copy);} else setPassive([...passive, row]);
      }
      if (modalType === 'student') {
        const row = { name: form.name||'', phone: form.phone||'', group: form.group||'', subscription: form.subscription||'', expiry: form.expiry||'', status: form.status||'–ê–∫—Ç–∏–≤–Ω—ã–π', note: form.note||'' };
        if (editingIndex !== null) { const copy=[...students]; copy[editingIndex]=row; setStudents(copy);} else setStudents([...students, row]);
      }
      if (modalType === 'archive') {
        const groupIncome = Number(form.groupIncome||0);
        const individualIncome = Number(form.individualIncome||0);
        const passiveIncome = Number(form.passiveIncome||0);
        const expensesVal = Number(form.expenses||0);
        const profit = groupIncome + individualIncome + passiveIncome - expensesVal;
        const row = { month: form.month||'', year: form.year||'', groupIncome, individualIncome, passiveIncome, expenses: expensesVal, profit, note: form.note||'' };
        if (editingIndex !== null) { const copy=[...monthlyArchive]; copy[editingIndex]=row; setMonthlyArchive(copy);} else setMonthlyArchive([...monthlyArchive, row]);
      }
      closeModal();
    };

    const deleteItem = (type, idx) => {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
      if (type === 'dolgo') setDolgo(dolgo.filter((_,i)=>i!==idx));
      if (type === 'individual') setIndividuals(individuals.filter((_,i)=>i!==idx));
      if (type === 'rental') setRentals(rentals.filter((_,i)=>i!==idx));
      if (type === 'expense') setExpenses(expenses.filter((_,i)=>i!==idx));
      if (type === 'passive') setPassive(passive.filter((_,i)=>i!==idx));
      if (type === 'student') setStudents(students.filter((_,i)=>i!==idx));
      if (type === 'archive') setMonthlyArchive(monthlyArchive.filter((_,i)=>i!==idx));
    };

    if (loading) return <div className="min-h-screen flex items-center justify-center">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;

    // small UI components inline for compactness
    return (
      <div className="min-h-screen p-4">
        <div className="max-w-6xl mx-auto">
          <header className="mb-6">
            <div className="flex items-start justify-between">
              <div>
                <h1 className="text-2xl font-bold">üíº TheGame ‚Äî –ï–¥–∏–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
                <div className="text-sm text-slate-400">–î–∞—à–±–æ—Ä–¥ ‚Äî –£—á—ë—Ç ‚Äî –ü–µ–¥–∞–≥–æ–≥–∏ ‚Äî –ß–∞—Ç</div>
              </div>
              <div className="text-right">
                <div className="text-sm text-slate-400">–ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —Ü–µ–ª–∏</div>
                <div className="flex items-center gap-3">
                  <div className="w-56 bg-slate-700 h-4 rounded">
                    <div className="h-4 rounded bg-gradient-to-r from-blue-500 to-green-400" style={{width: `${Math.min(progressPercent,100)}%`}}></div>
                  </div>
                  <div className="text-sm font-bold">{progressPercent}%</div>
                </div>
                <div className="text-xs text-slate-400">{fmt(currentTotal)}‚ÇΩ ‚Üí {fmt(goal)}‚ÇΩ</div>
              </div>
            </div>

            <nav className="mt-4 flex flex-wrap gap-2">
              {[
                {id:'monthlyReport', title:'–ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç'},
                {id:'dolgo', title:'–î–æ–ª–≥–æ–ª–µ—Ç–∏–µ'},
                {id:'individuals', title:'–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ'},
                {id:'rentals', title:'–ê—Ä–µ–Ω–¥–∞'},
                {id:'expenses', title:'–†–∞—Å—Ö–æ–¥—ã'},
                {id:'passive', title:'–ü–∞—Å—Å–∏–≤–Ω—ã–π'},
                {id:'students', title:'–£—á–µ–Ω–∏–∫–∏'},
                {id:'analytics', title:'–ê–Ω–∞–ª–∏—Ç–∏–∫–∞'},
                {id:'archive', title:'–ü–æ –º–µ—Å—è—Ü–∞–º'},
                {id:'summary', title:'–°–≤–æ–¥–∫–∞'},
                {id:'teachers', title:'–ü–µ–¥–∞–≥–æ–≥–∏'},
                {id:'chat', title:'–ß–∞—Ç'}
              ].map(t=>(
                <button key={t.id} onClick={()=>setActiveTab(t.id)}
                  className={`px-3 py-1 rounded ${activeTab===t.id ? 'bg-blue-600' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'}`}>
                  {t.title}
                </button>
              ))}
            </nav>
          </header>

          <main className="bg-slate-800 rounded p-4 border border-slate-700">
            {/* Monthly report */}
            {activeTab === 'monthlyReport' && (
              <section>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-bold">üìÖ –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç</h2>
                  <div className="flex gap-2">
                    <button onClick={()=>setActiveTab('summary')} className="px-3 py-2 bg-slate-700 rounded">–ü–µ—Ä–µ–π—Ç–∏ –≤ —Å–≤–æ–¥–∫—É</button>
                    <button onClick={exportData} className="px-3 py-2 bg-green-600 rounded">–≠–∫—Å–ø–æ—Ä—Ç</button>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                  <div className="bg-slate-900 p-3 rounded">
                    <div className="text-slate-400 text-sm">–ú–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥</div>
                    <div className="text-2xl font-bold text-green-400">{fmt(totalReportIncome)}‚ÇΩ</div>
                  </div>
                  <div className="bg-slate-900 p-3 rounded">
                    <div className="text-slate-400 text-sm">–†–∞—Å—Ö–æ–¥—ã</div>
                    <div className="text-2xl font-bold text-red-400">-{fmt(totalReportExpense)}‚ÇΩ</div>
                  </div>
                  <div className="bg-slate-900 p-3 rounded">
                    <div className="text-slate-400 text-sm">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</div>
                    <div className="text-2xl font-bold text-blue-400">{fmt(totalReportProfit)}‚ÇΩ</div>
                  </div>
                  <div className="bg-slate-900 p-3 rounded">
                    <div className="text-slate-400 text-sm">–ü–µ–¥–∞–≥–æ–≥–æ–≤</div>
                    <div className="text-2xl font-bold text-yellow-400">{teachers.length}</div>
                  </div>
                </div>

                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead>
                      <tr className="text-left text-slate-300 border-b border-slate-700">
                        <th className="py-2 px-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                        <th className="py-2 px-2 text-right">–î–æ—Ö–æ–¥</th>
                        <th className="py-2 px-2 text-right">–†–∞—Å—Ö–æ–¥</th>
                        <th className="py-2 px-2 text-right">–ü—Ä–∏–±—ã–ª—å</th>
                      </tr>
                    </thead>
                    <tbody>
                      {monthlyReport.map((r,i)=>(
                        <tr key={i} className="border-b border-slate-700/40">
                          <td className="py-2 px-2">{r.category}</td>
                          <td className="py-2 px-2 text-right text-green-400">{fmt(r.income)}‚ÇΩ</td>
                          <td className="py-2 px-2 text-right text-red-400">-{fmt(r.expense)}‚ÇΩ</td>
                          <td className="py-2 px-2 text-right text-blue-400 font-semibold">{fmt(r.profit)}‚ÇΩ</td>
                        </tr>
                      ))}
                    </tbody>
                    <tfoot className="bg-slate-900/50">
                      <tr className="font-bold">
                        <td className="py-2 px-2">–ò–¢–û–ì–û:</td>
                        <td className="py-2 px-2 text-right text-green-400">{fmt(totalReportIncome)}‚ÇΩ</td>
                        <td className="py-2 px-2 text-right text-red-400">-{fmt(totalReportExpense)}‚ÇΩ</td>
                        <td className="py-2 px-2 text-right text-blue-400">{fmt(totalReportProfit)}‚ÇΩ</td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </section>
            )}

            {/* Dolgo */}
            {activeTab === 'dolgo' && (
              <section>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-bold">üèÉ –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ</h2>
                  <button className="px-3 py-2 bg-blue-600 rounded" onClick={()=>openModal('dolgo')}>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                </div>

                <div className="overflow-x-auto mb-4">
                  <table className="w-full text-sm">
                    <thead>
                      <tr className="border-b border-slate-700 text-slate-300">
                        <th className="py-2 px-2">–î–∞—Ç–∞</th>
                        <th className="py-2 px-2">–õ–æ–∫–∞—Ü–∏—è</th>
                        <th className="py-2 px-2">–ü–µ–¥–∞–≥–æ–≥</th>
                        <th className="py-2 px-2 text-right">–°—Ç–∞–≤–∫–∞</th>
                        <th className="py-2 px-2 text-right">–õ—é–¥–µ–π</th>
                        <th className="py-2 px-2 text-right">–î–æ—Ö–æ–¥</th>
                        <th className="py-2 px-2 text-right">–†–∞—Å—Ö–æ–¥ –ø–µ–¥.</th>
                        <th className="py-2 px-2 text-right">–†–∞—Å—Ö–æ–¥ –∑–∞–ª</th>
                        <th className="py-2 px-2 text-right">–ü—Ä–∏–±—ã–ª—å</th>
                        <th className="py-2 px-2 text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                      </tr>
                    </thead>
                    <tbody>
                      {dolgo.map((r,idx)=>{
                        const teacherExpense = calcTeacherExpense(Number(r.income||0), r.rate);
                        const profit = Number(r.income||0) - teacherExpense - Number(r.hallExpense||0);
                        return (
                          <tr key={idx} className="border-b border-slate-700/40">
                            <td className="py-2 px-2">{r.date}</td>
                            <td className="py-2 px-2">{r.location}</td>
                            <td className="py-2 px-2">{r.teacher}</td>
                            <td className="py-2 px-2 text-right">{r.rate}</td>
                            <td className="py-2 px-2 text-right">{r.people}</td>
                            <td className="py-2 px-2 text-right text-green-400">{fmt(r.income)}‚ÇΩ</td>
                            <td className="py-2 px-2 text-right text-red-400">{fmt(teacherExpense)}‚ÇΩ</td>
                            <td className="py-2 px-2 text-right">{fmt(r.hallExpense)}‚ÇΩ</td>
                            <td className="py-2 px-2 text-right text-blue-400 font-bold">{fmt(profit)}‚ÇΩ</td>
                            <td className="py-2 px-2 text-center">
                              <button onClick={()=>openModal('dolgo', idx)} className="text-blue-400 mr-2">‚úé</button>
                              <button onClick={()=>deleteItem('dolgo', idx)} className="text-red-400">üóë</button>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                    <tfoot className="bg-slate-900/50 font-bold">
                      <tr>
                        <td colSpan="5" className="py-2 px-2">–ò–¢–û–ì–û:</td>
                        <td className="py-2 px-2 text-right text-green-400">{fmt(totalDolgoIncome)}‚ÇΩ</td>
                        <td className="py-2 px-2 text-right text-red-400">{fmt(totalDolgoTeacherExpense)}‚ÇΩ</td>
                        <td className="py-2 px-2 text-right">{fmt(totalDolgoHallExpense)}‚ÇΩ</td>
                        <td className="py-2 px-2 text-right text-blue-400">{fmt(totalDolgoProfit)}‚ÇΩ</td>
                        <td></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>

                <div className="text-sm text-slate-400">
                  –î–æ—Ö–æ–¥ = –õ—é–¥–µ–π √ó 280‚ÇΩ. –°—Ç–∞–≤–∫–∏: 50% / 700 / 1000 / 100% –∏–ª–∏ —Å–≤–æ—ë –∑–Ω–∞—á–µ–Ω–∏–µ.
                </div>
              </section>
            )}

            {/* Individuals, Rentals, Expenses, Passive, Students, Analytics, Archive, Summary */}
            {activeTab === 'individuals' && (
              <section>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-bold">üë§ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —É—Ä–æ–∫–∏</h2>
                  <button className="px-3 py-2 bg-blue-600 rounded" onClick={()=>openModal('individual')}>–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="text-slate-300">
                      <tr className="border-b border-slate-700">
                        <th className="py-2 px-2">–î–∞—Ç–∞</th><th className="py-2 px-2">–¢–∏–ø</th><th className="py-2 px-2">–ö–ª–∏–µ–Ω—Ç</th><th className="py-2 px-2">–ü–µ–¥–∞–≥–æ–≥</th><th className="py-2 px-2 text-right">–°—É–º–º–∞</th><th className="py-2 px-2 text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                      </tr>
                    </thead>
                    <tbody>
                      {individuals.map((r,idx)=>(
                        <tr key={idx} className="border-b border-slate-700/40">
                          <td className="py-2 px-2">{r.date}</td><td className="py-2 px-2">{r.type}</td><td className="py-2 px-2">{r.client}</td><td className="py-2 px-2">{r.teacher||'‚Äî'}</td><td className="py-2 px-2 text-right text-green-400">{fmt(r.amount)}‚ÇΩ</td>
                          <td className="py-2 px-2 text-center">
                            <button onClick={()=>openModal('individual', idx)} className="text-blue-400 mr-2">‚úé</button>
                            <button onClick={()=>deleteItem('individual', idx)} className="text-red-400">üóë</button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                    <tfoot className="bg-slate-900/50 font-bold">
                      <tr>
                        <td colSpan="4" className="py-2 px-2">–ò–¢–û–ì–û:</td>
                        <td className="py-2 px-2 text-right text-green-400">{fmt(totalIndividualIncome)}‚ÇΩ</td><td></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </section>
            )}

            {activeTab === 'rentals' && (
              <section>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-bold">üè† –ê—Ä–µ–Ω–¥–∞ –∑–∞–ª–∞</h2>
                  <button className="px-3 py-2 bg-blue-600 rounded" onClick={()=>openModal('rental')}>–î–æ–±–∞–≤–∏—Ç—å –∞—Ä–µ–Ω–¥—É</button>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="text-slate-300">
                      <tr className="border-b border-slate-700">
                        <th className="py-2 px-2">–î–∞—Ç–∞</th><th className="py-2 px-2">–ò–º—è</th><th className="py-2 px-2 text-right">–°—É–º–º–∞</th><th className="py-2 px-2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th className="py-2 px-2 text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                      </tr>
                    </thead>
                    <tbody>
                      {rentals.map((r,idx)=>(
                        <tr key={idx} className="border-b border-slate-700/40">
                          <td className="py-2 px-2">{r.date}</td><td className="py-2 px-2">{r.name}</td><td className="py-2 px-2 text-right text-green-400">{fmt(r.amount)}‚ÇΩ</td><td className="py-2 px-2 text-slate-400">{r.comment}</td>
                          <td className="py-2 px-2 text-center">
                            <button onClick={()=>openModal('rental', idx)} className="text-blue-400 mr-2">‚úé</button>
                            <button onClick={()=>deleteItem('rental', idx)} className="text-red-400">üóë</button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                    <tfoot className="bg-slate-900/50 font-bold">
                      <tr>
                        <td colSpan="2" className="py-2 px-2">–ò–¢–û–ì–û:</td><td className="py-2 px-2 text-right text-green-400">{fmt(totalRentalsIncome)}‚ÇΩ</td><td colSpan="2"></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </section>
            )}

            {activeTab === 'expenses' && (
              <section>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-bold">üí∏ –†–∞—Å—Ö–æ–¥—ã</h2>
                  <button className="px-3 py-2 bg-blue-600 rounded" onClick={()=>openModal('expense')}>–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="text-slate-300">
                      <tr className="border-b border-slate-700">
                        <th className="py-2 px-2">–î–∞—Ç–∞</th><th className="py-2 px-2">–¢–∏–ø</th><th className="py-2 px-2">–ß—Ç–æ</th><th className="py-2 px-2 text-right">–°—É–º–º–∞</th><th className="py-2 px-2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th className="py-2 px-2 text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                      </tr>
                    </thead>
                    <tbody>
                      {expenses.map((r,idx)=>(
                        <tr key={idx} className="border-b border-slate-700/40">
                          <td className="py-2 px-2">{r.date}</td><td className="py-2 px-2">{r.type}</td><td className="py-2 px-2">{r.what}</td><td className="py-2 px-2 text-right text-red-400">-{fmt(r.amount)}‚ÇΩ</td><td className="py-2 px-2 text-slate-400">{r.comment}</td>
                          <td className="py-2 px-2 text-center">
                            <button onClick={()=>openModal('expense', idx)} className="text-blue-400 mr-2">‚úé</button>
                            <button onClick={()=>deleteItem('expense', idx)} className="text-red-400">üóë</button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                    <tfoot className="bg-slate-900/50 font-bold">
                      <tr><td colSpan="3" className="py-2 px-2">–ò–¢–û–ì–û:</td><td className="py-2 px-2 text-right text-red-400">-{fmt(totalExpenses)}‚ÇΩ</td><td colSpan="2"></td></tr>
                    </tfoot>
                  </table>
                </div>
              </section>
            )}

            {activeTab === 'passive' && (
              <section>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-bold">üí∞ –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥</h2>
                  <button className="px-3 py-2 bg-blue-600 rounded" onClick={()=>openModal('passive')}>–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="text-slate-300">
                      <tr className="border-b border-slate-700">
                        <th className="py-2 px-2">–î–∞—Ç–∞</th><th className="py-2 px-2">–ò—Å—Ç–æ—á–Ω–∏–∫</th><th className="py-2 px-2 text-right">–°—É–º–º–∞/–º–µ—Å</th><th className="py-2 px-2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th className="py-2 px-2 text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                      </tr>
                    </thead>
                    <tbody>
                      {passive.map((r,idx)=>(
                        <tr key={idx} className="border-b border-slate-700/40">
                          <td className="py-2 px-2">{r.date}</td><td className="py-2 px-2">{r.source}</td><td className="py-2 px-2 text-right text-green-400">{fmt(r.monthly)}‚ÇΩ</td><td className="py-2 px-2 text-slate-400">{r.comment}</td>
                          <td className="py-2 px-2 text-center">
                            <button onClick={()=>openModal('passive', idx)} className="text-blue-400 mr-2">‚úé</button>
                            <button onClick={()=>deleteItem('passive', idx)} className="text-red-400">üóë</button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                    <tfoot className="bg-slate-900/50 font-bold">
                      <tr><td colSpan="2" className="py-2 px-2">–ò–¢–û–ì–û:</td><td className="py-2 px-2 text-right text-green-400">{fmt(totalPassiveIncome)}‚ÇΩ</td><td colSpan="2"></td></tr>
                    </tfoot>
                  </table>
                </div>
              </section>
            )}

            {activeTab === 'students' && (
              <section>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-bold">üë• –ë–∞–∑–∞ —É—á–µ–Ω–∏–∫–æ–≤</h2>
                  <button className="px-3 py-2 bg-blue-600 rounded" onClick={()=>openModal('student')}>–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                  <div className="bg-slate-900 p-3 rounded">
                    <div className="text-slate-400 text-sm">–í—Å–µ–≥–æ —É—á–µ–Ω–∏–∫–æ–≤</div>
                    <div className="text-2xl font-bold text-blue-400">{students.length}</div>
                  </div>
                  <div className="bg-slate-900 p-3 rounded">
                    <div className="text-slate-400 text-sm">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                    <div className="text-2xl font-bold text-green-400">{students.filter(s=>s.status==='–ê–∫—Ç–∏–≤–Ω—ã–π').length}</div>
                  </div>
                  <div className="bg-slate-900 p-3 rounded">
                    <div className="text-slate-400 text-sm">–°—Ä–µ–¥–Ω–∏–π –¥–æ—Ö–æ–¥</div>
                    <div className="text-2xl font-bold text-yellow-400">{fmt(students.length ? Math.round((totalReportProfit + totalIndividualIncome + totalPassiveIncome - totalExpenses) / students.length) : 0)}‚ÇΩ</div>
                  </div>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="text-slate-300">
                      <tr className="border-b border-slate-700">
                        <th className="py-2 px-2">–ò–º—è</th><th className="py-2 px-2">–¢–µ–ª–µ—Ñ–æ–Ω</th><th className="py-2 px-2">–ì—Ä—É–ø–ø–∞</th><th className="py-2 px-2">–ê–±–æ–Ω–µ–º–µ–Ω—Ç</th><th className="py-2 px-2">–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ</th><th className="py-2 px-2">–°—Ç–∞—Ç—É—Å</th><th className="py-2 px-2 text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                      </tr>
                    </thead>
                    <tbody>
                      {students.map((s,idx)=>(
                        <tr key={idx} className="border-b border-slate-700/40">
                          <td className="py-2 px-2">{s.name}</td><td className="py-2 px-2">{s.phone}</td><td className="py-2 px-2">{s.group}</td><td className="py-2 px-2">{s.subscription}</td><td className="py-2 px-2">{s.expiry}</td><td className="py-2 px-2">{s.status}</td>
                          <td className="py-2 px-2 text-center">
                            <button onClick={()=>openModal('student', idx)} className="text-blue-400 mr-2">‚úé</button>
                            <button onClick={()=>deleteItem('student', idx)} className="text-red-400">üóë</button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </section>
            )}

            {activeTab === 'analytics' && (
              <section>
                <h2 className="text-lg font-bold mb-4">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="bg-slate-900 p-4 rounded">
                    <h3 className="text-sm text-green-400 font-bold mb-2">–§–∏–Ω–∞–Ω—Å—ã</h3>
                    <div className="space-y-2">
                      <div className="flex justify-between"><span>–¢–µ–∫—É—â–∏–π –¥–æ—Ö–æ–¥ (–º–µ—Å—è—Ü):</span><b>{fmt(totalReportIncome)}‚ÇΩ</b></div>
                      <div className="flex justify-between"><span>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å:</span><b className="text-blue-400">{fmt(totalReportProfit)}‚ÇΩ</b></div>
                      <div className="flex justify-between"><span>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å:</span><b>{ totalReportIncome ? Math.round((totalReportProfit/totalReportIncome)*100) : 0 }%</b></div>
                    </div>
                  </div>

                  <div className="bg-slate-900 p-4 rounded">
                    <h3 className="text-sm text-blue-400 font-bold mb-2">–£—á–µ–Ω–∏–∫–∏</h3>
                    <div className="space-y-2">
                      <div className="flex justify-between"><span>–í—Å–µ–≥–æ —É—á–µ–Ω–∏–∫–æ–≤:</span><b>{students.length}</b></div>
                      <div className="flex justify-between"><span>–ê–∫—Ç–∏–≤–Ω—ã—Ö:</span><b className="text-green-400">{students.filter(s=>s.status==='–ê–∫—Ç–∏–≤–Ω—ã–π').length}</b></div>
                      <div className="flex justify-between"><span>–°—Ä–µ–¥–Ω–∏–π –¥–æ—Ö–æ–¥ —Å —É—á–µ–Ω–∏–∫–∞:</span><b className="text-yellow-400">{fmt(students.length ? Math.round((totalReportProfit + totalIndividualIncome + totalPassiveIncome - totalExpenses) / students.length) : 0)}‚ÇΩ</b></div>
                    </div>
                  </div>
                </div>
              </section>
            )}

            {activeTab === 'archive' && (
              <section>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-bold">üìÜ –ü–æ –º–µ—Å—è—Ü–∞–º (–∞—Ä—Ö–∏–≤)</h2>
                  <button className="px-3 py-2 bg-blue-600 rounded" onClick={()=>openModal('archive')}>–î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—è—Ü</button>
                </div>

                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="text-slate-300">
                      <tr className="border-b border-slate-700">
                        <th className="py-2 px-2">–ú–µ—Å—è—Ü</th><th className="py-2 px-2 text-right">–î–æ–ª–≥–æ–ª–µ—Ç–∏–µ</th><th className="py-2 px-2 text-right">–ò–Ω–¥–∏–≤–∏–¥.</th><th className="py-2 px-2 text-right">–ü–∞—Å—Å–∏–≤–Ω—ã–π</th><th className="py-2 px-2 text-right">–†–∞—Å—Ö–æ–¥—ã</th><th className="py-2 px-2 text-right">–ü—Ä–∏–±—ã–ª—å</th><th className="py-2 px-2 text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                      </tr>
                    </thead>
                    <tbody>
                      {monthlyArchive.map((r,idx)=>(
                        <tr key={idx} className="border-b border-slate-700/40">
                          <td className="py-2 px-2">{r.month} {r.year}</td><td className="py-2 px-2 text-right">{fmt(r.groupIncome)}‚ÇΩ</td><td className="py-2 px-2 text-right">{fmt(r.individualIncome)}‚ÇΩ</td><td className="py-2 px-2 text-right">{fmt(r.passiveIncome)}‚ÇΩ</td><td className="py-2 px-2 text-right">-{fmt(r.expenses)}‚ÇΩ</td><td className="py-2 px-2 text-right text-blue-400 font-bold">{fmt(r.profit)}‚ÇΩ</td>
                          <td className="py-2 px-2 text-center">
                            <button onClick={()=>openModal('archive', idx)} className="text-blue-400 mr-2">‚úé</button>
                            <button onClick={()=>deleteItem('archive', idx)} className="text-red-400">üóë</button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                    <tfoot className="bg-slate-900/50 font-bold">
                      <tr>
                        <td className="py-2 px-2">–ò–¢–û–ì–û:</td>
                        <td className="py-2 px-2 text-right">{fmt(monthlyArchive.reduce((s,r)=>s+(r.groupIncome||0),0))}‚ÇΩ</td>
                        <td className="py-2 px-2 text-right">{fmt(monthlyArchive.reduce((s,r)=>s+(r.individualIncome||0),0))}‚ÇΩ</td>
                        <td className="py-2 px-2 text-right">{fmt(monthlyArchive.reduce((s,r)=>s+(r.passiveIncome||0),0))}‚ÇΩ</td>
                        <td className="py-2 px-2 text-right">-{fmt(monthlyArchive.reduce((s,r)=>s+(r.expenses||0),0))}‚ÇΩ</td>
                        <td className="py-2 px-2 text-right">{fmt(monthlyArchive.reduce((s,r)=>s+(r.profit||0),0))}‚ÇΩ</td>
                        <td></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </section>
            )}

            {activeTab === 'summary' && (
              <section>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-bold">üìà –°–≤–æ–¥–∫–∞</h2>
                  <button onClick={exportData} className="px-3 py-2 bg-green-600 rounded">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="bg-slate-900 p-4 rounded">
                    <div className="flex justify-between"><span>–î–æ–ª–≥–æ–ª–µ—Ç–∏–µ (–ø—Ä–∏–±—ã–ª—å):</span><b>{fmt(totalDolgoProfit)}‚ÇΩ</b></div>
                    <div className="flex justify-between"><span>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª–∫–∏:</span><b>{fmt(totalIndividualIncome)}‚ÇΩ</b></div>
                    <div className="flex justify-between"><span>–ê—Ä–µ–Ω–¥–∞ –∑–∞–ª–∞:</span><b>{fmt(totalRentalsIncome)}‚ÇΩ</b></div>
                    <div className="flex justify-between"><span>–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥:</span><b>{fmt(totalPassiveIncome)}‚ÇΩ</b></div>
                    <div className="flex justify-between mt-2"><span>–†–∞—Å—Ö–æ–¥—ã:</span><b className="text-red-400">-{fmt(totalExpenses)}‚ÇΩ</b></div>
                    <div className="flex justify-between mt-4 text-xl font-bold"><span>–ß–ò–°–¢–ê–Ø –ü–†–ò–ë–´–õ–¨:</span><b className="text-blue-400">{fmt(totalReportProfit)}‚ÇΩ</b></div>
                  </div>
                  <div className="bg-slate-900 p-4 rounded">
                    <div className="text-slate-400 text-sm mb-2">–ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞</div>
                    <div className="text-sm">–í—Å–µ–≥–æ –¥–æ—Ö–æ–¥–æ–≤: {fmt(totalReportIncome)}‚ÇΩ</div>
                    <div className="text-sm">–í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤: {fmt(totalReportExpense)}‚ÇΩ</div>
                    <div className="text-sm">–ü—Ä–∏–±—ã–ª—å: {fmt(totalReportProfit)}‚ÇΩ</div>
                  </div>
                </div>
              </section>
            )}

            {/* Teachers: from first file */}
            {activeTab === 'teachers' && (
              <section>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-bold">üë• –ü–µ–¥–∞–≥–æ–≥–∏</h2>
                  <div className="flex gap-2">
                    <button className="px-3 py-2 bg-blue-600 rounded" onClick={toggleAddTeacherUI}>+ –î–æ–±–∞–≤–∏—Ç—å</button>
                    <button className="px-3 py-2 bg-slate-700 rounded" onClick={()=>setActiveTab('chat')}>–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button>
                  </div>
                </div>

                {/* add form inline toggle using modal */}
                <div className="mb-4">
                  {teachers.length === 0 ? <div className="text-slate-400">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div> : (
                    <div className="space-y-2">
                      {teachers.map((t, i)=>(
                        <div key={i} className="bg-slate-900 p-3 rounded flex justify-between items-center">
                          <div>
                            <div className="font-semibold">{t.name}</div>
                            <div className="text-sm text-slate-400">{t.direction}</div>
                            <div className="text-xs text-slate-400">{t.students}/{t.limit} —É—á–µ–Ω–∏–∫–æ–≤ ({Math.round((t.students/(t.limit||1))*100)}%)</div>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className={`px-3 py-1 rounded text-sm ${t.status==='critical' ? 'bg-red-100 text-red-600' : t.status==='warning' ? 'bg-yellow-100 text-yellow-600' : 'bg-green-100 text-green-600'}`}>{t.status==='critical' ? '–ö—Ä–∏—Ç–∏—á–Ω–æ' : t.status==='warning' ? '–ù–µ–¥–æ–∑–∞–≥—Ä—É–∑–∫–∞' : '–ù–æ—Ä–º–∞'}</span>
                            <button onClick={()=>{ setShowModal(true); setModalType('editTeacher'); setEditingIndex(i); setForm(t); }} className="text-blue-400">‚úé</button>
                            <button onClick={()=>deleteTeacher(i)} className="text-red-400">üóë</button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </section>
            )}

            {/* Chat component */}
            {activeTab === 'chat' && (
              <section>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-bold">üí¨ –ß–∞—Ç –ø–æ–º–æ—â–Ω–∏–∫</h2>
                  <div className="text-sm text-slate-400">–í—Å—Ç–∞–≤—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ–¥–∞–≥–æ–≥–∞ –∏–ª–∏ –æ–ø–∏—à–∏ –ø—Ä–æ–±–ª–µ–º—É ‚Äî –ø–æ–ª—É—á–∏—à—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞.</div>
                </div>

                <div className="bg-slate-900 p-3 rounded mb-3">
                  <div className="space-y-3" style={{maxHeight: '48vh', overflowY:'auto'}}>
                    {chatMessages.map((m, idx)=>(
                      <div key={idx} className={`flex gap-3 ${m.who==='user' ? 'justify-end' : 'justify-start'}`}>
                        {m.who==='bot' && <div className="avatar bg-gradient-to-br from-purple-600 to-indigo-500">ü§ñ</div>}
                        <div className={`p-3 rounded max-w-[75%] ${m.who==='user' ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-200'}`}>
                          <div className="text-xs text-slate-400 mb-1">{m.who==='user' ? '–í—ã' : '–ü–æ–º–æ—â–Ω–∏–∫'}</div>
                          <div style={{whiteSpace:'pre-line'}}>{m.text}</div>
                          <div className="text-xs text-slate-400 mt-1">{new Date(m.time).toLocaleString()}</div>
                        </div>
                        {m.who==='user' && <div className="avatar bg-blue-600">üë§</div>}
                      </div>
                    ))}
                  </div>
                </div>

                <ChatInput onSend={(text)=>sendChatMessage(text)} />
              </section>
            )}

          </main>

          {/* Modal area used for many forms (teachers + finance) */}
          {showModal && (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50" onClick={closeModal}>
              <div className="bg-slate-800 rounded p-4 w-full max-w-2xl" onClick={e=>e.stopPropagation()}>
                <div className="flex justify-between items-center mb-3">
                  <h3 className="text-lg font-bold">{editingIndex!==null ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'} ‚Äî {modalType}</h3>
                  <button onClick={closeModal} className="text-slate-400">‚úñ</button>
                </div>

                <div className="space-y-2 max-h-[60vh] overflow-y-auto pb-2">
                  {/* teacher add/edit */}
                  {(modalType === 'addTeacher' || modalType === 'editTeacher') && (
                    <>
                      <div><label className="text-sm">–ò–º—è</label><input className="w-full mt-1 p-2 bg-slate-700 rounded" value={form.name||''} onChange={(e)=>setForm({...form, name: e.target.value})} /></div>
                      <div><label className="text-sm">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label><input className="w-full mt-1 p-2 bg-slate-700 rounded" value={form.direction||''} onChange={(e)=>setForm({...form, direction: e.target.value})} /></div>
                      <div className="grid grid-cols-2 gap-2">
                        <div><label className="text-sm">–£—á–µ–Ω–∏–∫–æ–≤</label><input type="number" className="w-full mt-1 p-2 bg-slate-700 rounded" value={form.students||0} onChange={(e)=>setForm({...form, students: Number(e.target.value)})} /></div>
                        <div><label className="text-sm">–õ–∏–º–∏—Ç</label><input type="number" className="w-full mt-1 p-2 bg-slate-700 rounded" value={form.limit||25} onChange={(e)=>setForm({...form, limit: Number(e.target.value)})} /></div>
                      </div>
                    </>
                  )}

                  {/* generic finance modals reused from second file (reduced) */}
                  {modalType === 'dolgo' && (
                    <>
                      <div><label className="text-sm">–î–∞—Ç–∞</label><input className="w-full mt-1 p-2 bg-slate-700 rounded" value={form.date||''} onChange={(e)=>setForm({...form, date:e.target.value})} placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 06.12" /></div>
                      <div>
                        <label className="text-sm">–õ–æ–∫–∞—Ü–∏—è</label>
                        <select className="w-full mt-1 p-2 bg-slate-700 rounded" value={form.location||''} onChange={(e)=>{ const loc=e.target.value; setForm({...form, location: loc, hallExpense: locationDefaults[loc] ?? 0}); }}>
                          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é</option>
                          <option>–ë—É–¥–µ–Ω–Ω–æ–≥–æ</option><option>–ß–µ—Ä–∫–∏–∑–æ–≤—Å–∫–∞—è</option><option>–ü–∞—Ä–∫</option>
                        </select>
                      </div>
                      <div><label className="text-sm">–ü–µ–¥–∞–≥–æ–≥</label><input className="w-full mt-1 p-2 bg-slate-700 rounded" value={form.teacher||''} onChange={(e)=>setForm({...form, teacher:e.target.value})} /></div>
                      <div className="grid grid-cols-2 gap-2">
                        <div>
                          <label className="text-sm">–°—Ç–∞–≤–∫–∞ –ø–µ–¥–∞–≥–æ–≥–∞</label>
                          <select className="w-full mt-1 p-2 bg-slate-700 rounded" value={form.rate||'50%'} onChange={(e)=>setForm({...form, rate:e.target.value})}>
                            <option value="50%">50%</option><option value="700">700‚ÇΩ</option><option value="1000">1000‚ÇΩ</option><option value="100%">100%</option><option value="custom">–î—Ä—É–≥–æ–µ...</option>
                          </select>
                          {form.rate==='custom' && <input className="mt-2 w-full p-2 bg-slate-700 rounded" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏–ª–∏ % (–ø—Ä–∏–º–µ—Ä: 800 –∏–ª–∏ 40%)" value={form.customRate||''} onChange={(e)=>setForm({...form, customRate:e.target.value})} />}
                        </div>
                        <div>
                          <label className="text-sm">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª—é–¥–µ–π</label>
                          <input type="number" className="w-full mt-1 p-2 bg-slate-700 rounded" value={form.people||''} onChange={(e)=>{ const people=e.target.value; const income = Number(people||0)*280; setForm({...form, people, income}); }} />
                        </div>
                      </div>
                      <div><label className="text-sm">–†–∞—Å—Ö–æ–¥ –∑–∞ –∑–∞–ª (‚ÇΩ)</label><input type="number" className="w-full mt-1 p-2 bg-slate-700 rounded" value={form.hallExpense||0} onChange={(e)=>setForm({...form, hallExpense: Number(e.target.value)})} /></div>
                      <div><label className="text-sm">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><input className="w-full mt-1 p-2 bg-slate-700 rounded" value={form.comment||''} onChange={(e)=>setForm({...form, comment:e.target.value})} /></div>
                      <div className="text-sm text-slate-400">–î–æ—Ö–æ–¥ = –õ—é–¥–µ–π √ó 280‚ÇΩ.</div>
                    </>
                  )}

                  {/* individual, expense, rental, passive, student, archive forms omitted here for brevity but handled in saveModal similarly */}
                  {modalType === 'individual' && (
                    <>
                      <div><label className="text-sm">–î–∞—Ç–∞</label><input className="w-full mt-1 p-2 bg-slate-700 rounded" value={form.date||''} onChange={(e)=>setForm({...form,date:e.target.value})} /></div>
                      <div><label className="text-sm">–¢–∏–ø —É—Å–ª—É–≥–∏</label>
                        <select className="w-full mt-1 p-2 bg-slate-700 rounded" value={form.type||'–û—Å—Ç–∞–ª—å–Ω—ã–µ'} onChange={(e)=>setForm({...form,type:e.target.value})}>
                          <option>–ê–∑–±—É–∫–∞ —Ç–∞–Ω—Ü–∞</option><option>–õ–∞—Ç–∏–Ω—Å–∫–∏–π –∫–≤–∞—Ä—Ç–µ—Ç</option><option>–ü—Ä–æ–∞–º</option><option>–ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞</option><option>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</option><option>–û—Å—Ç–∞–ª—å–Ω—ã–µ</option>
                        </select>
                      </div>
                      <div><label className="text-sm">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label><input className="w-full mt-1 p-2 bg-slate-700 rounded" value={form.client||''} onChange={(e)=>setForm({...form,client:e.target.value})} /></div>
                      <div className="grid grid-cols-2 gap-2">
                        <div><label className="text-sm">–°—É–º–º–∞ (‚ÇΩ)</label><input type="number" className="w-full mt-1 p-2 bg-slate-700 rounded" value={form.amount||''} onChange={(e)=>setForm({...form,amount: Number(e.target.value)})} /></div>
                        <div><label className="text-sm">–ü–µ–¥–∞–≥–æ–≥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label><input className="w-full mt-1 p-2 bg-slate-700 rounded" value={form.teacher||''} onChange={(e)=>setForm({...form,teacher:e.target.value})} /></div>
                      </div>
                      <div><label className="text-sm">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><input className="w-full mt-1 p-2 bg-slate-700 rounded" value={form.comment||''} onChange={(e)=>setForm({...form,comment:e.target.value})} /></div>
                    </>
                  )}
                </div>

                <div className="flex gap-2 mt-3">
                  {/* determine which save to call */}
                  {(modalType === 'addTeacher' || modalType === 'editTeacher') ? (
                    <>
                      <button onClick={saveTeacher} className="px-4 py-2 bg-blue-600 rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                      <button onClick={closeModal} className="px-4 py-2 bg-slate-700 rounded">–û—Ç–º–µ–Ω–∞</button>
                    </>
                  ) : (
                    <>
                      <button onClick={saveModal} className="px-4 py-2 bg-blue-600 rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                      <button onClick={closeModal} className="px-4 py-2 bg-slate-700 rounded">–û—Ç–º–µ–Ω–∞</button>
                    </>
                  )}
                </div>
              </div>
            </div>
          )}

        </div>
      </div>
    );
  }

  // Chat input as separate small component
  function ChatInput({onSend}) {
    const [text, setText] = useState('');
    const ref = useRef(null);
    const submit = () => { if(!text.trim()) return; onSend(text.trim()); setText(''); ref.current && ref.current.focus(); };
    return (
      <div className="mt-3 flex gap-2">
        <input ref={ref} value={text} onChange={(e)=>setText(e.target.value)} onKeyDown={(e)=>{ if(e.key==='Enter') submit(); }} placeholder="–û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é..." className="flex-1 p-3 rounded bg-slate-700" />
        <button onClick={submit} className="px-4 py-2 bg-blue-600 rounded">‚û§</button>
      </div>
    );
  }

  ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
