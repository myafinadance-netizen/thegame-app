<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤ - –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ v2. 0</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background:  #0f172a; 
      color: #fff; 
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    
    . header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }
    . header-left h1 { font-size: 28px; margin-bottom: 8px; }
    .subtitle { color: #94a3b8; }
    
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn {
      background: #1e40af;
      color:  #fff;
      border: none;
      padding: 10px 18px;
      border-radius:  8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn:hover { background: #1e3a8a; transform: translateY(-1px); }
    .btn:active { transform: scale(0.98); }
    .btn. secondary { background: #334155; }
    .btn.secondary:hover { background: #475569; }
    . btn.danger { background: #dc2626; }
    .btn. danger:hover { background: #b91c1c; }
    
    .filter-bar {
      background: #1e293b;
      padding: 15px;
      border-radius: 12px;
      margin-bottom:  20px;
      display: none;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-bar select, .filter-bar input {
      background: #334155;
      color: #fff;
      border:  1px solid #475569;
      padding: 8px 12px;
      border-radius: 6px;
      font-size:  14px;
    }
    .filter-bar label {
      color: #94a3b8;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .stats { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: 15px; 
      margin-bottom: 30px; 
    }
    .stat-card {
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-2px); }
    .stat-card.green { background: linear-gradient(135deg, #065f46 0%, #047857 100%); }
    .stat-card.yellow { background: linear-gradient(135deg, #78350f 0%, #92400e 100%); }
    .stat-card.red { background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%); }
    . stat-card.purple { background: linear-gradient(135deg, #581c87 0%, #6b21a8 100%); }
    
    .stat-label { 
      font-size: 11px; 
      text-transform: uppercase; 
      letter-spacing: 1px; 
      opacity: 0.8;
      margin-bottom: 8px;
    }
    . stat-value { font-size: 32px; font-weight: bold; }
    . stat-change {
      font-size: 12px;
      margin-top: 8px;
      opacity: 0.9;
    }
    
    .table-container {
      background: #1e293b;
      border-radius: 12px;
      padding: 25px;
      margin-bottom:  20px;
      overflow-x: auto;
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .search-box {
      position: relative;
    }
    .search-box input {
      background: #334155;
      border: 1px solid #475569;
      color: #fff;
      padding: 8px 12px 8px 35px;
      border-radius:  8px;
      font-size:  14px;
      width: 250px;
    }
    . search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse;
    }
    th { 
      padding: 12px 8px; 
      text-align: left; 
      color: #cbd5e1; 
      font-size: 13px;
      border-bottom: 2px solid #334155;
      cursor: pointer;
      user-select: none;
      font-weight: 600;
    }
    th:hover { color: #fff; background: rgba(255,255,255,0.05); }
    td { 
      padding: 15px 8px; 
      border-bottom: 1px solid #334155;
    }
    tbody tr {
      transition: background 0.2s;
      cursor: pointer;
    }
    tbody tr:hover { background:  #334155; }
    
    .teacher-name { font-weight: bold; font-size: 16px; }
    .teacher-location { 
      color: #94a3b8; 
      font-size: 12px; 
      margin-top: 4px;
    }
    
    .badge {
      display: inline-block;
      background: #2563eb;
      color: #fff;
      padding: 6px 14px;
      border-radius:  20px;
      font-weight: bold;
      font-size: 14px;
    }
    
    .amount { font-weight: bold; font-size: 15px; }
    .green { color: #4ade80; }
    .yellow { color: #fbbf24; }
    . red { color: #f87171; }
    .blue { color: #60a5fa; }
    
    .progress-bar {
      width: 100%;
      height: 12px;
      background: #334155;
      border-radius:  10px;
      overflow: hidden;
      margin-bottom: 5px;
    }
    . progress-fill {
      height:  100%;
      transition: width 0.3s;
    }
    .progress-fill. high { background: #22c55e; }
    . progress-fill.medium { background: #eab308; }
    .progress-fill.low { background: #ef4444; }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left:  0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
    }
    .modal. active { display: flex; align-items: center; justify-content: center; }
    . modal-content {
      background: #1e293b;
      border-radius:  12px;
      padding:  30px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y:  auto;
    }
    . modal-header {
      display:  flex;
      justify-content:  space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-title { font-size: 20px; font-weight: bold; }
    .close-btn {
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
    }
    .close-btn:hover { color: #fff; }
    
    .form-group {
      margin-bottom: 15px;
    }
    . form-group label {
      display: block;
      color: #cbd5e1;
      font-size: 14px;
      margin-bottom: 5px;
      font-weight: 500;
    }
    .form-group input,
    .form-group select {
      width:  100%;
      background: #334155;
      border: 1px solid #475569;
      color: #fff;
      padding: 10px;
      border-radius:  6px;
      font-size: 14px;
    }
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    . form-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }
    
    .session-item {
      background: #334155;
      padding: 12px;
      border-radius:  8px;
      margin-bottom: 10px;
      display: grid;
      grid-template-columns: 100px 1fr 80px 100px;
      gap: 10px;
      align-items: center;
      font-size: 14px;
    }
    .session-date { color: #60a5fa; font-weight: bold; }
    .session-people { color: #4ade80; }
    .session-grant { color: #fbbf24; }
    
    .delete-btn {
      background: #dc2626;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .delete-btn:hover { background: #b91c1c; }
    
    .add-btn {
      background: #059669;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .add-btn:hover { background: #047857; }
    
    . alert {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #1e293b;
      border-left: 4px solid #22c55e;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      z-index: 2000;
      animation: slideIn 0.3s ease;
    }
    . alert. error { border-left-color: #ef4444; }
    
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .info-box {
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid #3b82f6;
      padding:  20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .info-title { 
      font-weight: bold; 
      color: #93c5fd; 
      margin-bottom: 15px;
      font-size: 16px;
    }
    
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    
    @media (max-width: 768px) {
      .controls { flex-direction: column; width: 100%; }
      . btn { width: 100%; }
      .search-box input { width: 100%; }
      table { font-size: 12px; }
      td, th { padding: 8px 4px; }
      .stat-card { padding: 15px; }
      .stat-value { font-size: 24px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <h1>üíº –ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤ v2. 0</h1>
        <div class="subtitle">–ü—Ä–æ–≥—Ä–∞–º–º–∞ "–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ" - –û—Ç—á—ë—Ç –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
      </div>
      <div class="controls">
        <button class="btn" onclick="showQuickAddModal()">‚ö° –î–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ</button>
        <button class="btn" onclick="showAddTeacherModal()">‚ûï –ù–æ–≤—ã–π –ø–µ–¥–∞–≥–æ–≥</button>
        <button class="btn secondary" onclick="exportData()">üì• –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        <button class="btn secondary" onclick="exportToCSV()">üìä –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
        <button class="btn secondary" onclick="importData()">üì§ –ò–º–ø–æ—Ä—Ç</button>
        <button class="btn secondary" onclick="toggleFilters()">üîç –§–∏–ª—å—Ç—Ä—ã</button>
      </div>
    </div>
    
    <div class="filter-bar" id="filterBar">
      <label>
        –ü–µ—Ä–∏–æ–¥
        <select id="periodFilter" onchange="applyPeriodFilter()">
          <option value="current_month" selected>–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</option>
          <option value="last_month">–ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü</option>
          <option value="current_quarter">–¢–µ–∫—É—â–∏–π –∫–≤–∞—Ä—Ç–∞–ª</option>
          <option value="current_year">–¢–µ–∫—É—â–∏–π –≥–æ–¥</option>
          <option value="all">–í–µ—Å—å –ø–µ—Ä–∏–æ–¥</option>
        </select>
      </label>
      <label>
        –õ–æ–∫–∞—Ü–∏—è
        <select id="locationFilter" onchange="applyFilters()">
          <option value="">–í—Å–µ –ª–æ–∫–∞—Ü–∏–∏</option>
        </select>
      </label>
      <label>
        –ú–∏–Ω. –∑–∞–Ω—è—Ç–∏–π
        <input type="number" id="minSessions" min="0" placeholder="0" onchange="applyFilters()">
      </label>
      <button class="btn" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>
    
    <div class="stats fade-in" id="statsContainer"></div>
    
    <div class="table-container fade-in">
      <div class="table-header">
        <h2>üìä –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –ø–µ–¥–∞–≥–æ–≥–∞–º</h2>
        <div class="search-box">
          <span class="search-icon">üîç</span>
          <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–µ–¥–∞–≥–æ–≥–∞..." onkeyup="searchTable()">
        </div>
      </div>
      
      <table id="mainTable">
        <thead>
          <tr>
            <th onclick="sortTable(0)">–ü–µ–¥–∞–≥–æ–≥ ‚Üï</th>
            <th class="text-center" onclick="sortTable(1)">–î–Ω–µ–π</th>
            <th class="text-center" onclick="sortTable(2)">–ó–∞–Ω—è—Ç–∏–π</th>
            <th class="text-center" onclick="sortTable(3)">–õ—é–¥–µ–π</th>
            <th class="text-right" onclick="sortTable(4)">–ì—Ä–∞–Ω—Ç ‚Üï</th>
            <th class="text-right" onclick="sortTable(5)">–ó–∞—Ä–ø–ª–∞—Ç–∞ ‚Üï</th>
            <th class="text-right" onclick="sortTable(6)">–ê—Ä–µ–Ω–¥–∞</th>
            <th class="text-right" onclick="sortTable(7)">–ü—Ä–∏–±—ã–ª—å ‚Üï</th>
            <th class="text-center" onclick="sortTable(8)">–†–µ–Ω—Ç.  ‚Üï</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot style="background: #0f172a; font-weight: bold;" id="tableFoot"></tfoot>
      </table>
    </div>
    
    <div class="info-box">
      <div class="info-title">üí° –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</div>
      <ul style="color: #e2e8f0; line-height: 2; margin-left: 20px;">
        <li><strong>‚ö° –î–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ</strong> - –±—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ –ø–µ–¥–∞–≥–æ–≥–∞ —Å —Ä–∞—Å—á—ë—Ç–æ–º</li>
        <li><strong>‚ûï –ù–æ–≤—ã–π –ø–µ–¥–∞–≥–æ–≥</strong> - —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</li>
        <li><strong>üìä –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å</strong>: üü¢ >50% | üü° >30% | üî¥ &lt;30%</li>
        <li><strong>üíæ –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è</strong> –≤ LocalStorage –±—Ä–∞—É–∑–µ—Ä–∞</li>
        <li><strong>üì•/üì§ –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç</strong> –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è</li>
      </ul>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª–∏ -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">–ü—Ä–æ—Ñ–∏–ª—å –ø–µ–¥–∞–≥–æ–≥–∞</div>
        <button class="close-btn" onclick="closeModal()">√ó</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>
  
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="editModalTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
        <button class="close-btn" onclick="closeEditModal()">√ó</button>
      </div>
      <div id="editModalBody"></div>
    </div>
  </div>
  
  <div class="modal" id="quickAddModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">‚ö° –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–Ω—è—Ç–∏—è</div>
        <button class="close-btn" onclick="closeQuickAddModal()">√ó</button>
      </div>
      <div id="quickAddModalBody"></div>
    </div>
  </div>

  <script>
    const GRANT_PER_PERSON = 280;
    
    let teachersData = [];
    const savedData = localStorage.getItem('teachersData');
    
    if (savedData) {
      try {
        teachersData = JSON.parse(savedData);
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
        teachersData = getDefaultData();
      }
    } else {
      teachersData = getDefaultData();
    }
    
    function getDefaultData() {
      return [
        {
          id: 1,
          name: "–ò–≤–∞–Ω–æ–≤–∞ –ú–∞—Ä–∏—è",
          location: "–ë—É–¥–µ–Ω–Ω–æ–≥–æ",
          salaryType: "percent",
          salaryValue: 50,
          hallCostPerSession: 0,
          sessions: [
            { date: "2024-12-01", people: 12 },
            { date: "2024-12-05", people: 15 },
            { date: "2024-12-10", people: 14 },
            { date: "2024-12-15", people: 8 }
          ]
        },
        {
          id: 2,
          name: "–°–∏–¥–æ—Ä–æ–≤–∞ –ê–Ω–Ω–∞",
          location: "–ß–µ—Ä–∫–∏–∑–æ–≤—Å–∫–∞—è",
          salaryType: "fixed",
          salaryValue: 1000,
          hallCostPerSession: 0,
          sessions: [
            { date: "2024-12-03", people: 18 },
            { date: "2024-12-10", people: 21 },
            { date: "2024-12-17", people: 19 }
          ]
        },
        {
          id: 3,
          name: "–ü–µ—Ç—Ä–æ–≤ –°–µ—Ä–≥–µ–π",
          location: "–ü–∞—Ä–∫",
          salaryType:  "fixed",
          salaryValue: 700,
          hallCostPerSession: 500,
          sessions: [
            { date: "2024-12-02", people: 10 },
            { date: "2024-12-09", people: 13 },
            { date: "2024-12-16", people: 11 }
          ]
        }
      ];
    }
    
    function saveData() {
      try {
        localStorage.setItem('teachersData', JSON.stringify(teachersData));
      } catch (e) {
        showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:  ' + e.message, 'error');
      }
    }
    
    function showAlert(message, type = 'success') {
      const alert = document.createElement('div');
      alert.className = `alert ${type === 'error' ? 'error' : ''}`;
      alert.textContent = message;
      document.body.appendChild(alert);
      
      setTimeout(() => {
        alert.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => alert.remove(), 300);
      }, 2000);
    }
    
    let currentPeriodFilter = { type: 'current_month', dateFrom: null, dateTo: null };
    
    function getPeriodDates(periodType) {
      const now = new Date();
      let from, to;
      
      switch(periodType) {
        case 'all': 
          return { from: null, to: null };
        case 'current_month':
          from = new Date(now.getFullYear(), now.getMonth(), 1);
          to = new Date(now. getFullYear(), now.getMonth() + 1, 0);
          break;
        case 'last_month':
          from = new Date(now.getFullYear(), now.getMonth() - 1, 1);
          to = new Date(now.getFullYear(), now.getMonth(), 0);
          break;
        case 'current_quarter':
          const q = Math.floor(now.getMonth() / 3);
          from = new Date(now.getFullYear(), q * 3, 1);
          to = new Date(now.getFullYear(), (q + 1) * 3, 0);
          break;
        case 'current_year':
          from = new Date(now.getFullYear(), 0, 1);
          to = new Date(now.getFullYear(), 11, 31);
          break;
        default:
          return { from: null, to: null };
      }
      
      return { from, to };
    }
    
    function filterSessionsByPeriod(sessions, from, to) {
      if (!from && !to) return sessions;
      return sessions.filter(s => {
        const d = new Date(s.date);
        if (from && d < from) return false;
        if (to && d > to) return false;
        return true;
      });
    }
    
    function applyPeriodFilter() {
      const type = document.getElementById('periodFilter').value;
      const dates = getPeriodDates(type);
      currentPeriodFilter = { type, dateFrom: dates.from, dateTo: dates.to };
      updateDisplay();
    }
    
    function calculateTeacherStats(teacher) {
      const totalPeople = teacher.sessions.reduce((s, t) => s + t.people, 0);
      const totalIncome = totalPeople * GRANT_PER_PERSON;
      const sessionsCount = teacher.sessions.length;
      const uniqueDates = new Set(teacher.sessions.map(s => s.date)).size;
      
      let salary = 0;
      let hallCost = 0;
      
      teacher.sessions.forEach(s => {
        const grant = s.people * GRANT_PER_PERSON;
        if (teacher.salaryType === 'fixed') {
          salary += teacher.salaryValue;
        } else {
          salary += Math.round((grant * teacher.salaryValue) / 100);
        }
        hallCost += teacher.hallCostPerSession || 0;
      });
      
      const profit = totalIncome - salary - hallCost;
      const profitability = totalIncome > 0 ? Math.round((profit / totalIncome) * 100) : 0;
      
      return {
        ... teacher,
        totalPeople,
        totalIncome,
        sessionsCount,
        uniqueDates,
        salary,
        hallCost,
        profit,
        profitability
      };
    }
    
    function formatNumber(num) {
      return num.toLocaleString('ru-RU');
    }
    
    function calculateTotals(teachers) {
      return {
        teachers: teachers.length,
        workDays: teachers.reduce((s, t) => s + t.uniqueDates, 0),
        sessions: teachers.reduce((s, t) => s + t.sessionsCount, 0),
        totalPeople: teachers.reduce((s, t) => s + t.totalPeople, 0),
        income: teachers.reduce((s, t) => s + t.totalIncome, 0),
        salary: teachers.reduce((s, t) => s + t.salary, 0),
        hallCost: teachers.reduce((s, t) => s + t.hallCost, 0),
        profit: teachers.reduce((s, t) => s + t.profit, 0)
      };
    }
    
    function updateDisplay() {
      const filtered = teachersData.map(t => ({
        ...t,
        sessions: filterSessionsByPeriod(t.sessions, currentPeriodFilter.dateFrom, currentPeriodFilter.dateTo)
      })).filter(t => t.sessions.length > 0).map(calculateTeacherStats);
      
      window.teachers = filtered;
      
      renderStats(filtered);
      renderTable(filtered);
      updateLocationFilter();
    }
    
    function renderStats(teachers) {
      const totals = calculateTotals(teachers);
      const avgProf = totals.income > 0 ? Math.round((totals.profit / totals.income) * 100) : 0;
      
      document.getElementById('statsContainer').innerHTML = `
        <div class="stat-card">
          <div class="stat-label">–ü–µ–¥–∞–≥–æ–≥–æ–≤</div>
          <div class="stat-value">${totals.teachers}</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-label">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
          <div class="stat-value">${totals.totalPeople}</div>
          <div class="stat-change">${totals.sessions} –∑–∞–Ω—è—Ç–∏–π</div>
        </div>
        <div class="stat-card green">
          <div class="stat-label">–ì—Ä–∞–Ω—Ç</div>
          <div class="stat-value">${formatNumber(totals.income)}‚ÇΩ</div>
        </div>
        <div class="stat-card yellow">
          <div class="stat-label">–ó–∞—Ä–ø–ª–∞—Ç–∞</div>
          <div class="stat-value">${formatNumber(totals.salary)}‚ÇΩ</div>
        </div>
        <div class="stat-card red">
          <div class="stat-label">–ê—Ä–µ–Ω–¥–∞</div>
          <div class="stat-value">${formatNumber(totals.hallCost)}‚ÇΩ</div>
        </div>
        <div class="stat-card" style="background:  linear-gradient(135deg, #0e7490 0%, #0891b2 100%);">
          <div class="stat-label">–ü—Ä–∏–±—ã–ª—å</div>
          <div class="stat-value">${formatNumber(totals.profit)}‚ÇΩ</div>
          <div class="stat-change">–†–µ–Ω—Ç:  ${avgProf}%</div>
        </div>
      `;
    }
    
    function renderTable(teachers) {
      const tbody = document.getElementById('tableBody');
      const tfoot = document.getElementById('tableFoot');
      const totals = calculateTotals(teachers);
      const avgProf = totals.income > 0 ? Math.round((totals.profit / totals.income) * 100) : 0;
      
      tbody.innerHTML = teachers.map(t => {
        const profClass = t.profitability > 50 ? 'high' : t.profitability > 30 ? 'medium' : 'low';
        return `
          <tr onclick='showTeacherDetails(${JSON.stringify(t).replace(/'/g, "&#39;")})' style="cursor: pointer;">
            <td>
              <div class="teacher-name">${t.name}</div>
              <div class="teacher-location">üìç ${t.location}</div>
            </td>
            <td class="text-center">${t.uniqueDates}</td>
            <td class="text-center">${t.sessionsCount}</td>
            <td class="text-center"><span class="badge">${t.totalPeople}</span></td>
            <td class="text-right green">${formatNumber(t.totalIncome)}‚ÇΩ</td>
            <td class="text-right yellow">${formatNumber(t.salary)}‚ÇΩ</td>
            <td class="text-right red">${formatNumber(t.hallCost)}‚ÇΩ</td>
            <td class="text-right blue">${formatNumber(t.profit)}‚ÇΩ</td>
            <td>
              <div class="progress-bar">
                <div class="progress-fill ${profClass}" style="width: ${Math.max(t.profitability, 0)}%"></div>
              </div>
              <div class="text-center" style="font-size: 13px; font-weight: bold;">${t.profitability}%</div>
            </td>
          </tr>
        `;
      }).join('');
      
      tfoot.innerHTML = `
        <tr>
          <td>–ò–¢–û–ì–û: </td>
          <td class="text-center">${totals.workDays}</td>
          <td class="text-center">${totals.sessions}</td>
          <td class="text-center">${totals.totalPeople}</td>
          <td class="text-right green">${formatNumber(totals.income)}‚ÇΩ</td>
          <td class="text-right yellow">${formatNumber(totals.salary)}‚ÇΩ</td>
          <td class="text-right red">${formatNumber(totals.hallCost)}‚ÇΩ</td>
          <td class="text-right blue">${formatNumber(totals.profit)}‚ÇΩ</td>
          <td class="text-center">${avgProf}%</td>
        </tr>
      `;
    }
    
    function updateLocationFilter() {
      const locations = [... new Set(teachersData.map(t => t.location))];
      const filter = document.getElementById('locationFilter');
      filter.innerHTML = '<option value="">–í—Å–µ –ª–æ–∫–∞—Ü–∏–∏</option>' + 
        locations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
    }
    
    function showTeacherDetails(teacher) {
      const fullTeacher = teachersData.find(t => t.id === teacher.id);
      const avgPerSession = teacher.sessionsCount > 0 ? Math.round(teacher.totalIncome / teacher. sessionsCount) : 0;
      const salaryInfo = teacher.salaryType === 'percent' ? `${teacher.salaryValue}%` : `${formatNumber(teacher.salaryValue)}‚ÇΩ/–∑–∞–Ω—è—Ç–∏`;
      
      const sessionsHTML = teacher.sessions.map(s => {
        const grant = s.people * GRANT_PER_PERSON;
        return `
          <div class="session-item">
            <div class="session-date">${new Date(s.date).toLocaleDateString('ru-RU')}</div>
            <div style="color: #cbd5e1;">üë• ${s.people} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
            <div></div>
            <div class="session-grant">${formatNumber(grant)}‚ÇΩ</div>
          </div>
        `;
      }).join('');
      
      document.getElementById('modalTitle').textContent = teacher.name;
      document.getElementById('modalBody').innerHTML = `
        <div style="margin-bottom: 20px;">
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: #334155; padding: 15px; border-radius: 8px;">
              <div style="color: #94a3b8; font-size: 12px;">–ó–∞–Ω—è—Ç–∏–π</div>
              <div style="font-size: 24px; font-weight: bold; color: #60a5fa;">${teacher.sessionsCount}</div>
            </div>
            <div style="background: #334155; padding: 15px; border-radius: 8px;">
              <div style="color:  #94a3b8; font-size: 12px;">–í—Å–µ–≥–æ –ª—é–¥–µ–π</div>
              <div style="font-size: 24px; font-weight: bold; color: #c084fc;">${teacher.totalPeople}</div>
            </div>
            <div style="background: #334155; padding:  15px; border-radius:  8px;">
              <div style="color: #94a3b8; font-size: 12px;">–ì—Ä–∞–Ω—Ç</div>
              <div style="font-size: 20px; font-weight: bold; color: #4ade80;">${formatNumber(teacher.totalIncome)}‚ÇΩ</div>
            </div>
            <div style="background: #334155; padding: 15px; border-radius: 8px;">
              <div style="color: #94a3b8; font-size: 12px;">–°—Ä–µ–¥–Ω–µ–µ/–∑–∞–Ω—è—Ç–∏–µ</div>
              <div style="font-size: 20px; font-weight: bold; color: #fbbf24;">${formatNumber(avgPerSession)}‚ÇΩ</div>
            </div>
          </div>
          
          <div style="background: #334155; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div style="color: #cbd5e1; font-weight: bold; margin-bottom: 10px;">–û–ø–ª–∞—Ç–∞</div>
            <div style="color: #fbbf24; font-size: 14px;">üí∞ ${salaryInfo}</div>
            <div style="color: #cbd5e1; font-size:  14px; margin-top: 10px;">
              –ù–∞—á–∏—Å–ª–µ–Ω–æ: <span style="color: #fbbf24; font-weight: bold;">${formatNumber(teacher.salary)}‚ÇΩ</span>
            </div>
            <div style="color: #cbd5e1; font-size:  14px;">
              –ê—Ä–µ–Ω–¥–∞: <span style="color: #f87171; font-weight: bold;">${formatNumber(teacher.hallCost)}‚ÇΩ</span>
            </div>
            <div style="color: #cbd5e1; font-size:  14px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #475569;">
              –ü—Ä–∏–±—ã–ª—å: <span style="color: #4ade80; font-weight:  bold;">${formatNumber(teacher. profit)}‚ÇΩ</span> (${teacher.profitability}%)
            </div>
          </div>
        </div>
        
        <div style="margin-bottom: 20px;">
          <h3 style="color: #cbd5e1; margin-bottom:  15px;">üìã –ó–∞–Ω—è—Ç–∏—è</h3>
          ${sessionsHTML || '<p style="color: #94a3b8;">–ù–µ—Ç –∑–∞–Ω—è—Ç–∏–π</p>'}
        </div>
        
        <div style="display: flex; gap: 10px;">
          <button class="btn" onclick="showEditTeacherModal(${teacher.id})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="btn secondary" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      `;
      
      document.getElementById('detailModal').classList.add('active');
    }
    
    function closeModal() {
      document.getElementById('detailModal').classList.remove('active');
    }
    
    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
    }
    
    function closeQuickAddModal() {
      document.getElementById('quickAddModal').classList.remove('active');
    }
    
    function showQuickAddSessionModal() {
      const today = new Date().toISOString().split('T')[0];
      const teacherOptions = teachersData
        .sort((a, b) => a.name.localeCompare(b.name))
        .map(t => `<option value="${t.id}">${t.name}</option>`)
        .join('');
      
      document.getElementById('quickAddModalBody').innerHTML = `
        <form onsubmit="quickAddSession(event)">
          <div class="form-group">
            <label>–ü–µ–¥–∞–≥–æ–≥ *</label>
            <select id="quickTeacherId" required>
              <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
              ${teacherOptions}
            </select>
          </div>
          
          <div class="form-group">
            <label>–î–∞—Ç–∞ *</label>
            <input type="date" id="quickSessionDate" value="${today}" required>
          </div>
          
          <div class="form-group">
            <label>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ *</label>
            <input type="number" id="quickSessionPeople" min="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä:  15" required>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn secondary" onclick="closeQuickAddModal()">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="btn">‚ö° –î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
        </form>
      `;
      
      document.getElementById('quickAddModal').classList.add('active');
    }
    
    function quickAddSession(event) {
      event.preventDefault();
      
      const teacherId = parseInt(document.getElementById('quickTeacherId').value);
      const date = document.getElementById('quickSessionDate').value;
      const people = parseInt(document.getElementById('quickSessionPeople').value);
      
      const teacher = teachersData.find(t => t.id === teacherId);
      if (!teacher) {
        showAlert('–ü–µ–¥–∞–≥–æ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
        return;
      }
      
      teacher.sessions.push({ date, people });
      teacher.sessions.sort((a, b) => new Date(a.date) - new Date(b.date));
      
      saveData();
      closeQuickAddModal();
      updateDisplay();
      
      const grant = people * GRANT_PER_PERSON;
      showAlert(`‚úÖ –ó–∞–Ω—è—Ç–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ:  ${teacher.name} ‚Ä¢ ${formatNumber(grant)}‚ÇΩ`);
    }
    
    function showAddTeacherModal() {
      const newId = Math.max(...teachersData.map(t => t.id || 0)) + 1;
      showEditTeacherModal(null, {
        id: newId,
        name: "",
        location: "",
        salaryType: "percent",
        salaryValue: 50,
        hallCostPerSession: 0,
        sessions: []
      });
    }
    
    function showEditTeacherModal(teacherId, defaultData = null) {
      const teacher = defaultData || teachersData.find(t => t.id === teacherId);
      if (!teacher) return;
      
      const isNew = ! teacherId;
      
      document.getElementById('editModalTitle').textContent = isNew ? '–î–æ–±–∞–≤–∏—Ç—å –ø–µ–¥–∞–≥–æ–≥–∞' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å:  ' + teacher.name;
      
      const sessionsHTML = teacher.sessions.map((s, idx) => `
        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
          <input type="date" value="${s.date}" onchange="updateSessionField(${teacher.id}, ${idx}, 'date', this.value)" style="flex: 1;">
          <input type="number" value="${s. people}" min="1" placeholder="–õ—é–¥–µ–π" onchange="updateSessionField(${teacher.id}, ${idx}, 'people', parseInt(this.value))" style="width: 80px;">
          <span style="min-width: 80px; text-align: right; color: #fbbf24;">${formatNumber(s.people * GRANT_PER_PERSON)}‚ÇΩ</span>
          <button type="button" class="delete-btn" onclick="deleteSession(${teacher.id}, ${idx})">üóëÔ∏è</button>
        </div>
      `).join('');
      
      document. getElementById('editModalBody').innerHTML = `
        <form onsubmit="saveTeacher(event, ${teacher.id})">
          <div class="form-group">
            <label>–§–ò–û *</label>
            <input type="text" id="teacherName" value="${teacher.name}" required>
          </div>
          
          <div class="form-group">
            <label>–õ–æ–∫–∞—Ü–∏—è *</label>
            <input type="text" id="teacherLocation" value="${teacher.location}" required>
          </div>
          
          <div class="form-group">
            <label>–¢–∏–ø –æ–ø–ª–∞—Ç—ã *</label>
            <select id="teacherSalaryType">
              <option value="percent" ${teacher.salaryType === 'percent' ? 'selected' : ''}>% –æ—Ç –¥–æ—Ö–æ–¥–∞</option>
              <option value="fixed" ${teacher. salaryType === 'fixed' ? 'selected' : ''}>–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>–°—Ç–∞–≤–∫–∞ *</label>
            <input type="number" id="teacherSalaryValue" value="${teacher.salaryValue}" min="0" required>
          </div>
          
          <div class="form-group">
            <label>–ê—Ä–µ–Ω–¥–∞/–∑–∞–Ω—è—Ç–∏–µ (‚ÇΩ)</label>
            <input type="number" id="teacherHallCost" value="${teacher.hallCostPerSession}" min="0">
          </div>
          
          <div class="form-group">
            <label>–ó–∞–Ω—è—Ç–∏—è</label>
            <div id="sessionsList" style="background: #334155; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
              ${sessionsHTML || '<p style="color: #94a3b8; margin:  0;">–ù–µ—Ç –∑–∞–Ω—è—Ç–∏–π</p>'}
            </div>
            <button type="button" class="add-btn" onclick="addNewSession(${teacher.id})">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ</button>
          </div>
          
          <div class="form-actions">
            ${! isNew ? `<button type="button" class="btn danger" style="margin-right: auto;" onclick="deleteTeacher(${teacher.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` : ''}
            <button type="button" class="btn secondary" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </form>
      `;
      
      document.getElementById('editModal').classList.add('active');
    }
    
    function updateSessionField(teacherId, sessionIdx, field, value) {
      const teacher = teachersData.find(t => t.id === teacherId);
      if (teacher && teacher.sessions[sessionIdx]) {
        teacher.sessions[sessionIdx][field] = value;
      }
    }
    
    function deleteSession(teacherId, sessionIdx) {
      if (! confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ?')) return;
      const teacher = teachersData.find(t => t.id === teacherId);
      if (teacher) {
        teacher.sessions.splice(sessionIdx, 1);
        showEditTeacherModal(teacherId);
      }
    }
    
    function addNewSession(teacherId) {
      const teacher = teachersData.find(t => t.id === teacherId);
      if (teacher) {
        const today = new Date().toISOString().split('T')[0];
        teacher.sessions.push({ date: today, people: 10 });
        showEditTeacherModal(teacherId);
      }
    }
    
    function saveTeacher(event, teacherId) {
      event.preventDefault();
      
      const name = document.getElementById('teacherName').value.trim();
      const location = document.getElementById('teacherLocation').value.trim();
      const salaryType = document.getElementById('teacherSalaryType').value;
      const salaryValue = parseFloat(document.getElementById('teacherSalaryValue').value);
      const hallCostPerSession = parseFloat(document.getElementById('teacherHallCost').value) || 0;
      
      if (!name || !location || !salaryValue) {
        showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
        return;
      }
      
      const idx = teachersData.findIndex(t => t.id === teacherId);
      const data = {
        id: teacherId,
        name, location, salaryType, salaryValue, hallCostPerSession,
        sessions: idx >= 0 ? teachersData[idx].sessions : []
      };
      
      if (idx >= 0) {
        teachersData[idx] = data;
      } else {
        teachersData.push(data);
      }
      
      saveData();
      closeEditModal();
      updateDisplay();
      showAlert('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    }
    
    function deleteTeacher(teacherId) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–µ–¥–∞–≥–æ–≥–∞?  –î–∞–Ω–Ω—ã–µ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å! ')) return;
      const idx = teachersData.findIndex(t => t.id === teacherId);
      if (idx >= 0) {
        teachersData.splice(idx, 1);
        saveData();
        closeEditModal();
        closeModal();
        updateDisplay();
      }
    }
    
    function toggleFilters() {
      const bar = document.getElementById('filterBar');
      bar.style.display = bar.style.display === 'none' ? 'flex' : 'none';
    }
    
    function applyFilters() {
      const location = document.getElementById('locationFilter').value;
      const minSessions = parseInt(document.getElementById('minSessions').value) || 0;
      const rows = document.querySelectorAll('#tableBody tr');
      
      rows.forEach(row => {
        const locText = row.querySelector('.teacher-location').textContent;
        const sessions = parseInt(row.cells[2].textContent);
        const locMatch = ! location || locText.includes(location);
        const sessMatch = sessions >= minSessions;
        row.style.display = (locMatch && sessMatch) ? '' : 'none';
      });
    }
    
    function resetFilters() {
      document.getElementById('periodFilter').value = 'current_month';
      document.getElementById('locationFilter').value = '';
      document.getElementById('minSessions').value = '';
      document.getElementById('searchInput').value = '';
      applyPeriodFilter();
    }
    
    function searchTable() {
      const input = document.getElementById('searchInput').value.toLowerCase();
      const rows = document.querySelectorAll('#tableBody tr');
      rows.forEach(row => {
        const name = row.querySelector('.teacher-name').textContent.toLowerCase();
        row.style.display = name.includes(input) ? '' : 'none';
      });
    }
    
    function sortTable(columnIndex) {
      const tbody = document.getElementById('tableBody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const isAsc = ! tbody.dataset[`col${columnIndex}`];
      tbody.dataset[`col${columnIndex}`] = ! isAsc;
      
      rows.sort((a, b) => {
        let aVal = a.cells[columnIndex].textContent.trim().replace(/[‚ÇΩ,%]/g, '').replace(/\s/g, '');
        let bVal = b.cells[columnIndex].textContent.trim().replace(/[‚ÇΩ,%]/g, '').replace(/\s/g, '');
        
        const aNum = parseFloat(aVal);
        const bNum = parseFloat(bVal);
        
        if (! isNaN(aNum) && !isNaN(bNum)) {
          return isAsc ? aNum - bNum : bNum - aNum;
        }
        return isAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
      });
      
      rows.forEach(r => tbody.appendChild(r));
    }
    
    function exportData() {
      const dataStr = JSON.stringify(teachersData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `–ø–µ–¥–∞–≥–æ–≥–∏_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showAlert('üì• JSON —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω');
    }
    
    function exportToCSV() {
      const headers = ['–§–ò–û', '–õ–æ–∫–∞—Ü–∏—è', '–î–Ω–µ–π', '–ó–∞–Ω—è—Ç–∏–π', '–õ—é–¥–µ–π', '–ì—Ä–∞–Ω—Ç', '–ó–∞—Ä–ø–ª–∞—Ç–∞', '–ê—Ä–µ–Ω–¥–∞', '–ü—Ä–∏–±—ã–ª—å', '–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å'];
      const rows = window.teachers.map(t => [
        t.name, t.location, t.uniqueDates, t.sessionsCount, t.totalPeople,
        t.totalIncome, t.salary, t.hallCost, t.profit, t.profitability + '%'
      ]);
      
      const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `–æ—Ç—á—ë—Ç_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showAlert('üìä CSV —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω');
    }
    
    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (! file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const imported = JSON.parse(event.target.result);
            if (! Array.isArray(imported)) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç');
            if (confirm('–ó–∞–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏?')) {
              teachersData = imported;
              saveData();
              updateDisplay();
              showAlert('‚úÖ –ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω');
            }
          } catch (error) {
            showAlert('‚ùå –û—à–∏–±–∫–∞:  ' + error.message, 'error');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }
    
    window.addEventListener('click', (e) => {
      if (e.target.id === 'detailModal') closeModal();
      if (e.target.id === 'editModal') closeEditModal();
      if (e.target.id === 'quickAddModal') closeQuickAddModal();
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    updateDisplay();
  </script>
</body>
</html>
