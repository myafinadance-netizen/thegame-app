import React, { useState, useEffect } from 'react';
import { PlusCircle, Settings, BarChart3, FileDown, Trash2, Edit2, Save, X } from 'lucide-react';

const DanceSchoolTracker = () => {
  const [activeTab, setActiveTab] = useState('input');
  const [records, setRecords] = useState([]);
  const [teachers, setTeachers] = useState([]);
  const [groups, setGroups] = useState([]);
  const [expenses, setExpenses] = useState({
    rent: 50000,
    utilities: 10000,
    water: 2000,
    admin: 30000,
    paymentRate: 280
  });
  
  const [formData, setFormData] = useState({
    group: '',
    date: new Date().toISOString().split('T')[0],
    teacher: '',
    count: ''
  });
  
  const [editingRecord, setEditingRecord] = useState(null);
  const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
  const [filterTeacher, setFilterTeacher] = useState('all');
  const [filterGroup, setFilterGroup] = useState('all');

  // Load data on mount
  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      const recordsData = await window.storage.get('records');
      const teachersData = await window.storage.get('teachers');
      const groupsData = await window.storage.get('groups');
      const expensesData = await window.storage.get('expenses');
      
      if (recordsData) setRecords(JSON.parse(recordsData.value));
      if (teachersData) setTeachers(JSON.parse(teachersData.value));
      if (groupsData) setGroups(JSON.parse(groupsData.value));
      if (expensesData) setExpenses(JSON.parse(expensesData.value));
    } catch (error) {
      // Initialize with default data if no data exists
      const defaultTeachers = [
        { id: 1, name: 'Иванова А.П.', rate: 40 },
        { id: 2, name: 'Петрова М.С.', rate: 40 }
      ];
      const defaultGroups = ['Группа 1', 'Группа 2', 'Группа 3', 'Группа 4'];
      
      setTeachers(defaultTeachers);
      setGroups(defaultGroups);
      await window.storage.set('teachers', JSON.stringify(defaultTeachers));
      await window.storage.set('groups', JSON.stringify(defaultGroups));
      await window.storage.set('expenses', JSON.stringify(expenses));
    }
  };

  const saveData = async () => {
    await window.storage.set('records', JSON.stringify(records));
    await window.storage.set('teachers', JSON.stringify(teachers));
    await window.storage.set('groups', JSON.stringify(groups));
    await window.storage.set('expenses', JSON.stringify(expenses));
  };

  useEffect(() => {
    if (records.length > 0 || teachers.length > 0) {
      saveData();
    }
  }, [records, teachers, groups, expenses]);

  const addRecord = () => {
    if (!formData.group || !formData.date || !formData.teacher || !formData.count) {
      alert('Заполните все поля');
      return;
    }

    const newRecord = {
      id: Date.now(),
      ...formData,
      count: parseInt(formData.count)
    };

    setRecords([...records, newRecord]);
    setFormData({
      group: '',
      date: new Date().toISOString().split('T')[0],
      teacher: '',
      count: ''
    });
  };

  const updateRecord = () => {
    setRecords(records.map(r => r.id === editingRecord.id ? editingRecord : r));
    setEditingRecord(null);
  };

  const deleteRecord = (id) => {
    if (confirm('Удалить запись?')) {
      setRecords(records.filter(r => r.id !== id));
    }
  };

  const getFilteredRecords = () => {
    return records.filter(r => {
      const recordMonth = r.date.slice(0, 7);
      const matchMonth = recordMonth === selectedMonth;
      const matchTeacher = filterTeacher === 'all' || r.teacher === filterTeacher;
      const matchGroup = filterGroup === 'all' || r.group === filterGroup;
      return matchMonth && matchTeacher && matchGroup;
    });
  };

  const calculateStats = () => {
    const filtered = getFilteredRecords();
    const byTeacher = {};

    filtered.forEach(record => {
      if (!byTeacher[record.teacher]) {
        byTeacher[record.teacher] = {
          name: record.teacher,
          days: new Set(),
          totalVisits: 0,
          records: []
        };
      }
      byTeacher[record.teacher].days.add(record.date);
      byTeacher[record.teacher].totalVisits += record.count;
      byTeacher[record.teacher].records.push(record);
    });

    return Object.values(byTeacher).map(t => {
      const teacher = teachers.find(te => te.name === t.name);
      const rate = teacher ? teacher.rate : 40;
      const income = t.totalVisits * expenses.paymentRate;
      const salary = income * (rate / 100);
      
      return {
        ...t,
        workDays: t.days.size,
        income,
        salary,
        rate
      };
    });
  };

  const calculateTotals = () => {
    const stats = calculateStats();
    const totalIncome = stats.reduce((sum, t) => sum + t.income, 0);
    const totalSalaries = stats.reduce((sum, t) => sum + t.salary, 0);
    const totalExpenses = expenses.rent + expenses.utilities + expenses.water + expenses.admin;
    const netProfit = totalIncome - totalSalaries - totalExpenses;

    return { totalIncome, totalSalaries, totalExpenses, netProfit, stats };
  };

  const exportToCSV = () => {
    const stats = calculateStats();
    let csv = 'Педагог,Рабочих дней,Всего посещений,Доход от гос-ва,Ставка %,Зарплата\n';
    
    stats.forEach(s => {
      csv += `${s.name},${s.workDays},${s.totalVisits},${s.income},${s.rate}%,${s.salary}\n`;
    });

    const totals = calculateTotals();
    csv += '\n\nИтоги\n';
    csv += `Общий доход,${totals.totalIncome}\n`;
    csv += `Зарплаты педагогов,${totals.totalSalaries}\n`;
    csv += `Общие расходы,${totals.totalExpenses}\n`;
    csv += `Чистая прибыль,${totals.netProfit}\n`;

    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `отчет_${selectedMonth}.csv`;
    link.click();
  };

  const addTeacher = () => {
    const name = prompt('Имя педагога:');
    const rate = prompt('Ставка % (например, 40):');
    if (name && rate) {
      setTeachers([...teachers, { id: Date.now(), name, rate: parseInt(rate) }]);
    }
  };

  const deleteTeacher = (id) => {
    if (confirm('Удалить педагога?')) {
      setTeachers(teachers.filter(t => t.id !== id));
    }
  };

  const addGroup = () => {
    const name = prompt('Название группы:');
    if (name) {
      setGroups([...groups, name]);
    }
  };

  const deleteGroup = (name) => {
    if (confirm('Удалить группу?')) {
      setGroups(groups.filter(g => g !== name));
    }
  };

  const totals = calculateTotals();

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 p-4">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
          <h1 className="text-3xl font-bold text-purple-700 mb-2">Московское долголетие</h1>
          <p className="text-gray-600">Система учета танцевальной школы</p>
        </div>

        <div className="bg-white rounded-lg shadow-lg mb-6">
          <div className="flex border-b overflow-x-auto">
            <button
              onClick={() => setActiveTab('input')}
              className={`px-6 py-3 font-medium flex items-center gap-2 ${activeTab === 'input' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'}`}
            >
              <PlusCircle size={20} /> Ввод данных
            </button>
            <button
              onClick={() => setActiveTab('reports')}
              className={`px-6 py-3 font-medium flex items-center gap-2 ${activeTab === 'reports' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'}`}
            >
              <BarChart3 size={20} /> Отчеты
            </button>
            <button
              onClick={() => setActiveTab('settings')}
              className={`px-6 py-3 font-medium flex items-center gap-2 ${activeTab === 'settings' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'}`}
            >
              <Settings size={20} /> Настройки
            </button>
          </div>

          <div className="p-6">
            {activeTab === 'input' && (
              <div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Группа</label>
                    <select
                      value={formData.group}
                      onChange={(e) => setFormData({...formData, group: e.target.value})}
                      className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                    >
                      <option value="">Выберите группу</option>
                      {groups.map(g => <option key={g} value={g}>{g}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Дата</label>
                    <input
                      type="date"
                      value={formData.date}
                      onChange={(e) => setFormData({...formData, date: e.target.value})}
                      className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Педагог</label>
                    <select
                      value={formData.teacher}
                      onChange={(e) => setFormData({...formData, teacher: e.target.value})}
                      className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                    >
                      <option value="">Выберите педагога</option>
                      {teachers.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Человек</label>
                    <input
                      type="number"
                      value={formData.count}
                      onChange={(e) => setFormData({...formData, count: e.target.value})}
                      className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                      placeholder="0"
                    />
                  </div>
                </div>
                <button
                  onClick={addRecord}
                  className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2"
                >
                  <PlusCircle size={20} /> Добавить запись
                </button>

                <div className="mt-8">
                  <h3 className="text-xl font-bold mb-4">Записи за текущий месяц</h3>
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="bg-purple-100">
                          <th className="p-3 text-left">Дата</th>
                          <th className="p-3 text-left">Группа</th>
                          <th className="p-3 text-left">Педагог</th>
                          <th className="p-3 text-left">Человек</th>
                          <th className="p-3 text-left">Действия</th>
                        </tr>
                      </thead>
                      <tbody>
                        {records
                          .filter(r => r.date.slice(0, 7) === new Date().toISOString().slice(0, 7))
                          .sort((a, b) => new Date(b.date) - new Date(a.date))
                          .map(record => (
                            editingRecord?.id === record.id ? (
                              <tr key={record.id} className="border-b">
                                <td className="p-3">
                                  <input
                                    type="date"
                                    value={editingRecord.date}
                                    onChange={(e) => setEditingRecord({...editingRecord, date: e.target.value})}
                                    className="p-1 border rounded"
                                  />
                                </td>
                                <td className="p-3">
                                  <select
                                    value={editingRecord.group}
                                    onChange={(e) => setEditingRecord({...editingRecord, group: e.target.value})}
                                    className="p-1 border rounded"
                                  >
                                    {groups.map(g => <option key={g} value={g}>{g}</option>)}
                                  </select>
                                </td>
                                <td className="p-3">
                                  <select
                                    value={editingRecord.teacher}
                                    onChange={(e) => setEditingRecord({...editingRecord, teacher: e.target.value})}
                                    className="p-1 border rounded"
                                  >
                                    {teachers.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                  </select>
                                </td>
                                <td className="p-3">
                                  <input
                                    type="number"
                                    value={editingRecord.count}
                                    onChange={(e) => setEditingRecord({...editingRecord, count: parseInt(e.target.value)})}
                                    className="p-1 border rounded w-20"
                                  />
                                </td>
                                <td className="p-3">
                                  <button onClick={updateRecord} className="text-green-600 hover:text-green-800 mr-2">
                                    <Save size={18} />
                                  </button>
                                  <button onClick={() => setEditingRecord(null)} className="text-gray-600 hover:text-gray-800">
                                    <X size={18} />
                                  </button>
                                </td>
                              </tr>
                            ) : (
                              <tr key={record.id} className="border-b hover:bg-gray-50">
                                <td className="p-3">{new Date(record.date).toLocaleDateString('ru-RU')}</td>
                                <td className="p-3">{record.group}</td>
                                <td className="p-3">{record.teacher}</td>
                                <td className="p-3">{record.count}</td>
                                <td className="p-3">
                                  <button onClick={() => setEditingRecord(record)} className="text-blue-600 hover:text-blue-800 mr-2">
                                    <Edit2 size={18} />
                                  </button>
                                  <button onClick={() => deleteRecord(record.id)} className="text-red-600 hover:text-red-800">
                                    <Trash2 size={18} />
                                  </button>
                                </td>
                              </tr>
                            )
                          ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'reports' && (
              <div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Месяц</label>
                    <input
                      type="month"
                      value={selectedMonth}
                      onChange={(e) => setSelectedMonth(e.target.value)}
                      className="w-full p-2 border border-gray-300 rounded-lg"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Педагог</label>
                    <select
                      value={filterTeacher}
                      onChange={(e) => setFilterTeacher(e.target.value)}
                      className="w-full p-2 border border-gray-300 rounded-lg"
                    >
                      <option value="all">Все педагоги</option>
                      {teachers.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Группа</label>
                    <select
                      value={filterGroup}
                      onChange={(e) => setFilterGroup(e.target.value)}
                      className="w-full p-2 border border-gray-300 rounded-lg"
                    >
                      <option value="all">Все группы</option>
                      {groups.map(g => <option key={g} value={g}>{g}</option>)}
                    </select>
                  </div>
                </div>

                <button
                  onClick={exportToCSV}
                  className="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2 mb-6"
                >
                  <FileDown size={20} /> Экспорт в CSV
                </button>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                  <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-lg">
                    <p className="text-sm opacity-90 mb-1">Общий доход</p>
                    <p className="text-3xl font-bold">{totals.totalIncome.toLocaleString('ru-RU')} ₽</p>
                  </div>
                  <div className="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-lg">
                    <p className="text-sm opacity-90 mb-1">Зарплаты</p>
                    <p className="text-3xl font-bold">{totals.totalSalaries.toLocaleString('ru-RU')} ₽</p>
                  </div>
                  <div className="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6 rounded-lg">
                    <p className="text-sm opacity-90 mb-1">Расходы</p>
                    <p className="text-3xl font-bold">{totals.totalExpenses.toLocaleString('ru-RU')} ₽</p>
                  </div>
                  <div className="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-lg">
                    <p className="text-sm opacity-90 mb-1">Чистая прибыль</p>
                    <p className="text-3xl font-bold">{totals.netProfit.toLocaleString('ru-RU')} ₽</p>
                  </div>
                </div>

                <h3 className="text-xl font-bold mb-4">Статистика по педагогам</h3>
                <div className="overflow-x-auto">
                  <table className="w-full border-collapse">
                    <thead>
                      <tr className="bg-purple-100">
                        <th className="p-3 text-left">Педагог</th>
                        <th className="p-3 text-left">Рабочих дней</th>
                        <th className="p-3 text-left">Посещений</th>
                        <th className="p-3 text-left">Доход</th>
                        <th className="p-3 text-left">Ставка</th>
                        <th className="p-3 text-left">Зарплата</th>
                      </tr>
                    </thead>
                    <tbody>
                      {totals.stats.map((stat, idx) => (
                        <tr key={idx} className="border-b hover:bg-gray-50">
                          <td className="p-3 font-medium">{stat.name}</td>
                          <td className="p-3">{stat.workDays}</td>
                          <td className="p-3">{stat.totalVisits}</td>
                          <td className="p-3">{stat.income.toLocaleString('ru-RU')} ₽</td>
                          <td className="p-3">{stat.rate}%</td>
                          <td className="p-3 font-semibold text-green-600">{stat.salary.toLocaleString('ru-RU')} ₽</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {activeTab === 'settings' && (
              <div>
                <div className="mb-8">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-xl font-bold">Педагоги</h3>
                    <button
                      onClick={addTeacher}
                      className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2"
                    >
                      <PlusCircle size={18} /> Добавить
                    </button>
                  </div>
                  <div className="space-y-2">
                    {teachers.map(t => (
                      <div key={t.id} className="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                        <div>
                          <span className="font-medium">{t.name}</span>
                          <span className="text-gray-600 ml-4">Ставка: {t.rate}%</span>
                        </div>
                        <button onClick={() => deleteTeacher(t.id)} className="text-red-600 hover:text-red-800">
                          <Trash2 size={18} />
                        </button>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="mb-8">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-xl font-bold">Группы</h3>
                    <button
                      onClick={addGroup}
                      className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2"
                    >
                      <PlusCircle size={18} /> Добавить
                    </button>
                  </div>
                  <div className="space-y-2">
                    {groups.map(g => (
                      <div key={g} className="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                        <span className="font-medium">{g}</span>
                        <button onClick={() => deleteGroup(g)} className="text-red-600 hover:text-red-800">
                          <Trash2 size={18} />
                        </button>
                      </div>
                    ))}
                  </div>
                </div>

                <div>
                  <h3 className="text-xl font-bold mb-4">Расходы</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Аренда зала (₽)</label>
                      <input
                        type="number"
                        value={expenses.rent}
                        onChange={(e) => setExpenses({...expenses, rent: parseInt(e.target.value)})}
                        className="w-full p-2 border border-gray-300 rounded-lg"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Коммунальные услуги (₽)</label>
                      <input
                        type="number"
                        value={expenses.utilities}
                        onChange={(e) => setExpenses({...expenses, utilities: parseInt(e.target.value)})}
                        className="w-full p-2 border border-gray-300 rounded-lg"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Вода/кулер (₽)</label>
                      <input
                        type="number"
                        value={expenses.water}
                        onChange={(e) => setExpenses({...expenses, water: parseInt(e.target.value)})}
                        className="w-full p-2 border border-gray-300 rounded-lg"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Зарплата администратора (₽)</label>
                      <input
                        type="number"
                        value={expenses.admin}
                        onChange={(e) => setExpenses({...expenses, admin: parseInt(e.target.value)})}
                        className="w-full p-2 border border-gray-300 rounded-lg"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Ставка от государства (₽)</label>
                      <input
                        type="number"
                        value={expenses.paymentRate}
                        onChange={(e) => setExpenses({...expenses, paymentRate: parseInt(e.target.value)})}
                        className="w-full p-2 border border-gray-300 rounded-lg"
                      />
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

export default DanceSchoolTracker;
