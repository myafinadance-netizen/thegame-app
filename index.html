<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TheGame ‚Äî –£—á—ë—Ç –¥–æ—Ö–æ–¥–æ–≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;
const tg = window.Telegram?.WebApp;

// Helpers
const fmt = n => new Intl.NumberFormat('ru-RU').format(Number(n || 0));

// Default hall expenses
const locationDefaults = { "–ë—É–¥–µ–Ω–Ω–æ–≥–æ":0, "–ß–µ—Ä–∫–∏–∑–æ–≤—Å–∫–∞—è":0, "–ü–∞—Ä–∫":0 };

// Modal component
function Modal({show, title, form, setForm, onSave, onClose}) {
  if(!show) return null;
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
      <div className="bg-slate-800 p-6 rounded w-full max-w-lg">
        <h3 className="text-lg font-bold mb-4">{title}</h3>
        <div className="space-y-2 max-h-[70vh] overflow-y-auto">
          {Object.keys(form).map((key)=>(
            <div key={key} className="flex flex-col">
              <label className="text-sm text-slate-400">{key}</label>
              <input 
                type="text" 
                value={form[key]} 
                onChange={e=>setForm({...form,[key]:e.target.value})}
                className="text-black px-2 py-1 rounded"
              />
            </div>
          ))}
        </div>
        <div className="mt-4 flex justify-end gap-2">
          <button onClick={onClose} className="px-3 py-1 bg-slate-600 rounded">–û—Ç–º–µ–Ω–∞</button>
          <button onClick={onSave} className="px-3 py-1 bg-green-600 rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  );
}

// Main App
function App() {
  const [activeTab,setActiveTab] = useState('monthlyReport');
  const [loading,setLoading] = useState(true);

  const [dolgo,setDolgo] = useState([]);
  const [individuals,setIndividuals] = useState([]);
  const [rentals,setRentals] = useState([]);
  const [expenses,setExpenses] = useState([]);
  const [passive,setPassive] = useState([]);
  const [students,setStudents] = useState([]);
  const [monthlyArchive,setMonthlyArchive] = useState([]);
  const [teachersSalary,setTeachersSalary] = useState([]);

  const [showModal,setShowModal] = useState(false);
  const [modalType,setModalType] = useState(null);
  const [editingIndex,setEditingIndex] = useState(null);
  const [form,setForm] = useState({});

  // Load/save
  const loadKey = async (key, fallback) => {
    try{
      if(tg?.CloudStorage){
        return await new Promise(resolve=>{
          tg.CloudStorage.getItem(key,(err,val)=>{
            if(!err && val){ try{resolve(JSON.parse(val))}catch{resolve(fallback)} } else resolve(fallback);
          });
        });
      } else {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      }
    }catch{return fallback;}
  };
  const saveKey = async (key,data) => {
    try{
      const val = JSON.stringify(data);
      if(tg?.CloudStorage) tg.CloudStorage.setItem(key,val);
      localStorage.setItem(key,val);
    }catch(e){console.error('saveKey',e);}
  };

  useEffect(()=>{
    (async()=>{
      const [_dolgo,_ind,_rent,_exp,_pass,_stud,_arch,_teach] = await Promise.all([
        loadKey('dolgo',[]),
        loadKey('individuals',[]),
        loadKey('rentals',[]),
        loadKey('expenses',[]),
        loadKey('passive',[]),
        loadKey('students',[]),
        loadKey('monthlyArchive',[]),
        loadKey('teachersSalary',[])
      ]);
      setDolgo(_dolgo); setIndividuals(_ind); setRentals(_rent); setExpenses(_exp);
      setPassive(_pass); setStudents(_stud); setMonthlyArchive(_arch); setTeachersSalary(_teach);
      setLoading(false);
      try{tg?.expand && tg.expand()}catch{}
    })();
  },[]);

  useEffect(()=>{if(!loading) saveKey('dolgo',dolgo)},[dolgo]);
  useEffect(()=>{if(!loading) saveKey('individuals',individuals)},[individuals]);
  useEffect(()=>{if(!loading) saveKey('rentals',rentals)},[rentals]);
  useEffect(()=>{if(!loading) saveKey('expenses',expenses)},[expenses]);
  useEffect(()=>{if(!loading) saveKey('passive',passive)},[passive]);
  useEffect(()=>{if(!loading) saveKey('students',students)},[students]);
  useEffect(()=>{if(!loading) saveKey('monthlyArchive',monthlyArchive)},[monthlyArchive]);
  useEffect(()=>{if(!loading) saveKey('teachersSalary',teachersSalary)},[teachersSalary]);

  // Teacher expense calc
  const calcTeacherExpense = (income,rate)=>{
    if(!rate) return 0;
    if(rate==='50%') return Math.round(income*0.5);
    if(rate==='100%') return Math.round(income*1);
    const n=parseFloat(rate);
    return Number.isFinite(n)?n:0;
  };

  // Totals
  const totalDolgoIncome = dolgo.reduce((s,r)=>s+Number(r.income||0),0);
  const totalDolgoTeacherExpense = dolgo.reduce((s,r)=>s+calcTeacherExpense(Number(r.income||0),r.rate),0);
  const totalDolgoHallExpense = dolgo.reduce((s,r)=>s+Number(r.hallExpense||0),0);
  const totalDolgoProfit = totalDolgoIncome - totalDolgoTeacherExpense - totalDolgoHallExpense;

  const totalIndividualIncome = individuals.reduce((s,r)=>s+Number(r.amount||0),0);
  const totalRentalsIncome = rentals.reduce((s,r)=>s+Number(r.amount||0),0);
  const totalPassiveIncome = passive.reduce((s,r)=>s+Number(r.monthly||0),0);
  const totalExpenses = expenses.reduce((s,r)=>s+Number(r.amount||0),0);

  const monthlyReport=[
    {category:'–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ',income:totalDolgoIncome,expense:totalDolgoTeacherExpense+totalDolgoHallExpense,profit:totalDolgoProfit},
    {category:'–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —É—Ä–æ–∫–∏',income:totalIndividualIncome,expense:0,profit:totalIndividualIncome},
    {category:'–ê—Ä–µ–Ω–¥–∞ –∑–∞–ª–∞',income:totalRentalsIncome,expense:0,profit:totalRentalsIncome},
    {category:'–ü–∞—Å—Å–∏–≤–Ω—ã–π',income:totalPassiveIncome,expense:0,profit:totalPassiveIncome},
    {category:'–†–∞—Å—Ö–æ–¥—ã',income:0,expense:totalExpenses,profit:-totalExpenses},
  ];
  const totalReportIncome = monthlyReport.reduce((s,r)=>s+r.income,0);
  const totalReportExpense = monthlyReport.reduce((s,r)=>s+r.expense,0);
  const totalReportProfit = monthlyReport.reduce((s,r)=>s+r.profit,0);

  // Progress to 1M
  const baseStart=385000;
  const currentTotal=baseStart+totalReportProfit;
  const goal=1000000;
  const progressPercent=Math.round((currentTotal/goal)*100);

  // Modal handlers
  const openModal=(type,idx=null)=>{
    setModalType(type); setEditingIndex(idx);
    let data={};
    if(idx!==null){
      const arrMap={dolgo,dolgo,individual:individuals,rental:rentals,expense:expenses,passive:passive,student:students,archive:monthlyArchive,teachersSalary:teachersSalary};
      data={...arrMap[type][idx]};
    }
    setForm(data); setShowModal(true);
  };
  const closeModal=()=>{setShowModal(false);setForm({});setEditingIndex(null);setModalType(null)};

  const saveModal=()=>{
    const setMap={dolgo:setDolgo,individual:setIndividuals,rental:setRentals,expense:setExpenses,passive:setPassive,student:setStudents,archive:setMonthlyArchive,teachersSalary:setTeachersSalary};
    const arrMap={dolgo,dolgo,individual:individuals,rental:rentals,expense:expenses,passive:passive,student:students,archive:monthlyArchive,teachersSalary:teachersSalary};
    let row=form;
    if(modalType==='dolgo'){ row.people=Number(form.people||0); row.income=row.people*280; row.hallExpense=Number(form.hallExpense||locationDefaults[form.location]||0) }
    if(modalType==='individual') row.amount=Number(form.amount||0);
    if(modalType==='rental') row.amount=Number(form.amount||0);
    if(modalType==='expense') row.amount=Number(form.amount||0);
    if(modalType==='passive') row.monthly=Number(form.monthly||0);
    if(modalType==='archive') row.profit=(Number(form.groupIncome||0)+Number(form.individualIncome||0)+Number(form.passiveIncome||0)-Number(form.expenses||0));
    if(modalType==='teachersSalary') row.salary=Number(form.salary||0);
    const copy=[...arrMap[modalType]];
    if(editingIndex!==null) copy[editingIndex]=row;
    else copy.push(row);
    setMap[modalType](copy);
    closeModal();
  };

  const deleteItem=(type,idx)=>{
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
    const setMap={dolgo:setDolgo,individual:setIndividuals,rental:setRentals,expense:setExpenses,passive:setPassive,student:setStudents,archive:setMonthlyArchive,teachersSalary:setTeachersSalary};
    const arrMap={dolgo,dolgo,individual:individuals,rental:rentals,expense:expenses,passive:passive,student:students,archive:monthlyArchive,teachersSalary:teachersSalary};
    setMap[type](arrMap[type].filter((_,i)=>i!==idx));
  };

  const exportCSV=()=>{
    let csv='–ö–∞—Ç–µ–≥–æ—Ä–∏—è,–î–æ—Ö–æ–¥,–†–∞—Å—Ö–æ–¥,–ü—Ä–∏–±—ã–ª—å\n';
    monthlyReport.forEach(r=>{csv+=`${r.category},${r.income},${r.expense},${r.profit}\n`});
    csv+=`\n–ò–¢–û–ì–û,${totalReportIncome},${totalReportExpense},${totalReportProfit}\n`;
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='thegame_report.csv'; a.click(); URL.revokeObjectURL(url);
  };

  if(loading) return <div className="min-h-screen flex justify-center items-center">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;

  return (
    <div className="min-h-screen p-4 max-w-7xl mx-auto">
      <header className="mb-4">
        <h1 className="text-2xl font-bold mb-2">üí∞ TheGame ‚Äî –£—á—ë—Ç –¥–æ—Ö–æ–¥–æ–≤</h1>
        <nav className="flex flex-wrap gap-2 mb-4">
          {['monthlyReport','dolgo','individuals','rentals','expenses','passive','students','analytics','archive','summary','teachersSalary'].map(t=>{
            const labels={
              monthlyReport:'–ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç',dolgo:'–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ',
              individuals:'–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —É—Ä–æ–∫–∏',rentals:'–ê—Ä–µ–Ω–¥–∞ –∑–∞–ª–∞',
              expenses:'–†–∞—Å—Ö–æ–¥—ã',passive:'–ü–∞—Å—Å–∏–≤–Ω—ã–π',students:'–ë–∞–∑–∞ —É—á–µ–Ω–∏–∫–æ–≤',
              analytics:'–ê–Ω–∞–ª–∏—Ç–∏–∫–∞',archive:'–ü–æ –º–µ—Å—è—Ü–∞–º',summary:'–°–≤–æ–¥–∫–∞',
              teachersSalary:'–ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤'
            };
            return <button key={t} onClick={()=>setActiveTab(t)} className={`px-3 py-1 rounded ${activeTab===t?'bg-blue-600':'bg-slate-800 hover:bg-slate-700 text-slate-300'}`}>{labels[t]}</button>
          })}
        </nav>
      </header>

      <main className="bg-slate-800 p-4 rounded border border-slate-700">
        {activeTab==='monthlyReport' && (
          <section>
            <div className="flex justify-between mb-4">
              <h2 className="text-lg font-bold">üìÖ –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç</h2>
              <button onClick={exportCSV} className="px-3 py-2 bg-green-600 rounded">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="text-slate-300 border-b border-slate-700">
                  <tr>
                    <th className="py-2 px-2 text-left">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th className="py-2 px-2 text-right">–î–æ—Ö–æ–¥</th>
                    <th className="py-2 px-2 text-right">–†–∞—Å—Ö–æ–¥</th>
                    <th className="py-2 px-2 text-right">–ü—Ä–∏–±—ã–ª—å</th>
                  </tr>
                </thead>
                <tbody>
                  {monthlyReport.map((r,i)=>(
                    <tr key={i} className="border-b border-slate-700/40">
                      <td className="py-2 px-2">{r.category}</td>
                      <td className="py-2 px-2 text-right text-green-400">{fmt(r.income)}‚ÇΩ</td>
                      <td className="py-2 px-2 text-right text-red-400">-{fmt(r.expense)}‚ÇΩ</td>
                      <td className="py-2 px-2 text-right text-blue-400 font-bold">{fmt(r.profit)}‚ÇΩ</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </section>
        )}

        {/* –ó–¥–µ—Å—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Å–µ–∫—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –≤–∫–ª–∞–¥–æ–∫: dolgo, individuals, rentals, expenses, passive, students, analytics, archive, summary, teachersSalary */}

      </main>

      <Modal 
        show={showModal} 
        title={modalType ? modalType.toUpperCase() : ''} 
        form={form} 
        setForm={setForm} 
        onSave={saveModal} 
        onClose={closeModal} 
      />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html
