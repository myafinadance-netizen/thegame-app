<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Финансовый бот</title>
<style>
:root{--brand:#2563eb;--muted:#6b7280}
*{box-sizing:border-box}
body{font-family:system-ui;-apple-system,Segoe UI,Roboto,Arial; margin:0; background:#f3f4f6; color:#111}
header{background:var(--brand); color:#fff; padding:14px 16px; display:flex; gap:12px; align-items:center}
header h1{font-size:16px; margin:0; flex:1}
main{max-width:1100px; margin:12px auto; padding:12px; background:#fff; border-radius:10px}
nav.tabs{display:flex; gap:8px; margin-bottom:10px; overflow:auto; padding-bottom:6px}
.tab{padding:8px 12px; border-radius:8px; background:#eef2ff; color:var(--brand); font-weight:600; cursor:pointer}
.tab.active{background:var(--brand); color:#fff}
.toolbar{display:flex; gap:8px; align-items:center;margin-bottom:10px; flex-wrap:wrap}
.btn{background:var(--brand); color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer}
.btn.ghost{background:#fff; color:var(--brand); border:1px solid var(--brand)}
table{width:100%; border-collapse:collapse; margin-top:8px; font-size:14px}
th,td{padding:8px; border:1px solid #e6edf3; text-align:left}
th{background:#f8fafc}
.card{background:#f8fafc; padding:10px; border-radius:8px;border:1px solid #eef2ff;min-width:140px}
.card-row{display:flex; gap:8px; margin:8px 0; flex-wrap:wrap}
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:999}
.modal .box{background:#fff;padding:14px;border-radius:8px;width:720px;max-width:95%;max-height:86%;overflow:auto}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef9;margin-bottom:8px}
</style>
</head>
<body>
<header><h1>Финансовый бот</h1></header>

<main id="app">
<nav class="tabs"></nav>
<div class="toolbar"></div>
<div id="content"></div>
</main>

<div id="modal-root"></div>

<script>
/*** DATA ***/
let state = JSON.parse(localStorage.getItem('finData_v2')||'{}');
if(!state.monthlyData) state.monthlyData=[];
if(!state.locationsMD) state.locationsMD = {
 "Буденного":{rent:0,rate:0,type:"%"},
 "Черкизовская":{rent:0,rate:0,type:"%"},
 "Парк":{rent:0,rate:0,type:"фикс"},
};
const TABS=["Месячный отчёт","Аналитика","Настройки"];

function save(){localStorage.setItem('finData_v2',JSON.stringify(state));}

function renderTabs(){
 const nav=document.querySelector(".tabs");
 nav.innerHTML="";
 TABS.forEach(t=>{
   const b=document.createElement("div");
   b.className="tab"+(t===active?" active":"");
   b.textContent=t;
   b.onclick=()=>{active=t;saveActive();render();}
   nav.appendChild(b);
 })
}

let active = localStorage.getItem('activeTab2')||"Месячный отчёт";
function saveActive(){localStorage.setItem('activeTab2',active);}

function render(){
 renderTabs();
 const toolbar=document.querySelector(".toolbar");
 const content=document.getElementById("content");
 toolbar.innerHTML=""; content.innerHTML="";
 if(active==="Месячный отчёт") renderMonthly(toolbar,content);
 if(active==="Аналитика") renderAnalytics(content);
 if(active==="Настройки") renderSettings(content);
}

function addBtn(text,cb){
 const b=document.createElement("button");
 b.className="btn";
 b.textContent=text;
 b.onclick=cb;
 return b;
}

function modal(inner){
 const root=document.getElementById("modal-root");
 root.innerHTML="";
 const m=document.createElement("div");
 m.className="modal";
 const box=document.createElement("div");
 box.className="box";
 box.appendChild(inner);
 m.appendChild(box);
 root.appendChild(m);
 m.onclick=e=>{if(e.target===m) root.innerHTML="";}
}

function closeModal(){document.getElementById("modal-root").innerHTML="";}

/*** MONTHLY ***/
function renderMonthly(tb,content){
 tb.appendChild(addBtn("Добавить",()=>modal(monthForm())));

 const tbl=document.createElement("table");
 tbl.innerHTML=`<thead><tr>
 <th>Дата</th><th>Категория</th><th>Локация</th>
 <th>Люди</th><th>Доход</th><th>Аренда</th>
 <th>Педагог</th><th>Прочие</th><th>Прибыль</th>
 </tr></thead><tbody></tbody>`;
 const body=tbl.querySelector("tbody");

 state.monthlyData.slice().reverse().forEach(r=>{
   const tr=document.createElement("tr");
   tr.innerHTML=`
   <td>${r.date}</td>
   <td>${r.category}</td>
   <td>${r.location||""}</td>
   <td>${r.people||0}</td>
   <td>${fmt(r.income)}</td>
   <td>${fmt(r.hall)}</td>
   <td>${fmt(r.teacher)}</td>
   <td>${fmt(r.expense)}</td>
   <td>${fmt(r.profit)}</td>`;
   body.appendChild(tr);
 });
 content.appendChild(tbl);
}

function monthForm(){
 const box=document.createElement("div");
 box.innerHTML="<h3>Добавить</h3>";

 const date=i("date"),cat=s("category",["Московское долголетие","Индивидуальные","Аренда зала","Пассив","Другое"]);
 const loc=s("loc",Object.keys(state.locationsMD));
 const people=i("people","number");
 const expense=i("expense","number");
 const hall=i("hall","number");
 const rate=i("rate","number");
 const rateType=s("rateType",["%","фикс"]);

 const wrap=document.createElement("div");
 wrap.append(label("Дата"),date,label("Категория"),cat);

 const mdWrap=document.createElement("div");

 cat.onchange=()=>mdWrap.style.display=cat.value==="Московское долголетие"?"block":"none";
 cat.onchange();

 mdWrap.append(
   label("Локация"),loc,
   label("Ставка педагога"),rate,
   label("Тип ставки"),rateType,
   label("Аренда зала"),hall,
 );

 wrap.append(mdWrap,label("Кол-во человек"),people,label("Прочие расходы"),expense);

 const saveBtn=addBtn("Сохранить",()=>{
   let income=0,teacher=0,h=Number(hall.value||0);
   const p=Number(people.value||0);
   if(cat.value==="Московское долголетие"){
     income=p*280;
     const conf = state.locationsMD[loc.value] || {};
     // auto
     if(!hall.value) h = Number(conf.rent||0);
     if(!rate.value) rate.value = conf.rate||0;
     if(!rateType.value) rateType.value = conf.type||"%";
     if(rateType.value==="%") teacher = income * (Number(rate.value)/100);
     else teacher = Number(rate.value||0);
   }else{
     income=0;
   }

   const rec={
     date:date.value,
     category:cat.value,
     location:cat.value==="Московское долголетие"?loc.value:"",
     people:p,
     income,
     hall:h,
     teacher,
     expense:Number(expense.value||0),
   };
   rec.profit = rec.income - rec.hall - rec.teacher - rec.expense;
   state.monthlyData.push(rec);
   save(); closeModal(); render();
 });

 wrap.append(saveBtn);
 box.appendChild(wrap);
 return box;
}
/*** ANALYTICS ***/
function renderAnalytics(content){
 let income=0,profit=0,hall=0,teacher=0,ex=0;
 state.monthlyData.forEach(r=>{
  income+=r.income;
  hall+=r.hall;
  teacher+=r.teacher;
  ex+=r.expense;
  profit+=r.profit;
 });

 const tbl=document.createElement("table");
 tbl.innerHTML=`<tr><td>Доход</td><td>${fmt(income)}</td></tr>
 <tr><td>Аренда</td><td>${fmt(hall)}</td></tr>
 <tr><td>Педагоги</td><td>${fmt(teacher)}</td></tr>
 <tr><td>Прочие</td><td>${fmt(ex)}</td></tr>
 <tr><td>Прибыль</td><td>${fmt(profit)}</td></tr>`;
 content.append(tbl);
}

/*** SETTINGS ***/
function renderSettings(content){
 const box=document.createElement("div");
 box.innerHTML="<h3>Настройки локаций (МД)</h3>";

 const tbl=document.createElement("table");
 tbl.innerHTML=`<thead><tr>
 <th>Локация</th><th>Аренда</th><th>Ставка</th><th>Тип</th><th></th>
 </tr></thead><tbody></tbody>`;
 const body=tbl.querySelector("tbody");

 Object.keys(state.locationsMD).forEach(name=>{
  const r=state.locationsMD[name];
  const tr=document.createElement("tr");
  tr.innerHTML=`<td>${name}</td>
    <td><input value="${r.rent}" data-f="rent" /></td>
    <td><input value="${r.rate}" data-f="rate" /></td>
    <td>
      <select data-f="type">
       <option ${r.type=="%"?"selected":""}>%</option>
       <option ${r.type=="фикс"?"selected":""}>фикс</option>
      </select>
    </td>
    <td><button data-save="${name}" class="btn">Сохранить</button></td>`;
  body.appendChild(tr);
 });

 tbl.onclick=e=>{
  const name=e.target.getAttribute("data-save");
  if(name){
    const tr=e.target.closest("tr");
    const inputs=tr.querySelectorAll("[data-f]");
    let obj={};
    inputs.forEach(x=>{obj[x.dataset.f]=x.value});
    obj.rent=Number(obj.rent||0);
    obj.rate=Number(obj.rate||0);
    state.locationsMD[name]=obj;
    save(); render();
  }
 };

 box.appendChild(tbl);

 // add new
 const add=document.createElement("div");
 add.innerHTML="<h4>Новая локация</h4>";
 const name=i("newname");
 const rent=i("newrent","number");
 const rate=i("newrate","number");
 const type=s("newtype",["%","фикс"]);
 const saveBtn=addBtn("Добавить",()=>{
  if(!name.value.trim()) return;
  state.locationsMD[name.value.trim()]={rent:Number(rent.value),rate:Number(rate.value),type:type.value};
  save(); render();
 });
 add.append(label("Название"),name,label("Аренда"),rent,label("Ставка"),rate,label("Тип"),type,saveBtn);
 box.appendChild(add);

 content.append(box);
}

/*** utils ***/
function label(t){const e=document.createElement("label");e.textContent=t;return e;}
function i(name,type="text"){const e=document.createElement("input");e.name=name;if(type)e.type=type;return e;}
function s(name,arr){const e=document.createElement("select");arr.forEach(v=>{const o=document.createElement("option");o.textContent=v;e.append(o);});return e;}
function fmt(n){return (Number(n)||0).toLocaleString("ru-RU");}

render();
</script>
</body>
</html>
