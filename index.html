import React, { useState } from 'react';
import { Upload, Users, DollarSign, FileText, Trash2, Plus, Download } from 'lucide-react';
import * as mammoth from 'mammoth';

export default function TeacherSalaryApp() {
  const [teachers, setTeachers] = useState([]);
  const [sessions, setSessions] = useState([]);
  const [loading, setLoading] = useState(false);

  const handleFileUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    setLoading(true);
    try {
      const arrayBuffer = await file.arrayBuffer();
      const result = await mammoth.extractRawText({ arrayBuffer });
      const text = result.value;
      
      parseDocxReport(text);
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + error.message);
    }
    setLoading(false);
    e.target.value = '';
  };

  const parseDocxReport = (text) => {
    // –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ—Ç—á–µ—Ç–∞
    const lines = text.split('\n').filter(line => line.trim());
    
    const newSessions = [];
    let currentDate = '';
    let currentTeacher = '';
    
    lines.forEach(line => {
      // –ü–æ–∏—Å–∫ –¥–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "15.01.2025")
      const dateMatch = line.match(/(\d{2}\.\d{2}\.\d{4})/);
      if (dateMatch) {
        currentDate = dateMatch[1];
      }
      
      // –ü–æ–∏—Å–∫ –∏–º–µ–Ω–∏ –ø–µ–¥–∞–≥–æ–≥–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
      // –ü—Ä–∏–º–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: "–ò–≤–∞–Ω–æ–≤ –ò.–ò. - 15 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
      const teacherMatch = line.match(/([–ê-–Ø–Å][–∞-—è—ë]+\s+[–ê-–Ø–Å]\.[–ê-–Ø–Å]\.)\s*[-‚Äì]\s*(\d+)/);
      if (teacherMatch && currentDate) {
        currentTeacher = teacherMatch[1];
        const participants = parseInt(teacherMatch[2]);
        
        newSessions.push({
          id: Date.now() + Math.random(),
          date: currentDate,
          teacher: currentTeacher,
          participants: participants,
          hours: 1, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 —á–∞—Å
          rate: 500 // –°—Ç–∞–≤–∫–∞ –∑–∞ —á–∞—Å
        });
      }
    });

    if (newSessions.length > 0) {
      setSessions(prev => [...prev, ...newSessions]);
      updateTeachers(newSessions);
      alert(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${newSessions.length} –∑–∞–Ω—è—Ç–∏–π`);
    } else {
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é.');
    }
  };

  const updateTeachers = (newSessions) => {
    const teacherMap = {};
    
    [...sessions, ...newSessions].forEach(session => {
      if (!teacherMap[session.teacher]) {
        teacherMap[session.teacher] = {
          name: session.teacher,
          totalSessions: 0,
          totalParticipants: 0,
          totalHours: 0,
          totalSalary: 0
        };
      }
      
      teacherMap[session.teacher].totalSessions += 1;
      teacherMap[session.teacher].totalParticipants += session.participants;
      teacherMap[session.teacher].totalHours += session.hours;
      teacherMap[session.teacher].totalSalary += session.hours * session.rate;
    });

    setTeachers(Object.values(teacherMap));
  };

  const addManualSession = () => {
    const newSession = {
      id: Date.now(),
      date: new Date().toLocaleDateString('ru-RU'),
      teacher: '–ù–æ–≤—ã–π –ø–µ–¥–∞–≥–æ–≥',
      participants: 10,
      hours: 1,
      rate: 500
    };
    setSessions(prev => [...prev, newSession]);
  };

  const updateSession = (id, field, value) => {
    setSessions(prev => {
      const updated = prev.map(s => 
        s.id === id ? { ...s, [field]: field === 'participants' || field === 'hours' || field === 'rate' ? parseFloat(value) || 0 : value } : s
      );
      updateTeachersFromSessions(updated);
      return updated;
    });
  };

  const updateTeachersFromSessions = (sessionsList) => {
    const teacherMap = {};
    
    sessionsList.forEach(session => {
      if (!teacherMap[session.teacher]) {
        teacherMap[session.teacher] = {
          name: session.teacher,
          totalSessions: 0,
          totalParticipants: 0,
          totalHours: 0,
          totalSalary: 0
        };
      }
      
      teacherMap[session.teacher].totalSessions += 1;
      teacherMap[session.teacher].totalParticipants += session.participants;
      teacherMap[session.teacher].totalHours += session.hours;
      teacherMap[session.teacher].totalSalary += session.hours * session.rate;
    });

    setTeachers(Object.values(teacherMap));
  };

  const deleteSession = (id) => {
    setSessions(prev => {
      const updated = prev.filter(s => s.id !== id);
      updateTeachersFromSessions(updated);
      return updated;
    });
  };

  const exportReport = () => {
    let report = '–û–¢–ß–ï–¢ –ü–û –ó–ê–†–ü–õ–ê–¢–ï –ü–ï–î–ê–ì–û–ì–û–í\n';
    report += '–ü—Ä–æ–≥—Ä–∞–º–º–∞ "–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ"\n\n';
    report += '='.repeat(80) + '\n\n';
    
    teachers.forEach(teacher => {
      report += `–ü–µ–¥–∞–≥–æ–≥: ${teacher.name}\n`;
      report += `–ü—Ä–æ–≤–µ–¥–µ–Ω–æ –∑–∞–Ω—è—Ç–∏–π: ${teacher.totalSessions}\n`;
      report += `–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${teacher.totalParticipants}\n`;
      report += `–ß–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã: ${teacher.totalHours}\n`;
      report += `–ö –≤—ã–ø–ª–∞—Ç–µ: ${teacher.totalSalary.toFixed(2)} ‚ÇΩ\n`;
      report += '-'.repeat(80) + '\n\n';
    });
    
    report += `–ò–¢–û–ì–û –ö –í–´–ü–õ–ê–¢–ï: ${teachers.reduce((sum, t) => sum + t.totalSalary, 0).toFixed(2)} ‚ÇΩ\n`;
    
    const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `–∑–∞—Ä–ø–ª–∞—Ç—ã_${new Date().toLocaleDateString('ru-RU')}.txt`;
    a.click();
  };

  const totalSalary = teachers.reduce((sum, t) => sum + t.totalSalary, 0);
  const activePedagogs = teachers.length;
  const totalParticipants = teachers.reduce((sum, t) => sum + t.totalParticipants, 0);

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="bg-slate-800 rounded-2xl shadow-2xl p-8 mb-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h1 className="text-4xl font-bold text-white mb-2">üíº –ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤</h1>
              <p className="text-slate-300">–ü—Ä–æ–≥—Ä–∞–º–º–∞ "–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ" - –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç</p>
            </div>
            <div className="text-right">
              <div className="text-sm text-slate-400">–î–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è</div>
              <div className="text-white font-semibold">{new Date().toLocaleDateString('ru-RU')}</div>
            </div>
          </div>
        </div>

        {/* Action Buttons */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <label className="bg-blue-600 hover:bg-blue-700 text-white rounded-xl p-4 cursor-pointer transition-all flex items-center justify-center gap-2 shadow-lg">
            <Upload size={20} />
            <span className="font-semibold">–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–Ω—è—Ç–∏—è</span>
            <input type="file" accept=".docx" onChange={handleFileUpload} className="hidden" />
          </label>
          
          <button
            onClick={addManualSession}
            className="bg-slate-700 hover:bg-slate-600 text-white rounded-xl p-4 transition-all flex items-center justify-center gap-2 shadow-lg"
          >
            <Plus size={20} />
            <span className="font-semibold">–ù–æ–≤—ã–π –ø–µ–¥–∞–≥–æ–≥</span>
          </button>
          
          <button
            onClick={exportReport}
            className="bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl p-4 transition-all flex items-center justify-center gap-2 shadow-lg"
            disabled={teachers.length === 0}
          >
            <Download size={20} />
            <span className="font-semibold">–≠–∫—Å–ø–æ—Ä—Ç</span>
          </button>
          
          <button
            onClick={() => window.print()}
            className="bg-slate-700 hover:bg-slate-600 text-white rounded-xl p-4 transition-all flex items-center justify-center gap-2 shadow-lg"
          >
            <FileText size={20} />
            <span className="font-semibold">–ü–µ—á–∞—Ç—å</span>
          </button>
        </div>

        {/* Statistics Cards */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div className="bg-blue-600 rounded-2xl p-6 shadow-xl">
            <div className="text-blue-100 text-sm mb-2">–ü–ï–î–ê–ì–û–ì–û–í –†–ê–ë–û–¢–ê–ï–¢</div>
            <div className="text-5xl font-bold text-white mb-2">{activePedagogs}</div>
            <div className="text-blue-100">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤</div>
          </div>
          
          <div className="bg-purple-600 rounded-2xl p-6 shadow-xl">
            <div className="text-purple-100 text-sm mb-2">–í–°–ï–ì–û –£–ß–ê–°–¢–ù–ò–ö–û–í</div>
            <div className="text-5xl font-bold text-white mb-2">{totalParticipants}</div>
            <div className="text-purple-100">{sessions.length} –∑–∞–Ω—è—Ç–∏–π –ø—Ä–æ–≤–µ–¥–µ–Ω–æ</div>
          </div>
          
          <div className="bg-emerald-600 rounded-2xl p-6 shadow-xl">
            <div className="text-emerald-100 text-sm mb-2">–ì–†–ê–ù–¢ –û–¢ –ì–û–°–£–î–ê–†–°–¢–í–ê</div>
            <div className="text-5xl font-bold text-white mb-2">{totalSalary.toFixed(0)}</div>
            <div className="text-emerald-100">‚ÇΩ –∫ –≤—ã–ø–ª–∞—Ç–µ</div>
          </div>
        </div>

        {/* Teachers Summary */}
        {teachers.length > 0 && (
          <div className="bg-slate-800 rounded-2xl shadow-xl p-6 mb-6">
            <h2 className="text-2xl font-bold text-white mb-4 flex items-center gap-2">
              <Users className="text-blue-400" />
              –°–≤–æ–¥–∫–∞ –ø–æ –ø–µ–¥–∞–≥–æ–≥–∞–º
            </h2>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b border-slate-700">
                    <th className="text-left text-slate-400 py-3 px-4">–ü–µ–¥–∞–≥–æ–≥</th>
                    <th className="text-center text-slate-400 py-3 px-4">–ó–∞–Ω—è—Ç–∏–π</th>
                    <th className="text-center text-slate-400 py-3 px-4">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</th>
                    <th className="text-center text-slate-400 py-3 px-4">–ß–∞—Å–æ–≤</th>
                    <th className="text-right text-slate-400 py-3 px-4">–ö –≤—ã–ø–ª–∞—Ç–µ</th>
                  </tr>
                </thead>
                <tbody>
                  {teachers.map((teacher, idx) => (
                    <tr key={idx} className="border-b border-slate-700 hover:bg-slate-700/50 transition-colors">
                      <td className="py-3 px-4 text-white font-medium">{teacher.name}</td>
                      <td className="py-3 px-4 text-center text-slate-300">{teacher.totalSessions}</td>
                      <td className="py-3 px-4 text-center text-slate-300">{teacher.totalParticipants}</td>
                      <td className="py-3 px-4 text-center text-slate-300">{teacher.totalHours}</td>
                      <td className="py-3 px-4 text-right text-emerald-400 font-bold">{teacher.totalSalary.toFixed(2)} ‚ÇΩ</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Sessions List */}
        {sessions.length > 0 && (
          <div className="bg-slate-800 rounded-2xl shadow-xl p-6">
            <h2 className="text-2xl font-bold text-white mb-4 flex items-center gap-2">
              <FileText className="text-blue-400" />
              –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∑–∞–Ω—è—Ç–∏—è–º
            </h2>
            <div className="space-y-3">
              {sessions.map((session) => (
                <div key={session.id} className="bg-slate-700 rounded-xl p-4 hover:bg-slate-600 transition-colors">
                  <div className="grid grid-cols-1 md:grid-cols-6 gap-3 items-center">
                    <input
                      type="date"
                      value={session.date.split('.').reverse().join('-')}
                      onChange={(e) => updateSession(session.id, 'date', new Date(e.target.value).toLocaleDateString('ru-RU'))}
                      className="bg-slate-600 text-white px-3 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                    />
                    <input
                      type="text"
                      value={session.teacher}
                      onChange={(e) => updateSession(session.id, 'teacher', e.target.value)}
                      className="bg-slate-600 text-white px-3 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                      placeholder="–§–ò–û –ø–µ–¥–∞–≥–æ–≥–∞"
                    />
                    <input
                      type="number"
                      value={session.participants}
                      onChange={(e) => updateSession(session.id, 'participants', e.target.value)}
                      className="bg-slate-600 text-white px-3 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                      placeholder="–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
                      min="0"
                    />
                    <input
                      type="number"
                      value={session.hours}
                      onChange={(e) => updateSession(session.id, 'hours', e.target.value)}
                      className="bg-slate-600 text-white px-3 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                      placeholder="–ß–∞—Å–æ–≤"
                      min="0"
                      step="0.5"
                    />
                    <input
                      type="number"
                      value={session.rate}
                      onChange={(e) => updateSession(session.id, 'rate', e.target.value)}
                      className="bg-slate-600 text-white px-3 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                      placeholder="–°—Ç–∞–≤–∫–∞ ‚ÇΩ/—á–∞—Å"
                      min="0"
                    />
                    <button
                      onClick={() => deleteSession(session.id)}
                      className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center justify-center gap-2"
                    >
                      <Trash2 size={16} />
                    </button>
                  </div>
                  <div className="mt-2 text-right text-emerald-400 font-semibold">
                    –û–ø–ª–∞—Ç–∞: {(session.hours * session.rate).toFixed(2)} ‚ÇΩ
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {sessions.length === 0 && (
          <div className="bg-slate-800 rounded-2xl shadow-xl p-12 text-center">
            <Upload className="mx-auto mb-4 text-slate-600" size={64} />
            <h3 className="text-2xl font-bold text-white mb-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
            <p className="text-slate-400 mb-6">–ó–∞–≥—Ä—É–∑–∏—Ç–µ DOCX –æ—Ç—á–µ—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–Ω—è—Ç–∏—è –≤—Ä—É—á–Ω—É—é</p>
          </div>
        )}

        {loading && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-slate-800 rounded-2xl p-8 text-center">
              <div className="animate-spin w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
              <p className="text-white text-lg">–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...</p>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
