<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤ - –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: #0f172a; 
      color: #fff; 
      padding: 10px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .header-left h1 { font-size: 24px; margin-bottom: 5px; }
    .subtitle { color: #94a3b8; font-size: 13px; }
    
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn {
      background: #1e40af;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn:hover { background: #1e3a8a; }
    .btn.secondary { background: #334155; }
    .btn.secondary:hover { background: #475569; }
    .btn.success { background: #059669; }
    .btn.success:hover { background: #047857; }
    .btn.small { padding: 6px 10px; font-size: 12px; }
    
    .stats { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
      gap: 10px; 
      margin-bottom: 20px; 
    }
    .stat-card {
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .stat-card.green { background: linear-gradient(135deg, #065f46 0%, #047857 100%); }
    .stat-card.yellow { background: linear-gradient(135deg, #78350f 0%, #92400e 100%); }
    .stat-card.red { background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%); }
    .stat-card.purple { background: linear-gradient(135deg, #581c87 0%, #6b21a8 100%); }
    
    .stat-label { 
      font-size: 10px; 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
      opacity: 0.8;
      margin-bottom: 5px;
    }
    .stat-value { font-size: 24px; font-weight: bold; }
    .stat-change { font-size: 11px; margin-top: 5px; opacity: 0.9; }
    
    .table-container {
      background: #1e293b;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      overflow-x: auto;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse;
      min-width: 600px;
    }
    th { 
      padding: 10px 6px; 
      text-align: left; 
      color: #cbd5e1; 
      font-size: 12px;
      border-bottom: 2px solid #334155;
    }
    td { 
      padding: 12px 6px; 
      border-bottom: 1px solid #334155;
      font-size: 13px;
    }
    
    .badge {
      display: inline-block;
      background: #2563eb;
      color: #fff;
      padding: 4px 10px;
      border-radius: 15px;
      font-weight: bold;
      font-size: 12px;
    }
    
    .amount { font-weight: bold; font-size: 14px; }
    .green { color: #4ade80; }
    .yellow { color: #fbbf24; }
    .red { color: #f87171; }
    .blue { color: #60a5fa; }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 1000;
      overflow-y: auto;
      padding: 10px;
    }
    .modal.active { display: block; }
    .modal-content {
      background: #1e293b;
      border-radius: 12px;
      padding: 20px;
      max-width: 800px;
      width: 100%;
      margin: 20px auto;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .modal-title { font-size: 18px; font-weight: bold; }
    .close-btn {
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      line-height: 1;
    }
    
    .form-group {
      margin-bottom: 12px;
    }
    .form-group label {
      display: block;
      color: #cbd5e1;
      font-size: 13px;
      margin-bottom: 5px;
      font-weight: 500;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      background: #334155;
      border: 1px solid #475569;
      color: #fff;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
    }
    .form-actions {
      display: flex;
      gap: 8px;
      margin-top: 15px;
      justify-content: flex-end;
    }
    
    .alert {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #1e293b;
      border-left: 4px solid #22c55e;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      z-index: 2000;
      max-width: 90%;
      font-size: 13px;
    }
    .alert.error { border-left-color: #ef4444; }
    
    .info-box {
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid #3b82f6;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .info-title { 
      font-weight: bold; 
      color: #93c5fd; 
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    .preview-section {
      background: #334155;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    .preview-title {
      color: #93c5fd;
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .preview-item {
      padding: 6px 0;
      border-bottom: 1px solid #475569;
      font-size: 13px;
    }
    .preview-item:last-child { border-bottom: none; }
    
    .group-card {
      background: #334155;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .group-card h3 {
      font-size: 14px;
      margin-bottom: 5px;
    }
    .group-card p {
      color: #94a3b8;
      font-size: 12px;
      margin-bottom: 8px;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      margin-top: 10px;
    }
    .calendar-day {
      background: #334155;
      padding: 6px;
      border-radius: 4px;
      text-align: center;
      cursor: pointer;
      min-height: 60px;
      font-size: 11px;
    }
    .calendar-day:hover { background: #475569; }
    .calendar-day.has-schedule {
      background: rgba(59, 130, 246, 0.3);
      border: 2px solid #3b82f6;
    }
    .calendar-day-number {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .calendar-class {
      font-size: 9px;
      background: rgba(59, 130, 246, 0.5);
      padding: 2px;
      border-radius: 2px;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .upload-zone {
      border: 2px dashed #475569;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      background: rgba(59, 130, 246, 0.05);
      cursor: pointer;
    }
    .upload-icon { font-size: 40px; margin-bottom: 10px; }
    .upload-text { color: #cbd5e1; font-size: 14px; margin-bottom: 5px; }
    .upload-hint { color: #94a3b8; font-size: 12px; }
    
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    
    @media (max-width: 768px) {
      .header-left h1 { font-size: 20px; }
      .controls { width: 100%; }
      .btn { width: 100%; }
      .stats { grid-template-columns: repeat(2, 1fr); }
      .stat-value { font-size: 20px; }
      table { font-size: 11px; }
      th, td { padding: 8px 4px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <h1>üíº –ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤</h1>
        <div class="subtitle">–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ</div>
      </div>
      <div class="controls">
        <button class="btn success" onclick="showUploadModal()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å DOCX</button>
        <button class="btn" onclick="showCalendarModal()">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
        <button class="btn" onclick="showGroupsModal()">üìã –ì—Ä—É–ø–ø—ã</button>
        <button class="btn secondary" onclick="showAddExpenseModal()">üí∏ –†–∞—Å—Ö–æ–¥</button>
      </div>
    </div>
    
    <div class="stats" id="statsContainer"></div>
    
    <div class="table-container">
      <h2 style="margin-bottom: 15px; font-size: 16px;">üìä –ü–æ –ø–µ–¥–∞–≥–æ–≥–∞–º</h2>
      <table>
        <thead>
          <tr>
            <th>–ü–µ–¥–∞–≥–æ–≥</th>
            <th class="text-center">–ó–∞–Ω—è—Ç–∏–π</th>
            <th class="text-center">–õ—é–¥–µ–π</th>
            <th class="text-right">–ì—Ä–∞–Ω—Ç</th>
            <th class="text-right">–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
            <th class="text-right">–ê—Ä–µ–Ω–¥–∞</th>
            <th class="text-right">–ü—Ä–∏–±—ã–ª—å</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot style="background: #0f172a; font-weight: bold;" id="tableFoot"></tfoot>
      </table>
    </div>
  </div>
  
  <!-- Modals -->
  <div class="modal" id="uploadModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞</div>
        <button class="close-btn" onclick="closeModal('uploadModal')">√ó</button>
      </div>
      <div id="uploadContent">
        <div class="upload-zone" onclick="document.getElementById('docxFile').click()">
          <div class="upload-icon">üìÑ</div>
          <div class="upload-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª DOCX</div>
          <div class="upload-hint">–û—Ç—á–µ—Ç –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</div>
        </div>
        <input type="file" id="docxFile" accept=".docx" style="display: none;" onchange="handleFileUpload(event)">
      </div>
    </div>
  </div>
  
  <div class="modal" id="calendarModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
        <button class="close-btn" onclick="closeModal('calendarModal')">√ó</button>
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
        <button class="btn secondary small" onclick="changeMonth(-1)">‚Üê</button>
        <div style="font-weight: bold;" id="currentMonth"></div>
        <button class="btn secondary small" onclick="changeMonth(1)">‚Üí</button>
      </div>
      <div id="calendarContent"></div>
    </div>
  </div>
  
  <div class="modal" id="addToCalendarModal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <div class="modal-title" id="calTitle">–î–æ–±–∞–≤–∏—Ç—å</div>
        <button class="close-btn" onclick="closeModal('addToCalendarModal')">√ó</button>
      </div>
      <form onsubmit="saveToCalendar(event)">
        <input type="hidden" id="calDate">
        <div class="form-group">
          <label>–ì—Ä—É–ø–ø–∞</label>
          <select id="calGroup" required></select>
        </div>
        <div class="form-group">
          <label>–í—Ä–µ–º—è</label>
          <input type="time" id="calTime" value="09:00">
        </div>
        <div class="form-actions">
          <button type="button" class="btn secondary" onclick="closeModal('addToCalendarModal')">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>
  
  <div class="modal" id="groupsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">üìã –ì—Ä—É–ø–ø—ã</div>
        <button class="close-btn" onclick="closeModal('groupsModal')">√ó</button>
      </div>
      <button class="btn success" onclick="showAddGroupForm()" style="margin-bottom: 15px; width: 100%;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
      <div id="groupsList"></div>
    </div>
  </div>
  
  <div class="modal" id="groupFormModal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <div class="modal-title" id="groupFormTitle">–ì—Ä—É–ø–ø–∞</div>
        <button class="close-btn" onclick="closeModal('groupFormModal')">√ó</button>
      </div>
      <form onsubmit="saveGroup(event)">
        <input type="hidden" id="editGroupId">
        <div class="form-group">
          <label>–ö–æ–¥ –≥—Ä—É–ø–ø—ã *</label>
          <input type="text" id="groupCode" placeholder="G-02250378" required>
        </div>
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
          <input type="text" id="groupName" placeholder="–¢–∞–Ω—Ü—ã" required>
        </div>
        <div class="form-group">
          <label>–ü–µ–¥–∞–≥–æ–≥ *</label>
          <input type="text" id="groupTeacher" placeholder="–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ –ò–≤–∞–Ω–æ–≤–∞" required>
        </div>
        <div class="form-group">
          <label>–õ–æ–∫–∞—Ü–∏—è *</label>
          <select id="groupLocation" required>
            <option value="–ë—É–¥–µ–Ω–Ω–æ–≥–æ">–ë—É–¥–µ–Ω–Ω–æ–≥–æ</option>
            <option value="–ß–µ—Ä–∫–∏–∑–æ–≤—Å–∫–∞—è">–ß–µ—Ä–∫–∏–∑–æ–≤—Å–∫–∞—è</option>
            <option value="–ü–∞—Ä–∫">–ü–∞—Ä–∫</option>
            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
          </select>
        </div>
        <div class="form-group">
          <label>–¢–∏–ø –æ–ø–ª–∞—Ç—ã *</label>
          <select id="groupSalaryType" onchange="toggleSalaryLabel()">
            <option value="percent">–ü—Ä–æ—Ü–µ–Ω—Ç %</option>
            <option value="fixed">–§–∏–∫—Å —Å—Ç–∞–≤–∫–∞</option>
          </select>
        </div>
        <div class="form-group">
          <label id="groupSalaryLabel">–ü—Ä–æ—Ü–µ–Ω—Ç (%) *</label>
          <input type="number" id="groupSalaryValue" min="0" step="0.01" required>
        </div>
        <div class="form-group">
          <label>–ê—Ä–µ–Ω–¥–∞ –∑–∞–ª–∞ (‚ÇΩ)</label>
          <input type="number" id="groupHallCost" min="0" value="0">
        </div>
        <div class="form-actions">
          <button type="button" class="btn secondary" onclick="closeModal('groupFormModal')">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>
  
  <div class="modal" id="expenseModal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <div class="modal-title">üí∏ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</div>
        <button class="close-btn" onclick="closeModal('expenseModal')">√ó</button>
      </div>
      <form onsubmit="saveExpense(event)">
        <div class="form-group">
          <label>–î–∞—Ç–∞</label>
          <input type="date" id="expenseDate" required>
        </div>
        <div class="form-group">
          <label>–ì—Ä—É–ø–ø–∞</label>
          <select id="expenseGroup" required></select>
        </div>
        <div class="form-group">
          <label>–°—É–º–º–∞ (‚ÇΩ)</label>
          <input type="number" id="expenseAmount" min="0" required>
        </div>
        <div class="form-group">
          <label>–ü—Ä–∏—á–∏–Ω–∞</label>
          <input type="text" id="expenseReason" placeholder="–ê—Ä–µ–Ω–¥–∞ –æ–ø–ª–∞—á–µ–Ω–∞, –∑–∞–Ω—è—Ç–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ">
        </div>
        <div class="form-actions">
          <button type="button" class="btn secondary" onclick="closeModal('expenseModal')">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const GRANT_PER_PERSON = 280;
    const MONTHS = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
    
    let groups = [];
    let calendar = [];
    let sessions = [];
    let expenses = [];
    let currentMonth = new Date(2025, 0, 1);
    
    function loadData() {
      groups = JSON.parse(localStorage.getItem('groups') || '[]');
      calendar = JSON.parse(localStorage.getItem('calendar') || '[]');
      sessions = JSON.parse(localStorage.getItem('sessions') || '[]');
      expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
      
      if (groups.length === 0) {
        groups = [{
          id: 1,
          code: "G-02250378",
          name: "–¢–∞–Ω—Ü—ã",
          teacher: "–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ –ò–≤–∞–Ω–æ–≤–∞",
          location: "–ë—É–¥–µ–Ω–Ω–æ–≥–æ",
          salaryType: "percent",
          salaryValue: 50,
          hallCost: 0
        }];
      }
      
      updateDisplay();
    }
    
    function saveData() {
      localStorage.setItem('groups', JSON.stringify(groups));
      localStorage.setItem('calendar', JSON.stringify(calendar));
      localStorage.setItem('sessions', JSON.stringify(sessions));
      localStorage.setItem('expenses', JSON.stringify(expenses));
    }
    
    function showAlert(msg, type = 'success') {
      const alert = document.createElement('div');
      alert.className = `alert ${type === 'error' ? 'error' : ''}`;
      alert.textContent = msg;
      document.body.appendChild(alert);
      setTimeout(() => alert.remove(), 3000);
    }
    
    function formatNumber(num) {
      return num.toLocaleString('ru-RU');
    }
    
    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }
    
    // –ì–†–£–ü–ü–´
    function showGroupsModal() {
      renderGroupsList();
      document.getElementById('groupsModal').classList.add('active');
    }
    
    function showAddGroupForm() {
      document.getElementById('groupFormTitle').textContent = '–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞';
      document.getElementById('editGroupId').value = '';
      document.getElementById('groupCode').value = '';
      document.getElementById('groupName').value = '';
      document.getElementById('groupTeacher').value = '';
      document.getElementById('groupLocation').value = '–ë—É–¥–µ–Ω–Ω–æ–≥–æ';
      document.getElementById('groupSalaryType').value = 'percent';
      document.getElementById('groupSalaryValue').value = '50';
      document.getElementById('groupHallCost').value = '0';
      toggleSalaryLabel();
      closeModal('groupsModal');
      document.getElementById('groupFormModal').classList.add('active');
    }
    
    function showEditGroupForm(id) {
      const g = groups.find(x => x.id === id);
      if (!g) return;
      
      document.getElementById('groupFormTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
      document.getElementById('editGroupId').value = g.id;
      document.getElementById('groupCode').value = g.code;
      document.getElementById('groupName').value = g.name;
      document.getElementById('groupTeacher').value = g.teacher;
      document.getElementById('groupLocation').value = g.location;
      document.getElementById('groupSalaryType').value = g.salaryType;
      document.getElementById('groupSalaryValue').value = g.salaryValue;
      document.getElementById('groupHallCost').value = g.hallCost;
      toggleSalaryLabel();
      closeModal('groupsModal');
      document.getElementById('groupFormModal').classList.add('active');
    }
    
    function toggleSalaryLabel() {
      const type = document.getElementById('groupSalaryType').value;
      document.getElementById('groupSalaryLabel').textContent = 
        type === 'percent' ? '–ü—Ä–æ—Ü–µ–Ω—Ç (%) *' : '–°—Ç–∞–≤–∫–∞ (‚ÇΩ) *';
    }
    
    function renderGroupsList() {
      const container = document.getElementById('groupsList');
      if (groups.length === 0) {
        container.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 20px;">–ù–µ—Ç –≥—Ä—É–ø–ø</p>';
        return;
      }
      
      container.innerHTML = groups.map(g => `
        <div class="group-card">
          <h3>${g.code} - ${g.name}</h3>
          <p>üë§ ${g.teacher} ‚Ä¢ üìç ${g.location}<br>
          üí∞ ${g.salaryType === 'percent' ? g.salaryValue + '%' : formatNumber(g.salaryValue) + '‚ÇΩ'}
          ${g.hallCost > 0 ? ' ‚Ä¢ üè¢ ' + formatNumber(g.hallCost) + '‚ÇΩ' : ''}</p>
          <div style="display: flex; gap: 5px;">
            <button class="btn secondary small" onclick="showEditGroupForm(${g.id})">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
            <button class="btn secondary small" onclick="deleteGroup(${g.id})">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }
    
    function saveGroup(e) {
      e.preventDefault();
      
      const editId = document.getElementById('editGroupId').value;
      const data = {
        code: document.getElementById('groupCode').value.trim(),
        name: document.getElementById('groupName').value.trim(),
        teacher: document.getElementById('groupTeacher').value.trim(),
        location: document.getElementById('groupLocation').value,
        salaryType: document.getElementById('groupSalaryType').value,
        salaryValue: parseFloat(document.getElementById('groupSalaryValue').value),
        hallCost: parseFloat(document.getElementById('groupHallCost').value) || 0
      };
      
      if (editId) {
        const g = groups.find(x => x.id === parseInt(editId));
        if (g) Object.assign(g, data);
      } else {
        data.id = groups.length > 0 ? Math.max(...groups.map(x => x.id)) + 1 : 1;
        groups.push(data);
      }
      
      saveData();
      closeModal('groupFormModal');
      showAlert(editId ? '–û–±–Ω–æ–≤–ª–µ–Ω–æ!' : '–ì—Ä—É–ø–ø–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
      showGroupsModal();
    }
    
    function deleteGroup(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?')) return;
      groups = groups.filter(g => g.id !== id);
      saveData();
      renderGroupsList();
    }
    
    // –ö–ê–õ–ï–ù–î–ê–†–¨
    function showCalendarModal() {
      renderCalendar();
      document.getElementById('calendarModal').classList.add('active');
    }
    
    function changeMonth(delta) {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + delta, 1);
      renderCalendar();
    }
    
    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      
      document.getElementById('currentMonth').textContent = `${MONTHS[month]} ${year}`;
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startDay = firstDay.getDay();
      
      let html = '<div class="calendar-grid">';
      
      ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'].forEach(d => {
        html += `<div style="font-weight: bold; text-align: center; padding: 5px; font-size: 11px;">${d}</div>`;
      });
      
      for (let i = 0; i < startDay; i++) {
        html += '<div></div>';
      }
      
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const cals = calendar.filter(c => c.date === dateStr);
        
        html += `
          <div class="calendar-day ${cals.length > 0 ? 'has-schedule' : ''}" onclick="showAddToCalendar('${dateStr}')">
            <div class="calendar-day-number">${day}</div>
            ${cals.map(c => {
              const g = groups.find(x => x.id === c.groupId);
              return g ? `<div class="calendar-class">${c.time || '09:00'} ${g.teacher.split(' ')[0]}</div>` : '';
            }).join('')}
          </div>
        `;
      }
      
      html += '</div>';
      document.getElementById('calendarContent').innerHTML = html;
    }
    
    function showAddToCalendar(dateStr) {
      document.getElementById('calTitle').textContent = new Date(dateStr).toLocaleDateString('ru-RU');
      document.getElementById('calDate').value = dateStr;
      
      const select = document.getElementById('calGroup');
      select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>' +
        groups.map(g => `<option value="${g.id}">${g.code} - ${g.name}</option>`).join('');
      
      document.getElementById('addToCalendarModal').classList.add('active');
    }
    
    function saveToCalendar(e) {
      e.preventDefault();
      
      const dateStr = document.getElementById('calDate').value;
      const groupId = parseInt(document.getElementById('calGroup').value);
      const time = document.getElementById('calTime').value;
      
      const exists = calendar.find(c => c.date === dateStr && c.groupId === groupId);
      if (exists) {
        showAlert('–£–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ!', 'error');
        return;
      }
      
      calendar.push({
        id: calendar.length + 1,
        date: dateStr,
        time: time,
        groupId: groupId
      });
      
      saveData();
      closeModal('addToCalendarModal');
      renderCalendar();
      showAlert('–î–æ–±–∞–≤–ª–µ–Ω–æ!');
    }
    
    // –†–ê–°–•–û–î–´
    function showAddExpenseModal() {
      document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
      
      const select = document.getElementById('expenseGroup');
      select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>' +
        groups.map(g => `<option value="${g.id}">${g.code} - ${g.name}</option>`).join('');
      
      document.getElementById('expenseModal').classList.add('active');
    }
    
    function saveExpense(e) {
      e.preventDefault();
      
      expenses.push({
        id: expenses.length + 1,
        date: document.getElementById('expenseDate').value,
        groupId: parseInt(document.getElementById('expenseGroup').value),
        amount: parseFloat(document.getElementById('expenseAmount').value),
        reason: document.getElementById('expenseReason').value
      });
      
      saveData();
      closeModal('expenseModal');
      updateDisplay();
      showAlert('–†–∞—Å—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω!');
    }
    
    // –ó–ê–ì–†–£–ó–ö–ê DOCX
    function showUploadModal() {
      document.getElementById('uploadContent').innerHTML = `
        <div class="upload-zone" onclick="document.getElementById('docxFile').click()">
          <div class="upload-icon">üìÑ</div>
          <div class="upload-text">–í—ã–±–µ—Ä–∏—Ç–µ DOCX</div>
          <div class="upload-hint">–û—Ç—á–µ—Ç –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</div>
        </div>
        <input type="file" id="docxFile" accept=".docx" style="display: none;" onchange="handleFileUpload(event)">
      `;
      document.getElementById('uploadModal').classList.add('active');
    }
    
    async function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      showAlert('–û–±—Ä–∞–±–æ—Ç–∫–∞...');
      
      try {
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer });
        const text = result.value;
        
        console.log('–¢–µ–∫—Å—Ç:', text.substring(0, 1000));
        
        const parsedData = parseReport(text);
        
        if (!parsedData) {
          showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å', 'error');
          return;
        }
        
        showPreview(parsedData);
        
      } catch (error) {
        console.error(error);
        showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }
    
    function parseReport(text) {
      console.log('=== –ü–ê–†–°–ò–ù–ì ===');
      
      const codeMatch = text.match(/–∫–æ–¥\s+–≥—Ä—É–ø–ø—ã[:\s]+([A-Z]-\d+)/i) || text.match(/([A-Z]-\d{8})/);
      
      if (!codeMatch) {
        showAlert('–ö–æ–¥ –≥—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
        return null;
      }
      
      const code = codeMatch[1];
      console.log('–ö–æ–¥:', code);
      
      const group = groups.find(g => g.code === code);
      if (!group) {
        showAlert(`–ì—Ä—É–ø–ø–∞ ${code} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!`, 'error');
        return null;
      }
      
      const allDates = [...text.matchAll(/(\d{2})\.(\d{2})/g)];
      console.log('–î–∞—Ç –Ω–∞–π–¥–µ–Ω–æ:', allDates.length);
      
      const uniqueDates = [];
      const seen = new Set();
      
      for (let m of allDates) {
        const ds = `${m[1]}.${m[2]}`;
        if (!seen.has(ds) && parseInt(m[1]) <= 31 && parseInt(m[2]) <= 12) {
          seen.add(ds);
          uniqueDates.push(m);
          if (uniqueDates.length >= 15) break;
        }
      }
      
      console.log('–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–∞—Ç:', uniqueDates.length);
      
      if (uniqueDates.length === 0) {
        showAlert('–î–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
        return null;
      }
      
      const year = new Date().getFullYear();
      const sessionData = [];
      
      uniqueDates.forEach((m, idx) => {
        const day = m[1];
        const month = m[2];
        const dateStr = `${day}.${month}`;
        const fullDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        
        const datePos = text.indexOf(dateStr);
        const nextDate = uniqueDates[idx + 1];
        const nextPos = nextDate ? text.indexOf(`${nextDate[1]}.${nextDate[2]}`, datePos + 1) : -1;
        
        let segment;
        if (nextPos > 0) {
          segment = text.substring(datePos, nextPos);
        } else {
          const itogo = text.indexOf('–ò—Ç–æ–≥–æ', datePos);
          segment = text.substring(datePos, itogo > 0 ? itogo : datePos + 2000);
        }
        
        const plusCount = (segment.match(/\+/g) || []).length;
        
        console.log(`${dateStr}: ${plusCount} —á–µ–ª`);
        
        if (plusCount > 0) {
          const calEntry = calendar.find(c => c.date === fullDate);
          const finalGroup = calEntry ? groups.find(g => g.id === calEntry.groupId) : group;
          
          sessionData.push({
            date: fullDate,
            time: calEntry?.time || '09:00',
            people: plusCount,
            group: finalGroup || group
          });
        }
      });
      
      console.log('–ó–∞–Ω—è—Ç–∏–π:', sessionData.length);
      console.log('–í—Å–µ–≥–æ –ª—é–¥–µ–π:', sessionData.reduce((s, x) => s + x.people, 0));
      
      if (sessionData.length === 0) {
        showAlert('–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
        return null;
      }
      
      return { sessions: sessionData };
    }
    
    function showPreview(data) {
      const { sessions: parsed } = data;
      
      const totalPeople = parsed.reduce((s, x) => s + x.people, 0);
      const totalIncome = totalPeople * GRANT_PER_PERSON;
      
      const byTeacher = {};
      parsed.forEach(s => {
        const t = s.group.teacher;
        if (!byTeacher[t]) {
          byTeacher[t] = { teacher: t, sessions: [], income: 0, salary: 0 };
        }
        
        byTeacher[t].sessions.push(s);
        const inc = s.people * GRANT_PER_PERSON;
        byTeacher[t].income += inc;
        
        if (s.group.salaryType === 'fixed') {
          byTeacher[t].salary += s.group.salaryValue;
        } else {
          byTeacher[t].salary += Math.round((inc * s.group.salaryValue) / 100);
        }
      });
      
      const html = `
        <div class="info-box" style="border-left-color: #22c55e;">
          <div class="info-title">‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ!</div>
        </div>
        
        <div class="preview-section">
          <div class="preview-title">üìä –î–∞–Ω–Ω—ã–µ</div>
          <div class="preview-item"><strong>–ó–∞–Ω—è—Ç–∏–π:</strong> ${parsed.length}</div>
          <div class="preview-item">
            <strong>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> 
            <span style="font-size: 20px; color: #4ade80; font-weight: bold;">${totalPeople}</span>
          </div>
          <div class="preview-item"><strong>–ì—Ä–∞–Ω—Ç:</strong> <span class="green">${formatNumber(totalIncome)}‚ÇΩ</span></div>
        </div>
        
        <div class="preview-section" style="max-height: 250px; overflow-y: auto;">
          <div class="preview-title">üìÖ –ü–æ –¥–∞—Ç–∞–º</div>
          ${parsed.map(s => `
            <div style="padding: 6px; background: #1e293b; border-radius: 4px; margin-bottom: 3px; font-size: 12px;">
              <strong>${s.date}</strong> ${s.time} ‚Ä¢ ${s.group.name} ‚Ä¢ 
              <span style="color: #4ade80; font-weight: bold;">${s.people} —á–µ–ª.</span>
            </div>
          `).join('')}
        </div>
        
        ${Object.values(byTeacher).map(t => `
          <div class="preview-section">
            <div class="preview-title">üë§ ${t.teacher}</div>
            <div class="preview-item"><strong>–ó–∞–Ω—è—Ç–∏–π:</strong> ${t.sessions.length}</div>
            <div class="preview-item"><strong>–õ—é–¥–µ–π:</strong> ${t.sessions.reduce((s, x) => s + x.people, 0)}</div>
            <div class="preview-item"><strong>–ì—Ä–∞–Ω—Ç:</strong> <span class="green">${formatNumber(t.income)}‚ÇΩ</span></div>
            <div class="preview-item"><strong>–ó–∞—Ä–ø–ª–∞—Ç–∞:</strong> <span class="yellow">${formatNumber(t.salary)}‚ÇΩ</span></div>
          </div>
        `).join('')}
        
        <div class="form-actions">
          <button class="btn secondary" onclick="closeModal('uploadModal')">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn success" onclick='confirmImport(${JSON.stringify(data).replace(/'/g, "&#39;")})'>‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      `;
      
      document.getElementById('uploadContent').innerHTML = html;
    }
    
    function confirmImport(data) {
      data.sessions.forEach(s => {
        sessions.push({
          id: sessions.length + 1,
          groupId: s.group.id,
          date: s.date,
          time: s.time,
          people: s.people,
          teacher: s.group.teacher
        });
      });
      
      saveData();
      closeModal('uploadModal');
      updateDisplay();
      showAlert(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${data.sessions.length} –∑–∞–Ω—è—Ç–∏–π!`);
    }
    
    // –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï
    function updateDisplay() {
      renderStats();
      renderTable();
    }
    
    function renderStats() {
      const totalSessions = sessions.length;
      const totalPeople = sessions.reduce((s, x) => s + x.people, 0);
      const totalIncome = totalPeople * GRANT_PER_PERSON;
      
      let totalSalary = 0;
      let totalHallCost = 0;
      
      sessions.forEach(s => {
        const g = groups.find(x => x.id === s.groupId);
        if (!g) return;
        
        const inc = s.people * GRANT_PER_PERSON;
        if (g.salaryType === 'fixed') {
          totalSalary += g.salaryValue;
        } else {
          totalSalary += Math.round((inc * g.salaryValue) / 100);
        }
        totalHallCost += g.hallCost;
      });
      
      expenses.forEach(e => {
        totalHallCost += e.amount;
      });
      
      const totalProfit = totalIncome - totalSalary - totalHallCost;
      const teachers = new Set(sessions.map(s => s.teacher)).size;
      
      document.getElementById('statsContainer').innerHTML = `
        <div class="stat-card">
          <div class="stat-label">–ü–µ–¥–∞–≥–æ–≥–æ–≤</div>
          <div class="stat-value">${teachers}</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-label">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
          <div class="stat-value">${totalPeople}</div>
          <div class="stat-change">${totalSessions} –∑–∞–Ω—è—Ç–∏–π</div>
        </div>
        <div class="stat-card green">
          <div class="stat-label">–ì—Ä–∞–Ω—Ç</div>
          <div class="stat-value">${formatNumber(totalIncome)}‚ÇΩ</div>
        </div>
        <div class="stat-card yellow">
          <div class="stat-label">–ó–∞—Ä–ø–ª–∞—Ç—ã</div>
          <div class="stat-value">${formatNumber(totalSalary)}‚ÇΩ</div>
        </div>
        <div class="stat-card red">
          <div class="stat-label">–ê—Ä–µ–Ω–¥–∞</div>
          <div class="stat-value">${formatNumber(totalHallCost)}‚ÇΩ</div>
          <div class="stat-change">${expenses.length > 0 ? '+ —Ä–∞—Å—Ö–æ–¥—ã' : ''}</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #0e7490, #0891b2);">
          <div class="stat-label">–ü—Ä–∏–±—ã–ª—å</div>
          <div class="stat-value">${formatNumber(totalProfit)}‚ÇΩ</div>
        </div>
      `;
    }
    
    function renderTable() {
      const byTeacher = {};
      
      sessions.forEach(s => {
        const t = s.teacher;
        if (!byTeacher[t]) {
          byTeacher[t] = { teacher: t, groups: new Set(), sessions: 0, people: 0, income: 0, salary: 0, hallCost: 0 };
        }
        
        byTeacher[t].groups.add(s.groupId);
        byTeacher[t].sessions++;
        byTeacher[t].people += s.people;
        
        const g = groups.find(x => x.id === s.groupId);
        if (g) {
          const inc = s.people * GRANT_PER_PERSON;
          byTeacher[t].income += inc;
          
          if (g.salaryType === 'fixed') {
            byTeacher[t].salary += g.salaryValue;
          } else {
            byTeacher[t].salary += Math.round((inc * g.salaryValue) / 100);
          }
          
          byTeacher[t].hallCost += g.hallCost;
        }
      });
      
      const teacherData = Object.values(byTeacher).map(t => ({
        ...t,
        groups: t.groups.size,
        profit: t.income - t.salary - t.hallCost
      }));
      
      const tbody = document.getElementById('tableBody');
      const tfoot = document.getElementById('tableFoot');
      
      if (teacherData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #94a3b8; padding: 30px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        tfoot.innerHTML = '';
        return;
      }
      
      tbody.innerHTML = teacherData.map(t => `
        <tr>
          <td style="font-weight: bold;">${t.teacher}</td>
          <td class="text-center">${t.sessions}</td>
          <td class="text-center"><span class="badge" style="background: #7c3aed;">${t.people}</span></td>
          <td class="text-right"><span class="amount green">${formatNumber(t.income)}‚ÇΩ</span></td>
          <td class="text-right"><span class="amount yellow">${formatNumber(t.salary)}‚ÇΩ</span></td>
          <td class="text-right"><span class="amount red">${formatNumber(t.hallCost)}‚ÇΩ</span></td>
          <td class="text-right"><span class="amount blue">${formatNumber(t.profit)}‚ÇΩ</span></td>
        </tr>
      `).join('');
      
      const totals = {
        sessions: sessions.length,
        people: sessions.reduce((s, x) => s + x.people, 0),
        income: teacherData.reduce((s, t) => s + t.income, 0),
        salary: teacherData.reduce((s, t) => s + t.salary, 0),
        hallCost: teacherData.reduce((s, t) => s + t.hallCost, 0) + expenses.reduce((s, e) => s + e.amount, 0),
        profit: teacherData.reduce((s, t) => s + t.profit, 0) - expenses.reduce((s, e) => s + e.amount, 0)
      };
      
      tfoot.innerHTML = `
        <tr>
          <td>–ò–¢–û–ì–û:</td>
          <td class="text-center">${totals.sessions}</td>
          <td class="text-center purple">${totals.people}</td>
          <td class="text-right green">${formatNumber(totals.income)}‚ÇΩ</td>
          <td class="text-right yellow">${formatNumber(totals.salary)}‚ÇΩ</td>
          <td class="text-right red">${formatNumber(totals.hallCost)}‚ÇΩ</td>
          <td class="text-right blue">${formatNumber(totals.profit)}‚ÇΩ</td>
        </tr>
      `;
    }
    
    window.addEventListener('click', e => {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('active');
      }
    });
    
    loadData();
  </script>
</body>
</html>
