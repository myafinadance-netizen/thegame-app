import React, { useState, useEffect } from 'react';
import { PlusCircle, Settings, BarChart3, FileDown, Trash2, Edit2, Save, X, Upload, Calendar } from 'lucide-react';

const DanceSchoolTracker = () => {
  const [activeTab, setActiveTab] = useState('input');
  const [records, setRecords] = useState([]);
  const [teachers, setTeachers] = useState([
    { id: 1, name: '–ò–≤–∞–Ω–æ–≤–∞ –ê.–ü.', rate: 40 },
    { id: 2, name: '–ü–µ—Ç—Ä–æ–≤–∞ –ú.–°.', rate: 40 }
  ]);
  const [groups, setGroups] = useState(['G-02250378', '–ì—Ä—É–ø–ø–∞ 2', '–ì—Ä—É–ø–ø–∞ 3', '–ì—Ä—É–ø–ø–∞ 4']);
  const [expenses, setExpenses] = useState({
    rent: 50000,
    utilities: 10000,
    water: 2000,
    admin: 30000,
    paymentRate: 280
  });
  
  // –ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ—Ç—á–µ—Ç–∞
  const [quickInputData, setQuickInputData] = useState({
    group: '',
    teacher: '',
    month: new Date().toISOString().slice(0, 7),
    sessionDates: '',
    totalVisits: '',
    totalSessions: ''
  });
  
  const [uploadedFile, setUploadedFile] = useState(null);
  const [isProcessing, setIsProcessing] = useState(false);
  
  const [formData, setFormData] = useState({
    group: '',
    date: new Date().toISOString().split('T')[0],
    teacher: '',
    count: ''
  });
  
  const [editingRecord, setEditingRecord] = useState(null);
  const [editingTeacher, setEditingTeacher] = useState(null);
  const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
  const [filterTeacher, setFilterTeacher] = useState('all');
  const [filterGroup, setFilterGroup] = useState('all');
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      if (window.storage) {
        const recordsData = await window.storage.get('dance_records');
        const teachersData = await window.storage.get('dance_teachers');
        const groupsData = await window.storage.get('dance_groups');
        const expensesData = await window.storage.get('dance_expenses');
        
        if (recordsData && recordsData.value) {
          setRecords(JSON.parse(recordsData.value));
        }
        if (teachersData && teachersData.value) {
          setTeachers(JSON.parse(teachersData.value));
        }
        if (groupsData && groupsData.value) {
          setGroups(JSON.parse(groupsData.value));
        }
        if (expensesData && expensesData.value) {
          setExpenses(JSON.parse(expensesData.value));
        }
      }
    } catch (error) {
      console.log('–ó–∞–≥—Ä—É–∑–∫–∞:', error.message);
    } finally {
      setIsLoading(false);
    }
  };

  const saveData = async () => {
    try {
      if (window.storage) {
        await window.storage.set('dance_records', JSON.stringify(records));
        await window.storage.set('dance_teachers', JSON.stringify(teachers));
        await window.storage.set('dance_groups', JSON.stringify(groups));
        await window.storage.set('dance_expenses', JSON.stringify(expenses));
      }
    } catch (error) {
      console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:', error.message);
    }
  };

  useEffect(() => {
    if (!isLoading) {
      saveData();
    }
  }, [records, teachers, groups, expenses]);

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
  const handleFileUpload = async (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    setUploadedFile(file);
    setIsProcessing(true);
    
    try {
      let text = '';
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ .docx —Ñ–∞–π–ª–æ–≤
      if (file.name.endsWith('.docx')) {
        const arrayBuffer = await file.arrayBuffer();
        const mammoth = window.mammoth || await import('mammoth');
        const result = await mammoth.extractRawText({ arrayBuffer });
        text = result.value;
      } 
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ .txt –∏ .doc (–∫–∞–∫ —Ç–µ–∫—Å—Ç)
      else {
        text = await file.text();
      }
      
      console.log('–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:', text.substring(0, 500));
      
      // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞
      // –ò—â–µ–º –∫–æ–¥ –≥—Ä—É–ø–ø—ã —Ç–∏–ø–∞ G-02250378
      const groupMatch = text.match(/[GG][-\s]*\d{8}/i);
      
      // –ò—â–µ–º –º–µ—Å—è—Ü –∏ –≥–æ–¥
      const monthMatch = text.match(/(—è–Ω–≤–∞—Ä[—å—è]|—Ñ–µ–≤—Ä–∞–ª[—å—è]|–º–∞—Ä—Ç[–∞]?|–∞–ø—Ä–µ–ª[—å—è]|–º–∞[–π—è]|–∏—é–Ω[—å—è]|–∏—é–ª[—å—è]|–∞–≤–≥—É—Å—Ç[–∞]?|—Å–µ–Ω—Ç—è–±—Ä[—å—è]|–æ–∫—Ç—è–±—Ä[—å—è]|–Ω–æ—è–±—Ä[—å—è]|–¥–µ–∫–∞–±—Ä[—å—è])\s*,?\s*(\d{4})/i);
      
      // –ò—â–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–µ—â–µ–Ω–∏–π (–æ–±—ã—á–Ω–æ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å—Ç—Ä–æ–∫–∞—Ö)
      const visitsMatch = text.match(/–ò—Ç–æ–≥–æ[^\d\n]*?(\d{1,4})\s*\d{1,4}/i) || 
                          text.match(/–≤—Å–µ–≥–æ[^\d]*?(\d{2,4})/i);
      
      // –ò—â–µ–º –≤—Å–µ –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM
      const allDatesMatches = text.matchAll(/(\d{2})\.(\d{2})/g);
      const datesSet = new Set();
      
      for (const match of allDatesMatches) {
        const day = match[1];
        const month = match[2];
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ (–¥–µ–Ω—å 1-31, –º–µ—Å—è—Ü 1-12)
        if (parseInt(day) >= 1 && parseInt(day) <= 31 && 
            parseInt(month) >= 1 && parseInt(month) <= 12) {
          datesSet.add(`${day}.${month}`);
        }
      }
      
      const uniqueDates = Array.from(datesSet).sort();
      
      console.log('–ù–∞–π–¥–µ–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∞:', groupMatch?.[0]);
      console.log('–ù–∞–π–¥–µ–Ω–Ω—ã–π –º–µ—Å—è—Ü:', monthMatch);
      console.log('–ù–∞–π–¥–µ–Ω–æ –ø–æ—Å–µ—â–µ–Ω–∏–π:', visitsMatch?.[1]);
      console.log('–ù–∞–π–¥–µ–Ω—ã –¥–∞—Ç—ã:', uniqueDates);
      
      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
      if (groupMatch) {
        const groupCode = groupMatch[0].replace(/\s/g, '');
        setQuickInputData(prev => ({...prev, group: groupCode}));
      }
      
      if (monthMatch) {
        const months = {
          '—è–Ω–≤–∞—Ä': '01', '—Ñ–µ–≤—Ä–∞–ª': '02', '–º–∞—Ä—Ç': '03', '–∞–ø—Ä–µ–ª': '04',
          '–º–∞–π': '05', '–º–∞': '05', '–∏—é–Ω': '06', '–∏—é–ª': '07', '–∞–≤–≥—É—Å—Ç': '08',
          '—Å–µ–Ω—Ç—è–±—Ä': '09', '–æ–∫—Ç—è–±—Ä': '10', '–Ω–æ—è–±—Ä': '11', '–¥–µ–∫–∞–±—Ä': '12'
        };
        const monthName = monthMatch[1].toLowerCase().replace(/[—å—è]$/, '');
        const monthNum = months[monthName];
        const year = monthMatch[2];
        if (monthNum && year) {
          setQuickInputData(prev => ({...prev, month: `${year}-${monthNum}`}));
        }
      }
      
      if (visitsMatch) {
        const totalVisits = parseInt(visitsMatch[1]);
        setQuickInputData(prev => ({...prev, totalVisits: totalVisits.toString()}));
      }
      
      if (uniqueDates.length > 0) {
        // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–∞—Ç—ã (–æ–±—ã—á–Ω–æ —ç—Ç–æ –¥–∞—Ç—ã –∑–∞–Ω—è—Ç–∏–π –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö)
        // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞—Ç—ã –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ä–∞–∑ (—Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —ç—Ç–æ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è)
        const sessionDates = uniqueDates.slice(0, 15); // –ú–∞–∫—Å–∏–º—É–º 15 –∑–∞–Ω—è—Ç–∏–π
        
        setQuickInputData(prev => ({
          ...prev, 
          sessionDates: sessionDates.join(', '),
          totalSessions: sessionDates.length.toString()
        }));
      }
      
      alert('‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω!\n\n' +
            '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ:\n' +
            (groupMatch ? `‚úì –ì—Ä—É–ø–ø–∞: ${groupMatch[0]}\n` : '') +
            (monthMatch ? `‚úì –ú–µ—Å—è—Ü: ${monthMatch[1]} ${monthMatch[2]}\n` : '') +
            (visitsMatch ? `‚úì –ü–æ—Å–µ—â–µ–Ω–∏–π: ${visitsMatch[1]}\n` : '') +
            (uniqueDates.length ? `‚úì –î–∞—Ç –∑–∞–Ω—è—Ç–∏–π: ${uniqueDates.length}\n\n` : '') +
            '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–µ–¥–∞–≥–æ–≥–∞!');
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞:', error);
      alert('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞.\n\n' +
            '–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n' +
            '‚Ä¢ –§–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω\n' +
            '‚Ä¢ –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç\n\n' +
            '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª—è –≤—Ä—É—á–Ω—É—é.');
    } finally {
      setIsProcessing(false);
    }
  };

  // –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–∑ –æ—Ç—á–µ—Ç–∞
  const addQuickReport = () => {
    console.log('–§—É–Ω–∫—Ü–∏—è addQuickReport –≤—ã–∑–≤–∞–Ω–∞');
    console.log('–¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ:', quickInputData);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–µ–π
    if (!quickInputData.group) {
      alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É');
      return;
    }
    
    if (!quickInputData.teacher) {
      alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ–¥–∞–≥–æ–≥–∞');
      return;
    }
    
    if (!quickInputData.totalSessions) {
      alert('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–Ω—è—Ç–∏–π');
      return;
    }
    
    if (!quickInputData.totalVisits) {
      alert('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–µ—â–µ–Ω–∏–π');
      return;
    }

    const totalVisits = parseInt(quickInputData.totalVisits);
    const totalSessions = parseInt(quickInputData.totalSessions);
    
    console.log('–ü–æ—Å–µ—â–µ–Ω–∏–π:', totalVisits, '–ó–∞–Ω—è—Ç–∏–π:', totalSessions);
    
    if (isNaN(totalVisits) || isNaN(totalSessions) || totalVisits <= 0 || totalSessions <= 0) {
      alert('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —á–∏—Å–ª–∞');
      return;
    }

    const avgPerSession = Math.round(totalVisits / totalSessions);
    console.log('–°—Ä–µ–¥–Ω–µ–µ –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ:', avgPerSession);

    // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—ã
    let dates = [];
    const year = quickInputData.month.split('-')[0];
    const month = quickInputData.month.split('-')[1];
    
    if (quickInputData.sessionDates.trim()) {
      const dateStrings = quickInputData.sessionDates.split(',');
      console.log('–ü–∞—Ä—Å–∏–º –¥–∞—Ç—ã:', dateStrings);
      
      for (let dateStr of dateStrings) {
        const cleaned = dateStr.trim();
        const dayMatch = cleaned.match(/(\d{1,2})/);
        if (dayMatch) {
          const day = dayMatch[1].padStart(2, '0');
          dates.push(`${year}-${month}-${day}`);
        }
      }
    }
    
    console.log('–†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞—Ç—ã:', dates);

    // –ï—Å–ª–∏ –¥–∞—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –¥–æ–±–∞–≤–ª—è–µ–º
    while (dates.length < totalSessions) {
      const yearNum = parseInt(year);
      const monthNum = parseInt(month) - 1;
      const daysInMonth = new Date(yearNum, monthNum + 1, 0).getDate();
      const day = Math.min(dates.length + 1, daysInMonth);
      dates.push(`${year}-${month}-${String(day).padStart(2, '0')}`);
    }

    // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å–∏
    const newRecords = [];
    let remainingVisits = totalVisits;
    
    for (let i = 0; i < totalSessions; i++) {
      const count = i < totalSessions - 1 ? avgPerSession : remainingVisits;
      remainingVisits -= count;
      
      newRecords.push({
        id: Date.now() + i,
        group: quickInputData.group,
        date: dates[i] || dates[0],
        teacher: quickInputData.teacher,
        count: count
      });
    }
    
    console.log('–°–æ–∑–¥–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π:', newRecords);

    try {
      setRecords([...records, ...newRecords]);
      console.log('–ó–∞–ø–∏—Å–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ state');
      
      setQuickInputData({
        group: '',
        teacher: '',
        month: new Date().toISOString().slice(0, 7),
        sessionDates: '',
        totalVisits: '',
        totalSessions: ''
      });
      
      alert(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${newRecords.length} –∑–∞–ø–∏—Å–µ–π! –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É "–ü–æ –¥–∞—Ç–∞–º" —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Ö.`);
      setActiveTab('input');
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞:', error);
      alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏: ' + error.message);
    }
  };

  const addRecord = () => {
    if (!formData.group || !formData.date || !formData.teacher || !formData.count) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
      return;
    }

    const newRecord = {
      id: Date.now(),
      group: formData.group,
      date: formData.date,
      teacher: formData.teacher,
      count: parseInt(formData.count)
    };

    setRecords([...records, newRecord]);
    setFormData({
      group: '',
      date: new Date().toISOString().split('T')[0],
      teacher: '',
      count: ''
    });
  };

  const updateRecord = () => {
    setRecords(records.map(r => r.id === editingRecord.id ? editingRecord : r));
    setEditingRecord(null);
  };

  const deleteRecord = (id) => {
    if (window.confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) {
      setRecords(records.filter(r => r.id !== id));
    }
  };

  const addTeacher = () => {
    const name = window.prompt('–ò–º—è –ø–µ–¥–∞–≥–æ–≥–∞:');
    if (!name) return;
    const rateStr = window.prompt('–°—Ç–∞–≤–∫–∞ % (–Ω–∞–ø—Ä–∏–º–µ—Ä, 40):');
    if (!rateStr) return;
    const rate = parseInt(rateStr);
    if (isNaN(rate)) {
      alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è —Å—Ç–∞–≤–∫–∏');
      return;
    }
    setTeachers([...teachers, { id: Date.now(), name, rate }]);
  };

  const updateTeacher = () => {
    setTeachers(teachers.map(t => t.id === editingTeacher.id ? editingTeacher : t));
    setEditingTeacher(null);
  };

  const deleteTeacher = (id) => {
    if (window.confirm('–£–¥–∞–ª–∏—Ç—å –ø–µ–¥–∞–≥–æ–≥–∞?')) {
      setTeachers(teachers.filter(t => t.id !== id));
    }
  };

  const addGroup = () => {
    const name = window.prompt('–ù–∞–∑–≤–∞–Ω–∏–µ/–∫–æ–¥ –≥—Ä—É–ø–ø—ã:');
    if (name && !groups.includes(name)) {
      setGroups([...groups, name]);
    }
  };

  const updateGroup = (oldName) => {
    const newName = window.prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:', oldName);
    if (newName && newName !== oldName) {
      setGroups(groups.map(g => g === oldName ? newName : g));
      setRecords(records.map(r => r.group === oldName ? {...r, group: newName} : r));
    }
  };

  const deleteGroup = (name) => {
    if (window.confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?')) {
      setGroups(groups.filter(g => g !== name));
    }
  };

  const getFilteredRecords = () => {
    return records.filter(r => {
      const recordMonth = r.date.slice(0, 7);
      const matchMonth = recordMonth === selectedMonth;
      const matchTeacher = filterTeacher === 'all' || r.teacher === filterTeacher;
      const matchGroup = filterGroup === 'all' || r.group === filterGroup;
      return matchMonth && matchTeacher && matchGroup;
    });
  };

  const calculateStats = () => {
    const filtered = getFilteredRecords();
    const byTeacher = {};

    filtered.forEach(record => {
      if (!byTeacher[record.teacher]) {
        byTeacher[record.teacher] = {
          name: record.teacher,
          days: new Set(),
          totalVisits: 0,
          records: [],
          groupStats: {}
        };
      }
      byTeacher[record.teacher].days.add(record.date);
      byTeacher[record.teacher].totalVisits += record.count;
      byTeacher[record.teacher].records.push(record);
      
      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥—Ä—É–ø–ø–∞–º
      if (!byTeacher[record.teacher].groupStats[record.group]) {
        byTeacher[record.teacher].groupStats[record.group] = {
          sessions: 0,
          visits: 0
        };
      }
      byTeacher[record.teacher].groupStats[record.group].sessions++;
      byTeacher[record.teacher].groupStats[record.group].visits += record.count;
    });

    return Object.values(byTeacher).map(t => {
      const teacher = teachers.find(te => te.name === t.name);
      const rate = teacher ? teacher.rate : 40;
      const income = t.totalVisits * expenses.paymentRate;
      const salary = income * (rate / 100);
      
      return {
        name: t.name,
        workDays: t.days.size,
        totalVisits: t.totalVisits,
        income,
        salary,
        rate,
        groupStats: t.groupStats
      };
    });
  };

  const calculateTotals = () => {
    const stats = calculateStats();
    const totalIncome = stats.reduce((sum, t) => sum + t.income, 0);
    const totalSalaries = stats.reduce((sum, t) => sum + t.salary, 0);
    const totalExpenses = expenses.rent + expenses.utilities + expenses.water + expenses.admin;
    const netProfit = totalIncome - totalSalaries - totalExpenses;

    return { totalIncome, totalSalaries, totalExpenses, netProfit, stats };
  };

  const exportToCSV = () => {
    const stats = calculateStats();
    let csv = '–ü–µ–¥–∞–≥–æ–≥,–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π,–í—Å–µ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏–π,–î–æ—Ö–æ–¥ –æ—Ç –≥–æ—Å-–≤–∞,–°—Ç–∞–≤–∫–∞ %,–ó–∞—Ä–ø–ª–∞—Ç–∞\n';
    
    stats.forEach(s => {
      csv += `${s.name},${s.workDays},${s.totalVisits},${s.income},${s.rate}%,${s.salary}\n`;
    });

    csv += '\n\n–î–µ—Ç–∞–ª–∏ –ø–æ –≥—Ä—É–ø–ø–∞–º\n';
    csv += '–ü–µ–¥–∞–≥–æ–≥,–ì—Ä—É–ø–ø–∞,–ó–∞–Ω—è—Ç–∏–π,–ü–æ—Å–µ—â–µ–Ω–∏–π,–î–æ—Ö–æ–¥\n';
    stats.forEach(s => {
      Object.entries(s.groupStats).forEach(([group, data]) => {
        const groupIncome = data.visits * expenses.paymentRate;
        csv += `${s.name},${group},${data.sessions},${data.visits},${groupIncome}\n`;
      });
    });

    const totals = calculateTotals();
    csv += '\n\n–ò—Ç–æ–≥–∏\n';
    csv += `–û–±—â–∏–π –¥–æ—Ö–æ–¥,${totals.totalIncome}\n`;
    csv += `–ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤,${totals.totalSalaries}\n`;
    csv += `–ê—Ä–µ–Ω–¥–∞ –∑–∞–ª–∞,${expenses.rent}\n`;
    csv += `–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ,${expenses.utilities}\n`;
    csv += `–í–æ–¥–∞,${expenses.water}\n`;
    csv += `–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä,${expenses.admin}\n`;
    csv += `–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã,${totals.totalExpenses}\n`;
    csv += `–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å –∫–æ–º–ø–∞–Ω–∏–∏,${totals.netProfit}\n`;

    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `–æ—Ç—á–µ—Ç_${selectedMonth}.csv`;
    link.click();
  };

  const totals = calculateTotals();

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 flex items-center justify-center">
        <div className="text-2xl text-purple-700">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 p-4">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
          <h1 className="text-3xl font-bold text-purple-700 mb-2">–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ</h1>
          <p className="text-gray-600">–°–∏—Å—Ç–µ–º–∞ —É—á–µ—Ç–∞ —Ç–∞–Ω—Ü–µ–≤–∞–ª—å–Ω–æ–π —à–∫–æ–ª—ã –ê–ù–û "–ê–§–ò–ù–ê"</p>
        </div>

        <div className="bg-white rounded-lg shadow-lg mb-6">
          <div className="flex border-b overflow-x-auto">
            <button
              onClick={() => setActiveTab('quick')}
              className={`px-6 py-3 font-medium flex items-center gap-2 whitespace-nowrap ${activeTab === 'quick' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'}`}
            >
              <Upload size={20} /> –ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥
            </button>
            <button
              onClick={() => setActiveTab('input')}
              className={`px-6 py-3 font-medium flex items-center gap-2 whitespace-nowrap ${activeTab === 'input' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'}`}
            >
              <Calendar size={20} /> –ü–æ –¥–∞—Ç–∞–º
            </button>
            <button
              onClick={() => setActiveTab('reports')}
              className={`px-6 py-3 font-medium flex items-center gap-2 whitespace-nowrap ${activeTab === 'reports' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'}`}
            >
              <BarChart3 size={20} /> –û—Ç—á–µ—Ç—ã
            </button>
            <button
              onClick={() => setActiveTab('settings')}
              className={`px-6 py-3 font-medium flex items-center gap-2 whitespace-nowrap ${activeTab === 'settings' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'}`}
            >
              <Settings size={20} /> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
          </div>

          <div className="p-6">
            {activeTab === 'quick' && (
              <div>
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                  <h3 className="font-bold text-blue-900 mb-2">üí° –ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ –∏–∑ –æ—Ç—á–µ—Ç–∞</h3>
                  <p className="text-sm text-blue-800">
                    –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –æ—Ç—á–µ—Ç–∞ –∏–ª–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –≤—Ä—É—á–Ω—É—é
                  </p>
                </div>

                {/* –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ */}
                <div className="mb-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-6 border-2 border-dashed border-purple-300">
                  <label className="block cursor-pointer">
                    <div className="text-center">
                      <Upload size={48} className="mx-auto mb-3 text-purple-600" />
                      <h4 className="text-lg font-bold text-gray-800 mb-2">
                        {uploadedFile ? '‚úÖ ' + uploadedFile.name : 'üìÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á–µ—Ç Word'}
                      </h4>
                      <p className="text-sm text-gray-600 mb-3">
                        {uploadedFile 
                          ? '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥—Ä—É–≥–æ–≥–æ —Ñ–∞–π–ª–∞' 
                          : '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ—á–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–µ–¥–æ–º–æ—Å—Ç–∏'}
                      </p>
                      <div className="bg-purple-600 text-white px-6 py-3 rounded-lg inline-block hover:bg-purple-700 active:bg-purple-800 transition font-medium">
                        {isProcessing ? '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...' : 'üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª DOCX'}
                      </div>
                      <p className="text-xs text-gray-500 mt-3">
                        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: .docx, .doc, .txt
                      </p>
                    </div>
                    <input
                      type="file"
                      accept=".doc,.docx,.txt"
                      onChange={handleFileUpload}
                      className="hidden"
                      disabled={isProcessing}
                    />
                  </label>
                </div>

                <div className="border-t-2 border-gray-200 my-6 pt-6">
                  <h4 className="font-semibold text-gray-700 mb-4">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ:</h4>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      –ö–æ–¥ –≥—Ä—É–ø–ø—ã <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      list="groups-list"
                      value={quickInputData.group}
                      onChange={(e) => setQuickInputData({...quickInputData, group: e.target.value})}
                      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none text-base"
                      placeholder="G-02250378 –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ"
                    />
                    <datalist id="groups-list">
                      {groups.map(g => <option key={g} value={g}>{g}</option>)}
                    </datalist>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      –ü–µ–¥–∞–≥–æ–≥ <span className="text-red-500">*</span>
                    </label>
                    <select
                      value={quickInputData.teacher}
                      onChange={(e) => setQuickInputData({...quickInputData, teacher: e.target.value})}
                      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none text-base"
                    >
                      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ–¥–∞–≥–æ–≥–∞</option>
                      {teachers.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      –ú–µ—Å—è—Ü <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="month"
                      value={quickInputData.month}
                      onChange={(e) => setQuickInputData({...quickInputData, month: e.target.value})}
                      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none text-base"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      –í—Å–µ–≥–æ –∑–∞–Ω—è—Ç–∏–π –∑–∞ –º–µ—Å—è—Ü <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="number"
                      value={quickInputData.totalSessions}
                      onChange={(e) => setQuickInputData({...quickInputData, totalSessions: e.target.value})}
                      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none text-base"
                      placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 8"
                      min="1"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      –í—Å–µ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏–π –∑–∞ –º–µ—Å—è—Ü <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="number"
                      value={quickInputData.totalVisits}
                      onChange={(e) => setQuickInputData({...quickInputData, totalVisits: e.target.value})}
                      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none text-base"
                      placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 208"
                      min="1"
                    />
                  </div>

                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      –î–∞—Ç—ã –∑–∞–Ω—è—Ç–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                    </label>
                    <input
                      type="text"
                      value={quickInputData.sessionDates}
                      onChange={(e) => setQuickInputData({...quickInputData, sessionDates: e.target.value})}
                      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none text-base"
                      placeholder="04.11, 06.11, 11.11, 13.11..."
                    />
                    <p className="text-xs text-gray-500 mt-1">–ß–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ</p>
                  </div>
                </div>

                <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                  <h4 className="font-semibold text-green-900 mb-2">üìä –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞—Å—á–µ—Ç–∞</h4>
                  {quickInputData.totalVisits && quickInputData.totalSessions ? (
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                      <div>
                        <p className="text-gray-600">–ó–∞–Ω—è—Ç–∏–π:</p>
                        <p className="font-bold text-lg">{quickInputData.totalSessions}</p>
                      </div>
                      <div>
                        <p className="text-gray-600">–ü–æ—Å–µ—â–µ–Ω–∏–π:</p>
                        <p className="font-bold text-lg">{quickInputData.totalVisits}</p>
                      </div>
                      <div>
                        <p className="text-gray-600">–°—Ä–µ–¥–Ω–µ–µ –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ:</p>
                        <p className="font-bold text-lg">
                          {Math.round(parseInt(quickInputData.totalVisits) / parseInt(quickInputData.totalSessions))} —á–µ–ª
                        </p>
                      </div>
                      <div>
                        <p className="text-gray-600">–î–æ—Ö–æ–¥ –æ—Ç –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞:</p>
                        <p className="font-bold text-lg text-green-600">
                          {(parseInt(quickInputData.totalVisits) * expenses.paymentRate).toLocaleString('ru-RU')} ‚ÇΩ
                        </p>
                      </div>
                    </div>
                  ) : (
                    <p className="text-gray-600 text-sm">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–Ω—è—Ç–∏–π –∏ –ø–æ—Å–µ—â–µ–Ω–∏–π –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞</p>
                  )}
                </div>

                <button
                  onClick={() => {
                    console.log('–ö–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É');
                    console.log('–î–∞–Ω–Ω—ã–µ:', quickInputData);
                    addQuickReport();
                  }}
                  className="w-full bg-purple-600 text-white px-8 py-4 rounded-lg hover:bg-purple-700 active:bg-purple-800 flex items-center justify-center gap-2 transition font-medium text-lg"
                >
                  <Upload size={24} /> –î–æ–±–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç
                </button>

                <div className="mt-8 bg-gray-50 rounded-lg p-4">
                  <h4 className="font-semibold mb-2">üìã –ü—Ä–∏–º–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è:</h4>
                  <ul className="text-sm space-y-1 text-gray-700">
                    <li>‚Ä¢ <strong>–ö–æ–¥ –≥—Ä—É–ø–ø—ã:</strong> G-02250378</li>
                    <li>‚Ä¢ <strong>–ü–µ–¥–∞–≥–æ–≥:</strong> –ò–≤–∞–Ω–æ–≤–∞ –ê.–ü.</li>
                    <li>‚Ä¢ <strong>–ú–µ—Å—è—Ü:</strong> 2025-11 (–Ω–æ—è–±—Ä—å 2025)</li>
                    <li>‚Ä¢ <strong>–í—Å–µ–≥–æ –∑–∞–Ω—è—Ç–∏–π:</strong> 8</li>
                    <li>‚Ä¢ <strong>–í—Å–µ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏–π:</strong> 208</li>
                    <li>‚Ä¢ <strong>–î–∞—Ç—ã:</strong> 04.11, 06.11, 11.11, 13.11, 18.11, 20.11, 25.11, 27.11</li>
                  </ul>
                </div>
              </div>
            )}

            {activeTab === 'input' && (
              <div>
                <h3 className="text-lg font-bold mb-4">–†—É—á–Ω–æ–π –≤–≤–æ–¥ –ø–æ –¥–∞—Ç–∞–º</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">–ì—Ä—É–ø–ø–∞</label>
                    <select
                      value={formData.group}
                      onChange={(e) => setFormData({...formData, group: e.target.value})}
                      className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                    >
                      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>
                      {groups.map(g => <option key={g} value={g}>{g}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">–î–∞—Ç–∞</label>
                    <input
                      type="date"
                      value={formData.date}
                      onChange={(e) => setFormData({...formData, date: e.target.value})}
                      className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">–ü–µ–¥–∞–≥–æ–≥</label>
                    <select
                      value={formData.teacher}
                      onChange={(e) => setFormData({...formData, teacher: e.target.value})}
                      className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                    >
                      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ–¥–∞–≥–æ–≥–∞</option>
                      {teachers.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">–ß–µ–ª–æ–≤–µ–∫</label>
                    <input
                      type="number"
                      value={formData.count}
                      onChange={(e) => setFormData({...formData, count: e.target.value})}
                      className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                      placeholder="0"
                      min="0"
                    />
                  </div>
                </div>
                <button
                  onClick={addRecord}
                  className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2 transition"
                >
                  <PlusCircle size={20} /> –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
                </button>

                <div className="mt-8">
                  <h3 className="text-xl font-bold mb-4">–í—Å–µ –∑–∞–ø–∏—Å–∏</h3>
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="bg-purple-100">
                          <th className="p-3 text-left">–î–∞—Ç–∞</th>
                          <th className="p-3 text-left">–ì—Ä—É–ø–ø–∞</th>
                          <th className="p-3 text-left">–ü–µ–¥–∞–≥–æ–≥</th>
                          <th className="p-3 text-left">–ß–µ–ª–æ–≤–µ–∫</th>
                          <th className="p-3 text-center" style={{minWidth: '100px'}}>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                      </thead>
                      <tbody>
                        {records.length === 0 ? (
                          <tr>
                            <td colSpan="5" className="p-6 text-center text-gray-500">
                              –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥" –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≤—Ä—É—á–Ω—É—é.
                            </td>
                          </tr>
                        ) : (
                          records
                            .sort((a, b) => new Date(b.date) - new Date(a.date))
                            .map(record => (
                              editingRecord?.id === record.id ? (
                                <tr key={record.id} className="border-b bg-blue-50">
                                  <td className="p-3">
                                    <input
                                      type="date"
                                      value={editingRecord.date}
                                      onChange={(e) => setEditingRecord({...editingRecord, date: e.target.value})}
                                      className="p-2 border rounded w-full text-sm"
                                    />
                                  </td>
                                  <td className="p-3">
                                    <select
                                      value={editingRecord.group}
                                      onChange={(e) => setEditingRecord({...editingRecord, group: e.target.value})}
                                      className="p-2 border rounded w-full text-sm"
                                    >
                                      {groups.map(g => <option key={g} value={g}>{g}</option>)}
                                    </select>
                                  </td>
                                  <td className="p-3">
                                    <select
                                      value={editingRecord.teacher}
                                      onChange={(e) => setEditingRecord({...editingRecord, teacher: e.target.value})}
                                      className="p-2 border rounded w-full text-sm"
                                    >
                                      {teachers.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                    </select>
                                  </td>
                                  <td className="p-3">
                                    <input
                                      type="number"
                                      value={editingRecord.count}
                                      onChange={(e) => setEditingRecord({...editingRecord, count: parseInt(e.target.value) || 0})}
                                      className="p-2 border rounded w-20 text-sm"
                                    />
                                  </td>
                                  <td className="p-3 text-center">
                                    <button 
                                      onClick={updateRecord} 
                                      className="text-green-600 hover:text-green-800 mr-3 p-2 active:bg-green-100 rounded" 
                                      title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
                                    >
                                      <Save size={20} />
                                    </button>
                                    <button 
                                      onClick={() => setEditingRecord(null)} 
                                      className="text-gray-600 hover:text-gray-800 p-2 active:bg-gray-100 rounded" 
                                      title="–û—Ç–º–µ–Ω–∞"
                                    >
                                      <X size={20} />
                                    </button>
                                  </td>
                                </tr>
                              ) : (
                                <tr key={record.id} className="border-b hover:bg-gray-50">
                                  <td className="p-3">{new Date(record.date).toLocaleDateString('ru-RU')}</td>
                                  <td className="p-3">{record.group}</td>
                                  <td className="p-3">{record.teacher}</td>
                                  <td className="p-3">{record.count}</td>
                                  <td className="p-3 text-center">
                                    <button 
                                      onClick={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        setEditingRecord(record);
                                      }} 
                                      className="text-blue-600 hover:text-blue-800 mr-3 p-2 active:bg-blue-100 rounded inline-block cursor-pointer touch-manipulation relative z-10"
                                      style={{WebkitTapHighlightColor: 'transparent'}}
                                      title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                                    >
                                      <Edit2 size={20} />
                                    </button>
                                    <button 
                                      onClick={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        deleteRecord(record.id);
                                      }} 
                                      className="text-red-600 hover:text-red-800 p-2 active:bg-red-100 rounded inline-block cursor-pointer touch-manipulation relative z-10"
                                      style={{WebkitTapHighlightColor: 'transparent'}}
                                      title="–£–¥–∞–ª–∏—Ç—å"
                                    >
                                      <Trash2 size={20} />
                                    </button>
                                  </td>
                                </tr>
                              )
                            ))
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'reports' && (
              <div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">–ú–µ—Å—è—Ü</label>
                    <input
                      type="month"
                      value={selectedMonth}
                      onChange={(e) => setSelectedMonth(e.target.value)}
                      className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">–ü–µ–¥–∞–≥–æ–≥</label>
                    <select
                      value={filterTeacher}
                      onChange={(e) => setFilterTeacher(e.target.value)}
                      className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                    >
                      <option value="all">–í—Å–µ –ø–µ–¥–∞–≥–æ–≥–∏</option>
                      {teachers.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">–ì—Ä—É–ø–ø–∞</label>
                    <select
                      value={filterGroup}
                      onChange={(e) => setFilterGroup(e.target.value)}
                      className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                    >
                      <option value="all">–í—Å–µ –≥—Ä—É–ø–ø—ã</option>
                      {groups.map(g => <option key={g} value={g}>{g}</option>)}
                    </select>
                  </div>
                </div>

                <button
                  onClick={exportToCSV}
                  className="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2 mb-6 transition"
                >
                  <FileDown size={20} /> –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                </button>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                  <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-lg shadow-lg">
                    <p className="text-sm opacity-90 mb-1">–û–±—â–∏–π –¥–æ—Ö–æ–¥</p>
                    <p className="text-3xl font-bold">{totals.totalIncome.toLocaleString('ru-RU')} ‚ÇΩ</p>
                    <p className="text-xs opacity-75 mt-1">–æ—Ç –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞</p>
                  </div>
                  <div className="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-lg shadow-lg">
                    <p className="text-sm opacity-90 mb-1">–ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤</p>
                    <p className="text-3xl font-bold">{totals.totalSalaries.toLocaleString('ru-RU')} ‚ÇΩ</p>
                    <p className="text-xs opacity-75 mt-1">–ø–æ —Å—Ç–∞–≤–∫–∞–º</p>
                  </div>
                  <div className="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6 rounded-lg shadow-lg">
                    <p className="text-sm opacity-90 mb-1">–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</p>
                    <p className="text-3xl font-bold">{totals.totalExpenses.toLocaleString('ru-RU')} ‚ÇΩ</p>
                    <p className="text-xs opacity-75 mt-1">–∞—Ä–µ–Ω–¥–∞ + —É—Å–ª—É–≥–∏</p>
                  </div>
                  <div className="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-lg shadow-lg">
                    <p className="text-sm opacity-90 mb-1">–ü—Ä–∏–±—ã–ª—å –∫–æ–º–ø–∞–Ω–∏–∏</p>
                    <p className="text-3xl font-bold">{totals.netProfit.toLocaleString('ru-RU')} ‚ÇΩ</p>
                    <p className="text-xs opacity-75 mt-1">—á–∏—Å—Ç–∞—è</p>
                  </div>
                </div>

                <h3 className="text-xl font-bold mb-4">–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –ø–µ–¥–∞–≥–æ–≥–∞–º</h3>
                <div className="space-y-6">
                  {totals.stats.length === 0 ? (
                    <p className="text-center text-gray-500 py-8">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
                  ) : (
                    totals.stats.map((stat, idx) => (
                      <div key={idx} className="bg-white border border-gray-200 rounded-lg p-6 shadow">
                        <div className="flex justify-between items-start mb-4">
                          <div>
                            <h4 className="text-xl font-bold text-gray-800">{stat.name}</h4>
                            <p className="text-sm text-gray-600">–°—Ç–∞–≤–∫–∞: {stat.rate}%</p>
                          </div>
                          <div className="text-right">
                            <p className="text-2xl font-bold text-green-600">{stat.salary.toLocaleString('ru-RU')} ‚ÇΩ</p>
                            <p className="text-sm text-gray-600">–∑–∞—Ä–ø–ª–∞—Ç–∞</p>
                          </div>
                        </div>
                        
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                          <div className="bg-blue-50 p-3 rounded">
                            <p className="text-xs text-gray-600">–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π</p>
                            <p className="text-2xl font-bold text-blue-700">{stat.workDays}</p>
                          </div>
                          <div className="bg-purple-50 p-3 rounded">
                            <p className="text-xs text-gray-600">–í—Å–µ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏–π</p>
                            <p className="text-2xl font-bold text-purple-700">{stat.totalVisits}</p>
                          </div>
                          <div className="bg-green-50 p-3 rounded">
                            <p className="text-xs text-gray-600">–î–æ—Ö–æ–¥ –æ—Ç –≥–æ—Å-–≤–∞</p>
                            <p className="text-2xl font-bold text-green-700">{stat.income.toLocaleString('ru-RU')} ‚ÇΩ</p>
                          </div>
                          <div className="bg-orange-50 p-3 rounded">
                            <p className="text-xs text-gray-600">–ü—Ä–∏–±—ã–ª—å –∫–æ–º–ø–∞–Ω–∏–∏</p>
                            <p className="text-2xl font-bold text-orange-700">{(stat.income - stat.salary).toLocaleString('ru-RU')} ‚ÇΩ</p>
                          </div>
                        </div>

                        <div>
                          <h5 className="font-semibold text-sm text-gray-700 mb-2">–ü–æ –≥—Ä—É–ø–ø–∞–º:</h5>
                          <div className="space-y-2">
                            {Object.entries(stat.groupStats).map(([group, data]) => (
                              <div key={group} className="flex justify-between items-center bg-gray-50 p-3 rounded">
                                <span className="font-medium">{group}</span>
                                <div className="text-right text-sm">
                                  <span className="text-gray-600">{data.sessions} –∑–∞–Ω—è—Ç–∏–π ‚Ä¢ {data.visits} –ø–æ—Å–µ—â–µ–Ω–∏–π</span>
                                  <span className="ml-3 font-bold text-green-600">
                                    {(data.visits * expenses.paymentRate).toLocaleString('ru-RU')} ‚ÇΩ
                                  </span>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            )}

            {activeTab === 'settings' && (
              <div>
                <div className="mb-8">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-xl font-bold">–ü–µ–¥–∞–≥–æ–≥–∏</h3>
                    <button
                      onClick={addTeacher}
                      className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 active:bg-purple-800 flex items-center gap-2 transition"
                    >
                      <PlusCircle size={18} /> –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                  </div>
                  <div className="space-y-3">
                    {teachers.map(t => (
                      editingTeacher?.id === t.id ? (
                        <div key={t.id} className="flex gap-2 items-center bg-blue-50 p-4 rounded-lg">
                          <input
                            type="text"
                            value={editingTeacher.name}
                            onChange={(e) => setEditingTeacher({...editingTeacher, name: e.target.value})}
                            className="flex-1 p-3 border rounded text-base"
                            placeholder="–ò–º—è"
                          />
                          <input
                            type="number"
                            value={editingTeacher.rate}
                            onChange={(e) => setEditingTeacher({...editingTeacher, rate: parseInt(e.target.value) || 0})}
                            className="w-24 p-3 border rounded text-base"
                            placeholder="%"
                          />
                          <button 
                            onClick={updateTeacher} 
                            className="text-green-600 hover:text-green-800 active:bg-green-100 p-3 rounded-lg min-w-[44px] min-h-[44px] flex items-center justify-center" 
                            title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
                          >
                            <Save size={24} />
                          </button>
                          <button 
                            onClick={() => setEditingTeacher(null)} 
                            className="text-gray-600 hover:text-gray-800 active:bg-gray-100 p-3 rounded-lg min-w-[44px] min-h-[44px] flex items-center justify-center" 
                            title="–û—Ç–º–µ–Ω–∞"
                          >
                            <X size={24} />
                          </button>
                        </div>
                      ) : (
                        <div key={t.id} className="flex justify-between items-center bg-gray-50 p-4 rounded-lg hover:bg-gray-100">
                          <div className="flex-1">
                            <span className="font-medium text-base">{t.name}</span>
                            <span className="text-gray-600 ml-4 text-sm">–°—Ç–∞–≤–∫–∞: {t.rate}%</span>
                          </div>
                          <div className="flex gap-2 relative z-10">
                            <button 
                              onClick={(e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                setEditingTeacher(t);
                              }} 
                              className="text-blue-600 hover:text-blue-800 active:bg-blue-100 p-3 rounded-lg min-w-[44px] min-h-[44px] flex items-center justify-center cursor-pointer touch-manipulation"
                              style={{WebkitTapHighlightColor: 'transparent'}}
                              title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                            >
                              <Edit2 size={24} />
                            </button>
                            <button 
                              onClick={(e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                deleteTeacher(t.id);
                              }} 
                              className="text-red-600 hover:text-red-800 active:bg-red-100 p-3 rounded-lg min-w-[44px] min-h-[44px] flex items-center justify-center cursor-pointer touch-manipulation" 
                              style={{WebkitTapHighlightColor: 'transparent'}}
                              title="–£–¥–∞–ª–∏—Ç—å"
                            >
                              <Trash2 size={24} />
                            </button>
                          </div>
                        </div>
                      )
                    ))}
                  </div>
                </div>

                <div className="mb-8">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-xl font-bold">–ì—Ä—É–ø–ø—ã</h3>
                    <button
                      onClick={addGroup}
                      className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 active:bg-purple-800 flex items-center gap-2 transition"
                    >
                      <PlusCircle size={18} /> –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                  </div>
                  <div className="space-y-3">
                    {groups.map(g => (
                      <div key={g} className="flex justify-between items-center bg-gray-50 p-4 rounded-lg hover:bg-gray-100">
                        <span className="font-medium text-base flex-1">{g}</span>
                        <div className="flex gap-2 relative z-10">
                          <button 
                            onClick={(e) => {
                              e.preventDefault();
                              e.stopPropagation();
                              updateGroup(g);
                            }} 
                            className="text-blue-600 hover:text-blue-800 active:bg-blue-100 p-3 rounded-lg min-w-[44px] min-h-[44px] flex items-center justify-center cursor-pointer touch-manipulation"
                            style={{WebkitTapHighlightColor: 'transparent'}}
                            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                          >
                            <Edit2 size={24} />
                          </button>
                          <button 
                            onClick={(e) => {
                              e.preventDefault();
                              e.stopPropagation();
                              deleteGroup(g);
                            }} 
                            className="text-red-600 hover:text-red-800 active:bg-red-100 p-3 rounded-lg min-w-[44px] min-h-[44px] flex items-center justify-center cursor-pointer touch-manipulation"
                            style={{WebkitTapHighlightColor: 'transparent'}}
                            title="–£–¥–∞–ª–∏—Ç—å"
                          >
                            <Trash2 size={24} />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <div>
                  <h3 className="text-xl font-bold mb-4">–†–∞—Å—Ö–æ–¥—ã</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">–ê—Ä–µ–Ω–¥–∞ –∑–∞–ª–∞ (‚ÇΩ)</label>
                      <input
                        type="number"
                        value={expenses.rent}
                        onChange={(e) => setExpenses({...expenses, rent: parseInt(e.target.value) || 0})}
                        className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ (‚ÇΩ)</label>
                      <input
                        type="number"
                        value={expenses.utilities}
                        onChange={(e) => setExpenses({...expenses, utilities: parseInt(e.target.value) || 0})}
                        className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">–í–æ–¥–∞/–∫—É–ª–µ—Ä (‚ÇΩ)</label>
                      <input
                        type="number"
                        value={expenses.water}
                        onChange={(e) => setExpenses({...expenses, water: parseInt(e.target.value) || 0})}
                        className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">–ó–∞—Ä–ø–ª–∞—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (‚ÇΩ)</label>
                      <input
                        type="number"
                        value={expenses.admin}
                        onChange={(e) => setExpenses({...expenses, admin: parseInt(e.target.value) || 0})}
                        className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">–°—Ç–∞–≤–∫–∞ –æ—Ç –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞ (‚ÇΩ)</label>
                      <input
                        type="number"
                        value={expenses.paymentRate}
                        onChange={(e) => setExpenses({...expenses, paymentRate: parseInt(e.target.value) || 0})}
                        className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                      />
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

export default DanceSchoolTracker;
