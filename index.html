<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TheGame ‚Äî –£—á—ë—Ç –¥–æ—Ö–æ–¥–æ–≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: #0f172a; 
      color: #fff; 
      padding: 16px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    
    h1 { font-size: 24px; margin-bottom: 8px; }
    h2 { font-size: 18px; margin-bottom: 16px; }
    
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .progress-bar-container { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
    }
    .progress-bar {
      width: 200px;
      height: 16px;
      background: #475569;
      border-radius: 8px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(to right, #3b82f6, #10b981);
      transition: width 0.3s;
    }
    
    .nav { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 8px; 
      margin-bottom: 20px; 
    }
    .nav button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      background: #1e293b;
      color: #94a3b8;
      transition: all 0.2s;
    }
    .nav button.active {
      background: #2563eb;
      color: #fff;
      font-weight: bold;
    }
    .nav button:hover:not(.active) {
      background: #334155;
    }
    
    .main-box {
      background: #1e293b;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #334155;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .stat-card {
      padding: 16px;
      border-radius: 10px;
    }
    .stat-card.blue { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); }
    .stat-card.green { background: linear-gradient(135deg, #065f46 0%, #047857 100%); }
    .stat-card.yellow { background: linear-gradient(135deg, #78350f 0%, #92400e 100%); }
    .stat-card.red { background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%); }
    .stat-label { font-size: 11px; opacity: 0.8; margin-bottom: 6px; text-transform: uppercase; }
    .stat-value { font-size: 28px; font-weight: bold; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th { 
      padding: 12px 8px; 
      text-align: left; 
      color: #cbd5e1; 
      font-size: 13px;
      border-bottom: 2px solid #334155;
    }
    td { 
      padding: 12px 8px; 
      border-bottom: 1px solid #334155;
    }
    tbody tr:hover { background: #334155; }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-success { background: #16a34a; color: #fff; }
    
    .badge {
      display: inline-block;
      background: #2563eb;
      color: #fff;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 12px;
    }
    
    .text-green { color: #4ade80; }
    .text-yellow { color: #fbbf24; }
    .text-red { color: #f87171; }
    .text-blue { color: #60a5fa; }
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .font-bold { font-weight: bold; }
    
    .progress-bar-small {
      width: 100%;
      height: 8px;
      background: #334155;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 4px;
    }
    .progress-fill-small {
      height: 100%;
      transition: width 0.3s;
    }
    .progress-fill-small.high { background: #22c55e; }
    .progress-fill-small.medium { background: #eab308; }
    .progress-fill-small.low { background: #ef4444; }
    
    .info-box {
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid #3b82f6;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }
    
    .warning-box {
      background: rgba(234, 179, 8, 0.1);
      border: 1px solid #ca8a04;
      padding: 24px;
      border-radius: 8px;
      text-align: center;
    }
    
    .teacher-name { font-weight: bold; font-size: 15px; }
    .teacher-location { color: #94a3b8; font-size: 12px; margin-top: 4px; }
    
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-top">
      <div>
        <h1>üí∞ TheGame ‚Äî –£—á—ë—Ç –¥–æ—Ö–æ–¥–æ–≤</h1>
        <div style="font-size: 12px; color: #94a3b8;">–ü—É—Ç—å –∫ 1–ú</div>
      </div>
      <div style="text-align: right;">
        <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px;">–ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —Ü–µ–ª–∏</div>
        <div class="progress-bar-container">
          <div class="progress-bar">
            <div class="progress-fill" id="goalProgress" style="width: 38.5%"></div>
          </div>
          <div style="font-size: 14px; font-weight: bold;" id="goalPercent">39%</div>
        </div>
        <div style="font-size: 11px; color: #64748b;" id="goalText">385,000‚ÇΩ ‚Üí 1,000,000‚ÇΩ</div>
      </div>
    </div>

    <nav class="nav">
      <button class="active" onclick="showTab('monthlyReport')">–ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç</button>
      <button onclick="showTab('dolgo')">–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ</button>
      <button onclick="showTab('salaries')">–ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤</button>
      <button onclick="showTab('individuals')">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ</button>
      <button onclick="showTab('rentals')">–ê—Ä–µ–Ω–¥–∞</button>
      <button onclick="showTab('expenses')">–†–∞—Å—Ö–æ–¥—ã</button>
      <button onclick="showTab('passive')">–ü–∞—Å—Å–∏–≤–Ω—ã–π</button>
      <button onclick="showTab('students')">–£—á–µ–Ω–∏–∫–∏</button>
      <button onclick="showTab('analytics')">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    </nav>

    <div class="main-box">
      <!-- –ó–ê–†–ü–õ–ê–¢–´ –ü–ï–î–ê–ì–û–ì–û–í -->
      <div id="tab-salaries" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2>üíº –ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤</h2>
          <button class="btn btn-success" onclick="exportSalaries()">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
        </div>

        <div id="salaries-empty" class="warning-box">
          <div style="font-size: 48px; margin-bottom: 12px;">‚ö†Ô∏è</div>
          <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á—ë—Ç–∞</div>
          <div style="color: #e2e8f0; margin-bottom: 16px;">–î–æ–±–∞–≤—å—Ç–µ –∑–∞–Ω—è—Ç–∏—è –≤ —Ä–∞–∑–¥–µ–ª "–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ"</div>
          <button class="btn btn-primary" onclick="showTab('dolgo')">–ü–µ—Ä–µ–π—Ç–∏ –∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é</button>
        </div>

        <div id="salaries-content" class="hidden">
          <div class="stats-grid">
            <div class="stat-card blue">
              <div class="stat-label">–ü–µ–¥–∞–≥–æ–≥–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç</div>
              <div class="stat-value" id="salaries-teachers-count">0</div>
            </div>
            <div class="stat-card green">
              <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–Ω—è—Ç–∏–π</div>
              <div class="stat-value" id="salaries-sessions-count">0</div>
            </div>
            <div class="stat-card yellow">
              <div class="stat-label">–í—ã–ø–ª–∞—á–µ–Ω–æ –∑–∞—Ä–ø–ª–∞—Ç</div>
              <div class="stat-value" id="salaries-total-paid">0‚ÇΩ</div>
            </div>
            <div class="stat-card red">
              <div class="stat-label">–†–∞—Å—Ö–æ–¥—ã –Ω–∞ –∑–∞–ª—ã</div>
              <div class="stat-value" id="salaries-hall-expenses">0‚ÇΩ</div>
            </div>
          </div>

          <div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th>–ü–µ–¥–∞–≥–æ–≥</th>
                  <th class="text-center">–î–Ω–µ–π</th>
                  <th class="text-center">–ó–∞–Ω—è—Ç–∏–π</th>
                  <th class="text-right">–î–æ—Ö–æ–¥</th>
                  <th class="text-right">–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
                  <th class="text-right">–ó–∞–ª</th>
                  <th class="text-right">–ü—Ä–∏–±—ã–ª—å</th>
                  <th class="text-center">%</th>
                </tr>
              </thead>
              <tbody id="salaries-table-body">
              </tbody>
              <tfoot style="background: #0f172a; font-weight: bold;">
                <tr id="salaries-total-row">
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="info-box">
            <h3 style="font-weight: bold; color: #93c5fd; margin-bottom: 12px;">üí° –ö–∞–∫ —á–∏—Ç–∞—Ç—å –æ—Ç—á—ë—Ç:</h3>
            <ul style="list-style: none; font-size: 14px; color: #e2e8f0;">
              <li style="margin-bottom: 8px;">‚Ä¢ <b>–î–Ω–µ–π</b> ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–∞—Ç –∑–∞–Ω—è—Ç–∏–π</li>
              <li style="margin-bottom: 8px;">‚Ä¢ <b>–ó–∞–Ω—è—Ç–∏–π</b> ‚Äî –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≤–µ–¥—ë–Ω–Ω—ã—Ö –∑–∞–Ω—è—Ç–∏–π</li>
              <li style="margin-bottom: 8px;">‚Ä¢ <b>–î–æ—Ö–æ–¥</b> ‚Äî —Å—É–º–º–∞ —Å–æ –≤—Å–µ—Ö –∑–∞–Ω—è—Ç–∏–π (–ª—é–¥–µ–π √ó 280‚ÇΩ)</li>
              <li style="margin-bottom: 8px;">‚Ä¢ <b>–ó–∞—Ä–ø–ª–∞—Ç–∞</b> ‚Äî –Ω–∞—á–∏—Å–ª–µ–Ω–æ –ø–µ–¥–∞–≥–æ–≥—É –ø–æ —Å—Ç–∞–≤–∫–µ</li>
              <li style="margin-bottom: 8px;">‚Ä¢ <b>–ó–∞–ª</b> ‚Äî –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –∞—Ä–µ–Ω–¥—É –∑–∞–ª–æ–≤</li>
              <li style="margin-bottom: 8px;">‚Ä¢ <b>–ü—Ä–∏–±—ã–ª—å</b> ‚Äî –¥–æ—Ö–æ–¥ –º–∏–Ω—É—Å –∑–∞—Ä–ø–ª–∞—Ç–∞ –º–∏–Ω—É—Å –∑–∞–ª</li>
              <li>‚Ä¢ <b>%</b> ‚Äî —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å (üü¢>50% üü°>30% üî¥<30%)</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- –ú–ï–°–Ø–ß–ù–´–ô –û–¢–ß–Å–¢ -->
      <div id="tab-monthlyReport">
        <h2>üìÖ –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç</h2>
        <p style="color: #94a3b8;">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤–∞—à –º–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</p>
      </div>

      <!-- –î–û–õ–ì–û–õ–ï–¢–ò–ï -->
      <div id="tab-dolgo" class="hidden">
        <h2>üèÉ –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ</h2>
        <p style="color: #94a3b8;">–î–æ–±–∞–≤–ª—è–π—Ç–µ –∑–∞–Ω—è—Ç–∏—è –∑–¥–µ—Å—å, –æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥—É—Ç –≤ "–ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤"</p>
      </div>

      <!-- –û–°–¢–ê–õ–¨–ù–´–ï –í–ö–õ–ê–î–ö–ò -->
      <div id="tab-individuals" class="hidden">
        <h2>üë§ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —É—Ä–æ–∫–∏</h2>
      </div>
      <div id="tab-rentals" class="hidden">
        <h2>üè† –ê—Ä–µ–Ω–¥–∞ –∑–∞–ª–∞</h2>
      </div>
      <div id="tab-expenses" class="hidden">
        <h2>üí∏ –†–∞—Å—Ö–æ–¥—ã</h2>
      </div>
      <div id="tab-passive" class="hidden">
        <h2>üí∞ –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥</h2>
      </div>
      <div id="tab-students" class="hidden">
        <h2>üë• –ë–∞–∑–∞ —É—á–µ–Ω–∏–∫–æ–≤</h2>
      </div>
      <div id="tab-analytics" class="hidden">
        <h2>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
      </div>
    </div>
  </div>

  <script>
    // –î–∞–Ω–Ω—ã–µ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∏–∑ localStorage/CloudStorage)
    let dolgoData = [
      {date: '01.12', location: '–ë—É–¥–µ–Ω–Ω–æ–≥–æ', teacher: '–ò–≤–∞–Ω–æ–≤–∞ –ú–∞—Ä–∏—è', rate: '50%', people: 15, income: 4200, hallExpense: 0},
      {date: '01.12', location: '–ü–∞—Ä–∫', teacher: '–ü–µ—Ç—Ä–æ–≤ –°–µ—Ä–≥–µ–π', rate: '700', people: 12, income: 3360, hallExpense: 0},
      {date: '03.12', location: '–ë—É–¥–µ–Ω–Ω–æ–≥–æ', teacher: '–ò–≤–∞–Ω–æ–≤–∞ –ú–∞—Ä–∏—è', rate: '50%', people: 18, income: 5040, hallExpense: 0},
      {date: '05.12', location: '–ß–µ—Ä–∫–∏–∑–æ–≤—Å–∫–∞—è', teacher: '–°–∏–¥–æ—Ä–æ–≤–∞ –ê–Ω–Ω–∞', rate: '1000', people: 20, income: 5600, hallExpense: 0},
      {date: '06.12', location: '–ü–∞—Ä–∫', teacher: '–ü–µ—Ç—Ä–æ–≤ –°–µ—Ä–≥–µ–π', rate: '700', people: 14, income: 3920, hallExpense: 0},
    ];

    function fmt(n) {
      return new Intl.NumberFormat('ru-RU').format(Number(n || 0));
    }

    function calcTeacherExpense(income, rate) {
      if (!rate) return 0;
      if (rate === '50%') return Math.round(income * 0.5);
      if (rate === '700') return 700;
      if (rate === '1000') return 1000;
      if (rate === '100%') return Math.round(income * 1.0);
      const parsed = parseFloat(rate);
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
      // Show selected tab
      document.getElementById('tab-' + tabName).classList.remove('hidden');
      
      // Update nav buttons
      document.querySelectorAll('.nav button').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      // If showing salaries, render data
      if (tabName === 'salaries') {
        renderSalaries();
      }
    }

    function renderSalaries() {
      if (dolgoData.length === 0) {
        document.getElementById('salaries-empty').classList.remove('hidden');
        document.getElementById('salaries-content').classList.add('hidden');
        return;
      }

      document.getElementById('salaries-empty').classList.add('hidden');
      document.getElementById('salaries-content').classList.remove('hidden');

      // Calculate teacher stats
      const teacherStats = {};
      dolgoData.forEach(r => {
        const name = r.teacher || '–ë–µ–∑ –∏–º–µ–Ω–∏';
        if (!teacherStats[name]) {
          teacherStats[name] = {
            days: new Set(),
            sessions: 0,
            income: 0,
            salary: 0,
            hallExpense: 0,
            locations: new Set()
          };
        }
        teacherStats[name].days.add(r.date);
        teacherStats[name].sessions += 1;
        teacherStats[name].income += Number(r.income || 0);
        teacherStats[name].salary += calcTeacherExpense(Number(r.income || 0), r.rate);
        teacherStats[name].hallExpense += Number(r.hallExpense || 0);
        teacherStats[name].locations.add(r.location);
      });

      // Update summary cards
      const totalTeachers = Object.keys(teacherStats).length;
      const totalSessions = dolgoData.length;
      const totalSalary = Object.values(teacherStats).reduce((s, t) => s + t.salary, 0);
      const totalHall = Object.values(teacherStats).reduce((s, t) => s + t.hallExpense, 0);
      
      document.getElementById('salaries-teachers-count').textContent = totalTeachers;
      document.getElementById('salaries-sessions-count').textContent = totalSessions;
      document.getElementById('salaries-total-paid').textContent = fmt(totalSalary) + '‚ÇΩ';
      document.getElementById('salaries-hall-expenses').textContent = fmt(totalHall) + '‚ÇΩ';

      // Render table
      const tbody = document.getElementById('salaries-table-body');
      tbody.innerHTML = '';
      
      const sorted = Object.entries(teacherStats).sort((a, b) => b[1].income - a[1].income);
      
      let totalIncome = 0, totalSalarySum = 0, totalHallSum = 0, totalProfitSum = 0;
      
      sorted.forEach(([name, data]) => {
        const profit = data.income - data.salary - data.hallExpense;
        const profitPercent = data.income ? Math.round((profit / data.income) * 100) : 0;
        const progressClass = profitPercent > 50 ? 'high' : profitPercent > 30 ? 'medium' : 'low';
        
        totalIncome += data.income;
        totalSalarySum += data.salary;
        totalHallSum += data.hallExpense;
        totalProfitSum += profit;
        
        const row = `
          <tr>
            <td>
              <div class="teacher-name">${name}</div>
              <div class="teacher-location">üìç ${Array.from(data.locations).join(', ')}</div>
            </td>
            <td class="text-center">
              <span class="badge">${data.days.size}</span>
            </td>
            <td class="text-center font-bold">${data.sessions}</td>
            <td class="text-right text-green font-bold">${fmt(data.income)}‚ÇΩ</td>
            <td class="text-right text-yellow font-bold">${fmt(data.salary)}‚ÇΩ</td>
            <td class="text-right text-red">${fmt(data.hallExpense)}‚ÇΩ</td>
            <td class="text-right ${profit > 0 ? 'text-blue' : 'text-red'} font-bold">${fmt(profit)}‚ÇΩ</td>
            <td>
              <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                <div class="progress-bar-small">
                  <div class="progress-fill-small ${progressClass}" style="width: ${Math.min(profitPercent, 100)}%"></div>
                </div>
                <span style="font-size: 12px; font-weight: bold;">${profitPercent}%</span>
              </div>
            </td>
          </tr>
        `;
        tbody.innerHTML += row;
      });

      // Total row
      const uniqueDays = new Set(dolgoData.map(r => r.date)).size;
      const totalPercent = totalIncome ? Math.round((totalProfitSum / totalIncome) * 100) : 0;
      
      document.getElementById('salaries-total-row').innerHTML = `
        <td>–ò–¢–û–ì–û:</td>
        <td class="text-center text-blue">${uniqueDays}</td>
        <td class="text-center">${totalSessions}</td>
        <td class="text-right text-green">${fmt(totalIncome)}‚ÇΩ</td>
        <td class="text-right text-yellow">${fmt(totalSalarySum)}‚ÇΩ</td>
        <td class="text-right text-red">${fmt(totalHallSum)}‚ÇΩ</td>
        <td class="text-right text-blue">${fmt(totalProfitSum)}‚ÇΩ</td>
        <td class="text-center">${totalPercent}%</td>
      `;
    }

    function exportSalaries() {
      alert('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      try {
        window.Telegram?.WebApp?.expand();
      } catch(e) {}
    });
  </script>
</body>
</html>
