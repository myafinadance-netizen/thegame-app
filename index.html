// bot.js
// Telegram bot for "–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ" (–ê–ù–û ¬´–ê–§–ò–ù–ê¬ª)

const TelegramBot = require('node-telegram-bot-api');
const fs = require('fs-extra');
const path = require('path');
const mammoth = require('mammoth');

// ================= CONFIG =================
const TOKEN = process.env.BOT_TOKEN || 'PUT_YOUR_TELEGRAM_BOT_TOKEN_HERE';
const DATA_DIR = path.join(__dirname, 'data');

const FILES = {
  records: path.join(DATA_DIR, 'records.json'),
  teachers: path.join(DATA_DIR, 'teachers.json'),
  groups: path.join(DATA_DIR, 'groups.json'),
  expenses: path.join(DATA_DIR, 'expenses.json'),
};

// ================= INIT =================
const bot = new TelegramBot(TOKEN, { polling: true });

fs.ensureDirSync(DATA_DIR);

// init files with defaults
if (!fs.existsSync(FILES.records)) fs.writeJsonSync(FILES.records, []);
if (!fs.existsSync(FILES.teachers)) fs.writeJsonSync(FILES.teachers, []);
if (!fs.existsSync(FILES.groups)) fs.writeJsonSync(FILES.groups, []);
if (!fs.existsSync(FILES.expenses))
  fs.writeJsonSync(FILES.expenses, {
    rent: 0,
    utilities: 0,
    water: 0,
    admin: 0,
    paymentRate: 280,
  });

// ================= HELPERS =================
const readJSON = (file) => fs.readJsonSync(file);
const writeJSON = (file, data) => fs.writeJsonSync(file, data, { spaces: 2 });

const uid = () => Date.now() + Math.random().toString(36).slice(2, 8);

const isValidDate = (s) => /^\d{4}-\d{2}-\d{2}$/.test(s);
const isValidMonth = (s) => /^\d{4}-\d{2}$/.test(s);

const csvWithBOM = (content) => '\uFEFF' + content;

const monthOf = (date) => date.slice(0, 7);

// ================= COMMANDS =================
bot.onText(/\/start/, (msg) => {
  bot.sendMessage(
    msg.chat.id,
    `üëã –ë–æ—Ç —É—á–µ—Ç–∞ –∑–∞–Ω—è—Ç–∏–π ¬´–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ¬ª

–ö–æ–º–∞–Ω–¥—ã:
/add –ì—Ä—É–ø–ø–∞;YYYY-MM-DD;–ü–µ–¥–∞–≥–æ–≥;–ö–æ–ª-–≤–æ
/bulk (–∑–∞–≥—Ä—É–∑–∫–∞ .docx)
/report YYYY-MM
/export YYYY-MM
/teachers
/groups
/expenses`
  );
});

// ================= ADD SINGLE RECORD =================
bot.onText(/\/add (.+)/, (msg, match) => {
  try {
    const [group, date, teacherName, countStr] = match[1].split(';').map((s) => s.trim());
    const count = Number(countStr);

    if (!group || !date || !teacherName || !Number.isFinite(count))
      return bot.sendMessage(msg.chat.id, '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');

    if (!isValidDate(date))
      return bot.sendMessage(msg.chat.id, '‚ùå –î–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å YYYY-MM-DD');

    const groups = readJSON(FILES.groups);
    if (!groups.includes(group))
      return bot.sendMessage(msg.chat.id, '‚ùå –ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');

    const teachers = readJSON(FILES.teachers);
    const teacher = teachers.find((t) => t.name === teacherName);
    if (!teacher)
      return bot.sendMessage(msg.chat.id, '‚ùå –ü–µ–¥–∞–≥–æ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω');

    const records = readJSON(FILES.records);
    records.push({
      id: uid(),
      group,
      date,
      teacher: teacher.id,
      count,
    });

    writeJSON(FILES.records, records);
    bot.sendMessage(msg.chat.id, '‚úÖ –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞');
  } catch (e) {
    bot.sendMessage(msg.chat.id, '‚ùå –û—à–∏–±–∫–∞: ' + e.message);
  }
});

// ================= BULK DOCX =================
bot.on('document', async (msg) => {
  if (!msg.caption || !msg.caption.startsWith('/bulk')) return;

  try {
    const file = await bot.downloadFile(msg.document.file_id, DATA_DIR);
    const result = await mammoth.extractRawText({ path: file });
    const text = result.value;

    // –û–∂–∏–¥–∞–µ–º—ã–π –ø—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:
    // –ì—Ä—É–ø–ø–∞: XXX
    // 2025-01-10 - 12
    // 2025-01-12 - 10
    // –ò—Ç–æ–≥–æ: 22

    const lines = text.split('\n').map((l) => l.trim()).filter(Boolean);
    const groupLine = lines.find((l) => l.toLowerCase().startsWith('–≥—Ä—É–ø–ø–∞'));
    if (!groupLine) throw new Error('–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');

    const group = groupLine.split(':')[1].trim();
    const groups = readJSON(FILES.groups);
    if (!groups.includes(group)) throw new Error('–ì—Ä—É–ø–ø–∞ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞');

    const teachers = readJSON(FILES.teachers);
    if (teachers.length !== 1)
      throw new Error('–î–ª—è bulk –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–æ–≤–Ω–æ 1 –ø–µ–¥–∞–≥–æ–≥');

    const teacher = teachers[0];

    const records = readJSON(FILES.records);
    let created = 0;

    for (const l of lines) {
      if (/–∏—Ç–æ–≥–æ/i.test(l)) continue;
      if (/^\d{4}-\d{2}-\d{2}/.test(l)) {
        const [d, c] = l.split('-').map((x) => x.trim());
        const count = Number(c);
        if (!isValidDate(d) || !Number.isFinite(count)) continue;

        records.push({
          id: uid(),
          group,
          date: d,
          teacher: teacher.id,
          count,
        });
        created++;
      }
    }

    writeJSON(FILES.records, records);
    bot.sendMessage(msg.chat.id, `‚úÖ –°–æ–∑–¥–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${created}`);
  } catch (e) {
    bot.sendMessage(msg.chat.id, '‚ùå Bulk –æ—à–∏–±–∫–∞: ' + e.message);
  }
});

// ================= REPORT =================
bot.onText(/\/report (.+)/, (msg, match) => {
  try {
    const ym = match[1].trim();
    if (!isValidMonth(ym))
      return bot.sendMessage(msg.chat.id, '‚ùå –§–æ—Ä–º–∞—Ç YYYY-MM');

    const records = readJSON(FILES.records).filter(
      (r) => monthOf(r.date) === ym
    );
    const teachers = readJSON(FILES.teachers);
    const expenses = readJSON(FILES.expenses);

    let totalIncome = 0;
    let totalSalaries = 0;
    const byTeacher = {};

    for (const r of records) {
      const teacher = teachers.find((t) => t.id === r.teacher);
      if (!teacher) continue;

      const income = r.count * expenses.paymentRate;
      const salary = (income * teacher.rate) / 100;

      totalIncome += income;
      totalSalaries += salary;

      byTeacher[teacher.name] = (byTeacher[teacher.name] || 0) + salary;
    }

    const fixed =
      expenses.rent +
      expenses.utilities +
      expenses.water +
      expenses.admin;

    const netProfit = totalIncome - totalSalaries - fixed;

    let text = `üìä –û—Ç—á–µ—Ç –∑–∞ ${ym}

–î–æ—Ö–æ–¥: ${totalIncome}
–ó–∞—Ä–ø–ª–∞—Ç—ã: ${totalSalaries}
–†–∞—Å—Ö–æ–¥—ã: ${fixed}
–ü—Ä–∏–±—ã–ª—å: ${netProfit}

üë©‚Äçüè´ –ü–æ –ø–µ–¥–∞–≥–æ–≥–∞–º:
`;

    for (const [name, sum] of Object.entries(byTeacher)) {
      text += `${name}: ${sum}\n`;
    }

    bot.sendMessage(msg.chat.id, text);
  } catch (e) {
    bot.sendMessage(msg.chat.id, '‚ùå –û—à–∏–±–∫–∞ –æ—Ç—á–µ—Ç–∞: ' + e.message);
  }
});

// ================= EXPORT CSV =================
bot.onText(/\/export (.+)/, (msg, match) => {
  try {
    const ym = match[1].trim();
    if (!isValidMonth(ym))
      return bot.sendMessage(msg.chat.id, '‚ùå –§–æ—Ä–º–∞—Ç YYYY-MM');

    const records = readJSON(FILES.records).filter(
      (r) => monthOf(r.date) === ym
    );
    const teachers = readJSON(FILES.teachers);
    const expenses = readJSON(FILES.expenses);

    let csv = '–î–∞—Ç–∞;–ì—Ä—É–ø–ø–∞;–ü–µ–¥–∞–≥–æ–≥;–ü–æ—Å–µ—â–µ–Ω–∏—è;–î–æ—Ö–æ–¥\n';

    for (const r of records) {
      const t = teachers.find((x) => x.id === r.teacher);
      const income = r.count * expenses.paymentRate;
      csv += `${r.date};${r.group};${t ? t.name : ''};${r.count};${income}\n`;
    }

    const filePath = path.join(DATA_DIR, `report-${ym}.csv`);
    fs.writeFileSync(filePath, csvWithBOM(csv), 'utf8');

    bot.sendDocument(msg.chat.id, filePath);
  } catch (e) {
    bot.sendMessage(msg.chat.id, '‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + e.message);
  }
});

// ================= TEACHERS CRUD =================
bot.onText(/\/teachers/, (msg) => {
  const teachers = readJSON(FILES.teachers);
  let text = 'üë©‚Äçüè´ –ü–µ–¥–∞–≥–æ–≥–∏:\n';
  teachers.forEach((t) => {
    text += `${t.id} | ${t.name} | ${t.rate}%\n`;
  });
  text += '\n–î–æ–±–∞–≤–∏—Ç—å: /teachers add –ò–º—è;–°—Ç–∞–≤–∫–∞\n–£–¥–∞–ª–∏—Ç—å: /teachers del ID';
  bot.sendMessage(msg.chat.id, text);
});

bot.onText(/\/teachers add (.+)/, (msg, m) => {
  try {
    const [name, rateStr] = m[1].split(';').map((s) => s.trim());
    const rate = Number(rateStr);
    if (!name || !Number.isFinite(rate)) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');

    const teachers = readJSON(FILES.teachers);
    teachers.push({ id: uid(), name, rate });
    writeJSON(FILES.teachers, teachers);
    bot.sendMessage(msg.chat.id, '‚úÖ –ü–µ–¥–∞–≥–æ–≥ –¥–æ–±–∞–≤–ª–µ–Ω');
  } catch (e) {
    bot.sendMessage(msg.chat.id, '‚ùå ' + e.message);
  }
});

bot.onText(/\/teachers del (.+)/, (msg, m) => {
  const id = m[1].trim();
  bot.sendMessage(
    msg.chat.id,
    `‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –ø–µ–¥–∞–≥–æ–≥–∞ ${id}? –ù–∞–ø–∏—à–∏—Ç–µ: YES`
  ).then(() => {
    bot.once('message', (ans) => {
      if (ans.text === 'YES') {
        const teachers = readJSON(FILES.teachers).filter((t) => t.id !== id);
        writeJSON(FILES.teachers, teachers);
        bot.sendMessage(msg.chat.id, 'üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ');
      }
    });
  });
});

// ================= GROUPS CRUD =================
bot.onText(/\/groups/, (msg) => {
  const groups = readJSON(FILES.groups);
  bot.sendMessage(
    msg.chat.id,
    `üë• –ì—Ä—É–ø–ø—ã:\n${groups.join('\n')}\n\n–î–æ–±–∞–≤–∏—Ç—å: /groups add –ù–∞–∑–≤–∞–Ω–∏–µ\n–£–¥–∞–ª–∏—Ç—å: /groups del –ù–∞–∑–≤–∞–Ω–∏–µ`
  );
});

bot.onText(/\/groups add (.+)/, (msg, m) => {
  const name = m[1].trim();
  const groups = readJSON(FILES.groups);
  if (groups.includes(name))
    return bot.sendMessage(msg.chat.id, '‚ùå –£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
  groups.push(name);
  writeJSON(FILES.groups, groups);
  bot.sendMessage(msg.chat.id, '‚úÖ –ì—Ä—É–ø–ø–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
});

bot.onText(/\/groups del (.+)/, (msg, m) => {
  const name = m[1].trim();
  bot.sendMessage(
    msg.chat.id,
    `‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É "${name}"? –ù–∞–ø–∏—à–∏—Ç–µ: YES`
  ).then(() => {
    bot.once('message', (ans) => {
      if (ans.text === 'YES') {
        const groups = readJSON(FILES.groups).filter((g) => g !== name);
        writeJSON(FILES.groups, groups);
        bot.sendMessage(msg.chat.id, 'üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ');
      }
    });
  });
});

// ================= EXPENSES =================
bot.onText(/\/expenses/, (msg) => {
  const e = readJSON(FILES.expenses);
  bot.sendMessage(
    msg.chat.id,
    `üí∏ –†–∞—Å—Ö–æ–¥—ã:
–ê—Ä–µ–Ω–¥–∞: ${e.rent}
–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ: ${e.utilities}
–í–æ–¥–∞: ${e.water}
–ê–¥–º–∏–Ω: ${e.admin}
–°—Ç–∞–≤–∫–∞ –æ–ø–ª–∞—Ç—ã: ${e.paymentRate}

–ò–∑–º–µ–Ω–∏—Ç—å: /expenses set –ø–æ–ª–µ –∑–Ω–∞—á–µ–Ω–∏–µ`
  );
});

bot.onText(/\/expenses set (.+)/, (msg, m) => {
  try {
    const [field, valueStr] = m[1].split(' ').map((s) => s.trim());
    const value = Number(valueStr);
    const e = readJSON(FILES.expenses);
    if (!(field in e) || !Number.isFinite(value))
      throw new Error('–ù–µ–≤–µ—Ä–Ω–æ–µ –ø–æ–ª–µ');
    e[field] = value;
    writeJSON(FILES.expenses, e);
    bot.sendMessage(msg.chat.id, '‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ');
  } catch (e) {
    bot.sendMessage(msg.chat.id, '‚ùå ' + e.message);
  }
});
