<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DOCX –æ—Ç—á—ë—Ç –ú–î</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>

<style>
body {
    margin: 0;
    background: #0b1220;
    color: #fff;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}
.container {
    max-width: 420px;
    margin: auto;
    padding: 16px;
}
h1 { font-size: 20px; margin-bottom: 12px; }

input, button {
    width: 100%;
    padding: 12px;
    border-radius: 12px;
    border: none;
    margin-bottom: 10px;
    font-size: 14px;
}

button {
    background: #2563eb;
    color: #fff;
}
.card {
    background: #111827;
    border-radius: 14px;
    padding: 12px;
    margin-bottom: 10px;
}
.small { font-size: 13px; color: #9aa4b2; }
</style>
</head>

<body>
<div class="container">

<h1>üìÑ DOCX-–æ—Ç—á—ë—Ç (–ú–î)</h1>

<input type="month" id="monthPicker">
<button onclick="buildReport()">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
<button onclick="exportDocx()">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å DOCX</button>

<div id="report"></div>

</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

let schedule = JSON.parse(localStorage.getItem("schedule")) || {};
let reportData = [];

document.getElementById("monthPicker").value =
    new Date().toISOString().slice(0,7);

function calculate(lesson) {
    const grantPerPerson = 280;
    const income = lesson.people * grantPerPerson;

    let salary = 0;
    if (lesson.salaryType === "fixed") salary = lesson.salaryValue;
    if (lesson.salaryType === "perPerson") salary = lesson.people * lesson.salaryValue;
    if (lesson.salaryType === "percent") salary = income * lesson.salaryValue / 100;

    return { income, salary };
}

function buildReport() {
    const month = document.getElementById("monthPicker").value;
    const reportDiv = document.getElementById("report");
    reportDiv.innerHTML = "";
    reportData = [];

    const teachers = {};

    Object.keys(schedule).forEach(date => {
        if (!date.startsWith(month)) return;

        schedule[date].forEach(l => {
            const c = calculate(l);
            if (!teachers[l.teacher]) {
                teachers[l.teacher] = {
                    lessons: 0,
                    people: 0,
                    income: 0,
                    salary: 0
                };
            }
            teachers[l.teacher].lessons++;
            teachers[l.teacher].people += l.people;
            teachers[l.teacher].income += c.income;
            teachers[l.teacher].salary += c.salary;
        });
    });

    Object.entries(teachers).forEach(([teacher, d]) => {
        reportData.push([teacher, d.lessons, d.people, d.income, d.salary]);

        reportDiv.innerHTML += `
        <div class="card">
            <b>${teacher}</b><br>
            <span class="small">
            –ó–∞–Ω—è—Ç–∏–π: ${d.lessons}<br>
            –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${d.people}<br>
            –î–æ—Ö–æ–¥: ${d.income} ‚ÇΩ<br>
            –ó–∞—Ä–ø–ª–∞—Ç–∞: ${d.salary} ‚ÇΩ
            </span>
        </div>`;
    });
}

async function exportDocx() {
    if (reportData.length === 0) {
        tg.showAlert("–°–Ω–∞—á–∞–ª–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç");
        return;
    }

    const { Document, Packer, Paragraph, Table, TableRow, TableCell, TextRun } = docx;

    const rows = [
        new TableRow({
            children: ["–ü–µ–¥–∞–≥–æ–≥","–ó–∞–Ω—è—Ç–∏–π","–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤","–î–æ—Ö–æ–¥","–ó–∞—Ä–ø–ª–∞—Ç–∞"]
            .map(t => new TableCell({ children: [new Paragraph({ text: t, bold: true })] }))
        })
    ];

    reportData.forEach(r => {
        rows.push(new TableRow({
            children: r.map(v =>
                new TableCell({ children: [new Paragraph(String(v))] })
            )
        }));
    });

    const doc = new Document({
        sections: [{
            children: [
                new Paragraph({
                    children: [new TextRun({
                        text: "–û—Ç—á—ë—Ç –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ ¬´–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ¬ª",
                        bold: true,
                        size: 28
                    })]
                }),
                new Paragraph(`–ü–µ—Ä–∏–æ–¥: ${monthPicker.value}`),
                new Paragraph(" "),
                new Table({ rows })
            ]
        }]
    });

    const blob = await Packer.toBlob(doc);
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `–û—Ç—á–µ—Ç_–ú–î_${monthPicker.value}.docx`;
    link.click();
}
</script>

</body>
</html>
