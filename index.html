<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TheGame ‚Äî –£—á—ë—Ç –¥–æ—Ö–æ–¥–æ–≤</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;
const tg = window.Telegram?.WebApp;

function App() {
  const [activeTab, setActiveTab] = useState('monthlyReport');
  const [dolgo, setDolgo] = useState([]);
  const [loading, setLoading] = useState(true);

  const loadKey = async (key, fallback) => {
    try {
      if (tg?.CloudStorage) {
        return await new Promise(resolve => {
          tg.CloudStorage.getItem(key, (e, v) => {
            resolve(v ? JSON.parse(v) : fallback);
          });
        });
      }
      const v = localStorage.getItem(key);
      return v ? JSON.parse(v) : fallback;
    } catch {
      return fallback;
    }
  };

  const saveKey = (key, data) => {
    const v = JSON.stringify(data);
    tg?.CloudStorage?.setItem(key, v);
    localStorage.setItem(key, v);
  };

  useEffect(() => {
    loadKey('dolgo', []).then(d => {
      setDolgo(d);
      setLoading(false);
      tg?.expand();
    });
  }, []);

  useEffect(() => {
    if (!loading) saveKey('dolgo', dolgo);
  }, [dolgo]);

  const fmt = n => new Intl.NumberFormat('ru-RU').format(n || 0);

  const calcTeacherExpense = (income, rate) => {
    if (rate === '50%') return income * 0.5;
    if (rate === '700') return 700;
    if (rate === '1000') return 1000;
    if (rate === '100%') return income;
    const p = parseFloat(rate);
    return isNaN(p) ? 0 : p;
  };

  /* ===============================
     –ó–ê–†–ü–õ–ê–¢–´ –ü–ï–î–ê–ì–û–ì–û–í (–õ–û–ì–ò–ö–ê)
     =============================== */
  const map = {};
  dolgo.forEach(r => {
    const t = r.teacher || '–ë–µ–∑ –∏–º–µ–Ω–∏';
    const income = r.income || 0;
    const salary = calcTeacherExpense(income, r.rate);
    const hall = r.hallExpense || 0;
    const profit = income - salary - hall;

    if (!map[t]) {
      map[t] = {
        teacher: t,
        location: r.location,
        days: new Set(),
        lessons: 0,
        income: 0,
        salary: 0,
        hall: 0,
        profit: 0
      };
    }

    map[t].days.add(r.date);
    map[t].lessons++;
    map[t].income += income;
    map[t].salary += salary;
    map[t].hall += hall;
    map[t].profit += profit;
  });

  const teachers = Object.values(map).map(t => ({
    ...t,
    days: t.days.size,
    profitability: t.income ? Math.round((t.profit / t.income) * 100) : 0
  }));

  const stats = {
    teachers: teachers.length,
    lessons: teachers.reduce((s,t)=>s+t.lessons,0),
    salary: teachers.reduce((s,t)=>s+t.salary,0),
    hall: teachers.reduce((s,t)=>s+t.hall,0),
  };

  if (loading) return <div className="p-6">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;

  return (
  <div className="p-4 max-w-6xl mx-auto">
    <h1 className="text-2xl font-bold mb-4">üí∞ TheGame ‚Äî –£—á—ë—Ç –¥–æ—Ö–æ–¥–æ–≤</h1>

    {/* –ù–ê–í–ò–ì–ê–¶–ò–Ø */}
    <div className="flex gap-2 mb-6 flex-wrap">
      {[
        ['monthlyReport','–ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç'],
        ['dolgo','–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ'],
        ['salary','–ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤'],
      ].map(([id,title])=>(
        <button
          key={id}
          onClick={()=>setActiveTab(id)}
          className={`px-3 py-1 rounded ${
            activeTab===id ? 'bg-blue-600' : 'bg-slate-700'
          }`}
        >{title}</button>
      ))}
    </div>

    {/* ===== –ó–ê–†–ü–õ–ê–¢–´ –ü–ï–î–ê–ì–û–ì–û–í ===== */}
    {activeTab === 'salary' && (
      <section>
        <h2 className="text-lg font-bold mb-4">üíº –ó–∞—Ä–ø–ª–∞—Ç—ã –ø–µ–¥–∞–≥–æ–≥–æ–≤</h2>

        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div className="bg-slate-800 p-3 rounded">
            <div className="text-sm text-slate-400">–ü–µ–¥–∞–≥–æ–≥–æ–≤</div>
            <div className="text-2xl font-bold">{stats.teachers}</div>
          </div>
          <div className="bg-slate-800 p-3 rounded">
            <div className="text-sm text-slate-400">–ó–∞–Ω—è—Ç–∏–π</div>
            <div className="text-2xl font-bold text-green-400">{stats.lessons}</div>
          </div>
          <div className="bg-slate-800 p-3 rounded">
            <div className="text-sm text-slate-400">–ó–∞—Ä–ø–ª–∞—Ç—ã</div>
            <div className="text-2xl font-bold text-yellow-400">{fmt(stats.salary)}‚ÇΩ</div>
          </div>
          <div className="bg-slate-800 p-3 rounded">
            <div className="text-sm text-slate-400">–ó–∞–ª—ã</div>
            <div className="text-2xl font-bold text-red-400">{fmt(stats.hall)}‚ÇΩ</div>
          </div>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="border-b border-slate-700 text-slate-300">
              <tr>
                <th>–ü–µ–¥–∞–≥–æ–≥</th>
                <th className="text-center">–î–Ω–µ–π</th>
                <th className="text-center">–ó–∞–Ω—è—Ç–∏–π</th>
                <th className="text-right">–î–æ—Ö–æ–¥</th>
                <th className="text-right">–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
                <th className="text-right">–ó–∞–ª</th>
                <th className="text-right">–ü—Ä–∏–±—ã–ª—å</th>
                <th className="text-center">%</th>
              </tr>
            </thead>
            <tbody>
              {teachers.map((t,i)=>(
                <tr key={i} className="border-b border-slate-700/40">
                  <td>
                    <div className="font-bold">{t.teacher}</div>
                    <div className="text-xs text-slate-400">üìç {t.location}</div>
                  </td>
                  <td className="text-center">{t.days}</td>
                  <td className="text-center">{t.lessons}</td>
                  <td className="text-right text-green-400">{fmt(t.income)}‚ÇΩ</td>
                  <td className="text-right text-yellow-400">{fmt(t.salary)}‚ÇΩ</td>
                  <td className="text-right text-red-400">{fmt(t.hall)}‚ÇΩ</td>
                  <td className="text-right text-blue-400 font-bold">{fmt(t.profit)}‚ÇΩ</td>
                  <td className="text-center font-bold">{t.profitability}%</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </section>
    )}

    {activeTab !== 'salary' && (
      <div className="text-slate-400">
        –û—Å—Ç–∞–ª—å–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
      </div>
    )}
  </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
