<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TheGame ‚Äî —É—á—ë—Ç –¥–æ—Ö–æ–¥–æ–≤</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
    body {
        background: #0d0d0d;
        color: white;
        font-family: system-ui, sans-serif;
    }
    .tab-active {
        background: #1f1f1f;
        color: #fff !important;
        font-weight: 600;
    }
    thead {
        position: sticky;
        top: 48px;
        background: #1a1a1a;
        z-index: 10;
    }
    tfoot {
        position: sticky;
        bottom: 0;
        background: #111;
    }
    .floating-add {
        position: fixed;
        right: 20px;
        bottom: 20px;
        background: #10b981;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        font-size: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 999;
        box-shadow: 0 0 12px rgba(0,255,170,0.4);
    }
    .profit-green { color: #22c55e; }
    .profit-red { color: #ef4444; }
</style>
</head>

<body class="pb-20">

<!-- ========================= HEADER ========================= -->
<header class="fixed top-0 left-0 right-0 z-50 bg-black border-b border-gray-800">
    <div class="p-4 flex flex-col">
        <h1 class="text-xl font-bold">üí∞ TheGame ‚Äî –ø—É—Ç—å –∫ 1–ú</h1>
        <div class="w-full bg-gray-700 h-3 rounded mt-2">
            <div id="goalProgress" class="h-3 bg-green-500 rounded" style="width:0%"></div>
        </div>
        <div class="text-sm mt-1" id="goalText">0‚ÇΩ ‚Üí 1,000,000‚ÇΩ</div>
    </div>

    <!-- ========================= TABS ========================= -->
    <nav id="tabs" class="flex overflow-x-auto border-t border-gray-800">
        <button class="px-4 py-2" data-tab="monthly">üìÖ –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç</button>
        <button class="px-4 py-2" data-tab="dolgo">üèÉ –î–æ–ª–≥–æ–ª–µ—Ç–∏–µ</button>
        <button class="px-4 py-2" data-tab="indi">üë§ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª–∫–∏</button>
        <button class="px-4 py-2" data-tab="arenda">üè† –ê—Ä–µ–Ω–¥–∞</button>
        <button class="px-4 py-2" data-tab="exp">üí∏ –†–∞—Å—Ö–æ–¥—ã</button>
        <button class="px-4 py-2" data-tab="passive">üí∞ –ü–∞—Å—Å–∏–≤</button>
        <button class="px-4 py-2" data-tab="students">üë• –£—á–µ–Ω–∏–∫–∏</button>
        <button class="px-4 py-2" data-tab="analytics">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
        <button class="px-4 py-2" data-tab="months">üìÜ –ü–æ –º–µ—Å—è—Ü–∞–º</button>
        <button class="px-4 py-2" data-tab="summary">üìà –°–≤–æ–¥–∫–∞</button>
    </nav>
</header>

<div class="mt-[120px]"></div>

<!-- ============================================================
================== –í–°–ï –í–ö–õ–ê–î–ö–ò ================================
=============================================================== -->

<!-- =============== 1. –ú–ï–°–Ø–ß–ù–´–ô –û–¢–ß–Å–¢ ================= -->
<section id="monthly" class="p-4 hidden">
    <h2 class="text-xl mb-4 font-bold">üìÖ –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç</h2>
    <table class="w-full text-sm">
        <thead>
            <tr class="text-left text-gray-300">
                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–î–æ—Ö–æ–¥</th><th>–†–∞—Å—Ö–æ–¥</th><th>–ü—Ä–∏–±—ã–ª—å</th>
            </tr>
        </thead>
        <tbody id="monthlyTable"></tbody>
        <tfoot>
            <tr class="font-bold bg-black text-white">
                <td>–ò–¢–û–ì–û</td>
                <td id="mTotalIncome">0</td>
                <td id="mTotalExpense">0</td>
                <td id="mTotalProfit">0</td>
            </tr>
        </tfoot>
    </table>
</section>

<!-- =============== 2. –î–û–õ–ì–û–õ–ï–¢–ò–ï ================= -->
<section id="dolgo" class="p-4 hidden">
    <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold mb-4">üèÉ –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ</h2>
        <input id="searchDolgo" placeholder="–ü–æ–∏—Å–∫..." class="px-3 py-1 bg-gray-800 rounded">
    </div>

    <table class="w-full text-sm">
        <thead>
            <tr class="text-left text-gray-300">
                <th>–î–∞—Ç–∞</th><th>–õ–æ–∫–∞—Ü–∏—è</th><th>–ü–µ–¥–∞–≥–æ–≥</th><th>–°—Ç–∞–≤–∫–∞</th><th>–õ—é–¥–µ–π</th>
                <th>–î–æ—Ö–æ–¥</th><th>–†–∞—Å—Ö–æ–¥ –ø–µ–¥.</th><th>–ó–∞–ª</th><th>–ü—Ä–∏–±—ã–ª—å</th><th></th>
            </tr>
        </thead>
        <tbody id="dolgoTable"></tbody>
        <tfoot>
            <tr class="bg-black font-bold">
                <td colspan="5">–ò–¢–û–ì–û:</td>
                <td id="dolgoIncome"></td>
                <td id="dolgoTeacher"></td>
                <td id="dolgoHall"></td>
                <td id="dolgoProfit"></td>
                <td></td>
            </tr>
        </tfoot>
    </table>
</section>

<!-- =============== 3. –ò–ù–î–ò ================= -->
<section id="indi" class="p-4 hidden">
    <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold mb-4">üë§ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ</h2>
        <input id="searchIndi" placeholder="–ü–æ–∏—Å–∫..." class="px-3 py-1 bg-gray-800 rounded">
    </div>
    <table class="w-full text-sm">
        <thead>
            <tr class="text-left text-gray-300">
                <th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–°—É–º–º–∞</th><th></th>
            </tr>
        </thead>
        <tbody id="indiTable"></tbody>
        <tfoot>
            <tr class="bg-black font-bold">
                <td colspan="3">–ò–¢–û–ì–û:</td>
                <td id="indiTotal"></td>
                <td></td>
            </tr>
        </tfoot>
    </table>
</section>

<!-- =============== 4. –ê–†–ï–ù–î–ê ================= -->
<section id="arenda" class="p-4 hidden">
    <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold mb-4">üè† –ê—Ä–µ–Ω–¥–∞</h2>
        <input id="searchArenda" placeholder="–ü–æ–∏—Å–∫..." class="px-3 py-1 bg-gray-800 rounded">
    </div>

    <table class="w-full text-sm">
        <thead>
            <tr class="text-left text-gray-300">
                <th>–î–∞—Ç–∞</th><th>–ò–º—è</th><th>–°—É–º–º–∞</th><th></th>
            </tr>
        </thead>
        <tbody id="arendaTable"></tbody>
        <tfoot>
            <tr class="bg-black font-bold">
                <td colspan="2">–ò–¢–û–ì–û:</td>
                <td id="arendaTotal"></td>
                <td></td>
            </tr>
        </tfoot>
    </table>
</section>

<!-- =============== 5. –†–ê–°–•–û–î–´ ================= -->
<section id="exp" class="p-4 hidden">
    <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold mb-4">üí∏ –†–∞—Å—Ö–æ–¥—ã</h2>
        <input id="searchExp" placeholder="–ü–æ–∏—Å–∫..." class="px-3 py-1 bg-gray-800 rounded">
    </div>

    <table class="w-full text-sm">
        <thead>
            <tr class="text-left text-gray-300">
                <th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–ß—Ç–æ</th><th>–°—É–º–º–∞</th><th></th>
            </tr>
        </thead>
        <tbody id="expTable"></tbody>
        <tfoot>
            <tr class="bg-black font-bold">
                <td colspan="3">–ò–¢–û–ì–û:</td>
                <td id="expTotal"></td>
                <td></td>
            </tr>
        </tfoot>
    </table>
</section>

<!-- =============== 6. –ü–ê–°–°–ò–í ================= -->
<section id="passive" class="p-4 hidden">
    <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold mb-4">üí∞ –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥</h2>
        <input id="searchPassive" placeholder="–ü–æ–∏—Å–∫..." class="px-3 py-1 bg-gray-800 rounded">
    </div>

    <table class="w-full text-sm">
        <thead>
            <tr class="text-left text-gray-300">
                <th>–î–∞—Ç–∞</th><th>–ò—Å—Ç–æ—á–Ω–∏–∫</th><th>–°—É–º–º–∞</th><th></th>
            </tr>
        </thead>
        <tbody id="passiveTable"></tbody>
        <tfoot>
            <tr class="bg-black font-bold">
                <td colspan="2">–ò–¢–û–ì–û:</td>
                <td id="passiveTotal"></td>
                <td></td>
            </tr>
        </tfoot>
    </table>
</section>

<!-- =============== 7. –£–ß–ï–ù–ò–ö–ò ================= -->
<section id="students" class="p-4 hidden">
    <h2 class="text-xl font-bold mb-4">üë• –ë–∞–∑–∞ —É—á–µ–Ω–∏–∫–æ–≤</h2>

    <div class="text-sm mb-2">
        –í—Å–µ–≥–æ: <span id="stAll">0</span> ‚Ä¢  
        –ê–∫—Ç–∏–≤–Ω—ã—Ö: <span id="stActive">0</span> ‚Ä¢  
        –°—Ä–µ–¥–Ω–∏–π –¥–æ—Ö–æ–¥: <span id="stAvg">0</span>
    </div>

    <table class="w-full text-sm">
        <thead>
            <tr class="text-left text-gray-300">
                <th>–ò–º—è</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ì—Ä—É–ø–ø–∞</th><th>–ê–±–æ–Ω–µ–º–µ–Ω—Ç</th><th>–î–æ</th><th>–°—Ç–∞—Ç—É—Å</th><th></th>
            </tr>
        </thead>
        <tbody id="studentsTable"></tbody>
    </table>
</section>

<!-- =============== 8. –ê–ù–ê–õ–ò–¢–ò–ö–ê ================= -->
<section id="analytics" class="p-4 hidden">
    <h2 class="text-xl font-bold mb-4">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>

    <div id="analyticsContent" class="space-y-4 text-sm"></div>
</section>

<!-- =============== 9. –ü–û –ú–ï–°–Ø–¶–ê–ú ================= -->
<section id="months" class="p-4 hidden">
    <h2 class="text-xl font-bold mb-4">üìÜ –ü–æ –º–µ—Å—è—Ü–∞–º</h2>

    <table class="w-full text-sm">
        <thead>
            <tr class="text-left text-gray-300">
                <th>–ú–µ—Å—è—Ü</th><th>–î–æ–ª–≥.</th><th>–ò–Ω–¥–∏–≤.</th><th>–ê—Ä–µ–Ω–¥–∞</th><th>–ü–∞—Å—Å–∏–≤</th><th>–†–∞—Å—Ö–æ–¥—ã</th><th>–ü—Ä–∏–±—ã–ª—å</th><th></th>
            </tr>
        </thead>
        <tbody id="monthsTable"></tbody>
        <tfoot>
            <tr class="bg-black text-white font-bold">
                <td>–ò–¢–û–ì–û</td>
                <td id="mD"></td>
                <td id="mI"></td>
                <td id="mA"></td>
                <td id="mP"></td>
                <td id="mE"></td>
                <td id="mPr"></td>
                <td></td>
            </tr>
        </tfoot>
    </table>
</section>

<!-- =============== 10. –°–í–û–î–ö–ê ================= -->
<section id="summary" class="p-4 hidden">
    <h2 class="text-xl font-bold mb-4">üìà –°–≤–æ–¥–∫–∞</h2>

    <div id="summaryContent" class="space-y-2 text-sm"></div>

    <button 
        onclick="exportCSV()" 
        class="mt-4 bg-green-600 px-4 py-2 rounded text-black font-bold">
        –≠–∫—Å–ø–æ—Ä—Ç CSV
    </button>
</section>

<!-- =============== –ö–ù–û–ü–ö–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø ================= -->
<div class="floating-add" onclick="openAddForm()">+</div>

<!-- ========================= –ú–û–î–ê–õ–ö–ê ===================== -->
<div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
    <div class="bg-gray-900 p-4 rounded w-full max-w-md">
        <h3 id="modalTitle" class="text-lg font-bold mb-3"></h3>
        <div id="modalForm"></div>

        <div class="flex justify-between mt-4">
            <button onclick="closeModal()" class="px-4 py-2 bg-gray-700 rounded">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="saveEntry()" class="px-4 py-2 bg-green-600 text-black rounded font-bold">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- ========================= JAVASCRIPT –õ–û–ì–ò–ö–ê ===================== -->
<script>

// ======================== –°–ò–°–¢–ï–ú–ê –•–†–ê–ù–ï–ù–ò–Ø ======================
// CloudStorage + fallback ‚Üí localStorage

function saveData(key, value) {
    if (window.Telegram?.WebApp?.cloudStorage) {
        Telegram.WebApp.cloudStorage.setItem(key, JSON.stringify(value), () => {});
    }
    localStorage.setItem(key, JSON.stringify(value));
}

function loadData(key, fallback = []) {
    try {
        if (window.Telegram?.WebApp?.cloudStorage) {
            Telegram.WebApp.cloudStorage.getItem(key, (err, res) => {});
        }
    } catch (e) {}
    return JSON.parse(localStorage.getItem(key) || "[]");
}

// ======================= –î–ê–ù–ù–´–ï ======================
let data = {
    dolgo: loadData("dolgo"),
    indi: loadData("indi"),
    arenda: loadData("arenda"),
    exp: loadData("exp"),
    passive: loadData("passive"),
    students: loadData("students"),
    months: loadData("months")
};

// –¢–µ–∫—É—â–∞—è –≤–∫–ª–∞–¥–∫–∞ –∏ —Ç–µ–∫—É—â–∞—è –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
let currentTab = "monthly";
let editing = null;

// ======================= –û–¢–†–ò–°–û–í–ö–ê –í–ö–õ–ê–î–û–ö ======================
document.querySelectorAll("#tabs button").forEach(btn => {
    btn.addEventListener("click", () => {
        document.querySelectorAll("#tabs button").forEach(b => b.classList.remove("tab-active"));
        btn.classList.add("tab-active");

        currentTab = btn.dataset.tab;

        document.querySelectorAll("section").forEach(sec => sec.classList.add("hidden"));
        document.getElementById(currentTab).classList.remove("hidden");

        render();
    });
});
document.querySelector('#tabs button[data-tab="monthly"]').classList.add("tab-active");
document.getElementById("monthly").classList.remove("hidden");

// ======================= –ü–ï–†–ï–†–ò–°–û–í–ö–ê –í–°–ï–ì–û ======================
function render() {
    renderDolgo();
    renderIndi();
    renderArenda();
    renderExp();
    renderPassive();
    renderStudents();
    renderMonths();
    renderMonthly();
    renderSummary();
    updateAnalytics();
    updateGoal();
}

// ======================= –†–ê–°–ß–Å–¢ –¶–ï–õ–ò 1–ú ======================
function updateGoal() {
    const profit = calculateTotalProfit();
    const percent = Math.min(100, (profit / 1_000_000) * 100);
    document.getElementById("goalProgress").style.width = percent + "%";
    document.getElementById("goalText").innerText = profit + "‚ÇΩ ‚Üí 1,000,000‚ÇΩ";
}

// ======================= –†–ï–ù–î–ï–† –ö–ê–ñ–î–û–ô –¢–ê–ë–õ–ò–¶–´ ======================
// –î–æ–ª–≥–æ–ª–µ—Ç–∏–µ
function renderDolgo() {
    const table = document.getElementById("dolgoTable");
    table.innerHTML = "";

    let inc = 0, tch = 0, hall = 0, prf = 0;

    data.dolgo.forEach((r, i) => {
        inc += +r.income;
        tch += +r.teacher;
        hall += +r.hall;
        prf += +r.profit;

        table.innerHTML += `
            <tr>
                <td>${r.date}</td>
                <td>${r.loc}</td>
                <td>${r.teacherName}</td>
                <td>${r.rate}</td>
                <td>${r.people}</td>
                <td>${r.income}</td>
                <td>${r.teacher}</td>
                <td>${r.hall}</td>
                <td class="${r.profit >= 0 ? "profit-green" : "profit-red"}">${r.profit}</td>
                <td>
                    <button onclick="editEntry('dolgo', ${i})" class="text-blue-400">‚úè</button>
                    <button onclick="deleteEntry('dolgo', ${i})" class="text-red-400">‚úñ</button>
                </td>
            </tr>
        `;
    });

    document.getElementById("dolgoIncome").innerText = inc;
    document.getElementById("dolgoTeacher").innerText = tch;
    document.getElementById("dolgoHall").innerText = hall;
    document.getElementById("dolgoProfit").innerText = prf;
}

// –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ
function renderIndi() {
    const t = document.getElementById("indiTable");
    t.innerHTML = "";

    let total = 0;

    data.indi.forEach((r, i) => {
        total += +r.sum;

        t.innerHTML += `
            <tr>
                <td>${r.date}</td>
                <td>${r.type}</td>
                <td>${r.client}</td>
                <td>${r.sum}</td>
                <td>
                    <button onclick="editEntry('indi', ${i})" class="text-blue-400">‚úè</button>
                    <button onclick="deleteEntry('indi', ${i})" class="text-red-400">‚úñ</button>
                </td>
            </tr>
        `;
    });
    document.getElementById("indiTotal").innerText = total;
}

// –ê—Ä–µ–Ω–¥–∞
function renderArenda() {
    const t = document.getElementById("arendaTable");
    t.innerHTML = "";

    let total = 0;

    data.arenda.forEach((r, i) => {
        total += +r.sum;

        t.innerHTML += `
            <tr>
                <td>${r.date}</td>
                <td>${r.name}</td>
                <td>${r.sum}</td>
                <td>
                    <button onclick="editEntry('arenda', ${i})" class="text-blue-400">‚úè</button>
                    <button onclick="deleteEntry('arenda', ${i})" class="text-red-400">‚úñ</button>
                </td>
            </tr>
        `;
    });
    document.getElementById("arendaTotal").innerText = total;
}

// –†–∞—Å—Ö–æ–¥—ã
function renderExp() {
    const t = document.getElementById("expTable");
    t.innerHTML = "";

    let total = 0;

    data.exp.forEach((r, i) => {
        total += +r.sum;

        t.innerHTML += `
            <tr>
                <td>${r.date}</td>
                <td>${r.type}</td>
                <td>${r.what}</td>
                <td>${r.sum}</td>
                <td>
                    <button onclick="editEntry('exp', ${i})" class="text-blue-400">‚úè</button>
                    <button onclick="deleteEntry('exp', ${i})" class="text-red-400">‚úñ</button>
                </td>
            </tr>
        `;
    });
    document.getElementById("expTotal").innerText = total;
}

// –ü–∞—Å—Å–∏–≤
function renderPassive() {
    const t = document.getElementById("passiveTable");
    t.innerHTML = "";

    let total = 0;

    data.passive.forEach((r, i) => {
        total += +r.sum;

        t.innerHTML += `
            <tr>
                <td>${r.date}</td>
                <td>${r.src}</td>
                <td>${r.sum}</td>
                <td>
                    <button onclick="editEntry('passive', ${i})" class="text-blue-400">‚úè</button>
                    <button onclick="deleteEntry('passive', ${i})" class="text-red-400">‚úñ</button>
                </td>
            </tr>
        `;
    });
    document.getElementById("passiveTotal").innerText = total;
}

// –£—á–µ–Ω–∏–∫–∏
function renderStudents() {
    const t = document.getElementById("studentsTable");
    t.innerHTML = "";

    let act = 0;

    data.students.forEach((r, i) => {
        if (r.status === "–ê–∫—Ç–∏–≤–Ω—ã–π") act++;

        t.innerHTML += `
            <tr>
                <td>${r.name}</td>
                <td>${r.phone}</td>
                <td>${r.group}</td>
                <td>${r.abon}</td>
                <td>${r.until}</td>
                <td>${r.status}</td>
                <td>
                    <button onclick="editEntry('students', ${i})" class="text-blue-400">‚úè</button>
                    <button onclick="deleteEntry('students', ${i})" class="text-red-400">‚úñ</button>
                </td>
            </tr>
        `;
    });

    document.getElementById("stAll").innerText = data.students.length;
    document.getElementById("stActive").innerText = act;
    document.getElementById("stAvg").innerText = (calculateTotalProfit() / (act || 1)).toFixed(0);
}

// –ú–µ—Å—è—Ü—ã
function renderMonths() {
    const t = document.getElementById("monthsTable");
    t.innerHTML = "";

    let d=0,i=0,a=0,p=0,e=0,pr=0;

    data.months.forEach((r, idx) => {
        d+=+r.d;
        i+=+r.i;
        a+=+r.a;
        p+=+r.p;
        e+=+r.e;
        pr+=+r.pr;

        t.innerHTML += `
            <tr>
                <td>${r.m}/${r.y}</td>
                <td>${r.d}</td>
                <td>${r.i}</td>
                <td>${r.a}</td>
                <td>${r.p}</td>
                <td>${r.e}</td>
                <td>${r.pr}</td>
                <td>
                    <button onclick="editEntry('months', ${idx})" class="text-blue-400">‚úè</button>
                    <button onclick="deleteEntry('months', ${idx})" class="text-red-400">‚úñ</button>
                </td>
            </tr>
        `;
    });

    document.getElementById("mD").innerText = d;
    document.getElementById("mI").innerText = i;
    document.getElementById("mA").innerText = a;
    document.getElementById("mP").innerText = p;
    document.getElementById("mE").innerText = e;
    document.getElementById("mPr").innerText = pr;
}

// –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç
function renderMonthly() {
    const t = document.getElementById("monthlyTable");

    let dIn=0, dEx=0, dPr=0;

    // –î–æ–ª–≥–æ–ª–µ—Ç–∏–µ
    let incD = data.dolgo.reduce((a,b)=>a+Number(b.income),0);
    let tchD = data.dolgo.reduce((a,b)=>a+Number(b.teacher),0);
    let hallD = data.dolgo.reduce((a,b)=>a+Number(b.hall),0);
    let prD = incD - tchD - hallD;

    // –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª–∫–∏
    let incI = data.indi.reduce((a,b)=>a+Number(b.sum),0);

    // –ê—Ä–µ–Ω–¥–∞
    let incA = data.arenda.reduce((a,b)=>a+Number(b.sum),0);

    // –ü–∞—Å—Å–∏–≤
    let incP = data.passive.reduce((a,b)=>a+Number(b.sum),0);

    // –†–∞—Å—Ö–æ–¥—ã
    let ex = data.exp.reduce((a,b)=>a+Number(b.sum),0);

    t.innerHTML = `
        <tr><td>–î–æ–ª–≥–æ–ª–µ—Ç–∏–µ</td><td>${incD}</td><td>${tchD+hallD}</td><td>${prD}</td></tr>
        <tr><td>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ</td><td>${incI}</td><td>0</td><td>${incI}</td></tr>
        <tr><td>–ê—Ä–µ–Ω–¥–∞</td><td>${incA}</td><td>0</td><td>${incA}</td></tr>
        <tr><td>–ü–∞—Å—Å–∏–≤–Ω—ã–π</td><td>${incP}</td><td>0</td><td>${incP}</td></tr>
        <tr><td>–†–∞—Å—Ö–æ–¥—ã</td><td>0</td><td>${ex}</td><td>-${ex}</td></tr>
    `;

    let inc = incD + incI + incA + incP;
    let exT = ex + tchD + hallD;
    let pr = inc - exT;

    document.getElementById("mTotalIncome").innerText = inc;
    document.getElementById("mTotalExpense").innerText = exT;
    document.getElementById("mTotalProfit").innerText = pr;
}

// –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å
function calculateTotalProfit() {
    let total = 0;
    data.dolgo.forEach(r => total += +r.profit);
    data.indi.forEach(r => total += +r.sum);
    data.arenda.forEach(r => total += +r.sum);
    data.passive.forEach(r => total += +r.sum);
    data.exp.forEach(r => total -= +r.sum);
    return total;
}

// ======================= –ê–ù–ê–õ–ò–¢–ò–ö–ê ==========================
function updateAnalytics() {
    const el = document.getElementById("analyticsContent");
    el.innerHTML = "";

    const profit = calculateTotalProfit();

    // –¢–æ–ø –ø–µ–¥–∞–≥–æ–≥–æ–≤
    const profitMap = {
        "–î–æ–ª–≥–æ–ª–µ—Ç–∏–µ": data.dolgo.reduce((a,b)=>a+Number(b.profit),0),
        "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª–∫–∏": data.indi.reduce((a,b)=>a+Number(b.sum),0),
        "–ê—Ä–µ–Ω–¥–∞": data.arenda.reduce((a,b)=>a+Number(b.sum),0)
    };

    const sorted = Object.entries(profitMap).sort((a,b)=>b[1]-a[1]);

    el.innerHTML += `
        <div class="bg-gray-800 p-3 rounded">
            <div class="font-bold mb-2">–§–∏–Ω–∞–Ω—Å—ã</div>
            <div>–î–æ—Ö–æ–¥: ${document.getElementById("mTotalIncome").innerText}‚ÇΩ</div>
            <div>–ü—Ä–∏–±—ã–ª—å: ${profit}‚ÇΩ</div>
            <div>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å: ${(profit / (profit+1e-9) * 100).toFixed(0)}%</div>
        </div>

        <div class="bg-gray-800 p-3 rounded">
            <div class="font-bold mb-2">–¢–û–ü –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π</div>
            ${sorted.map(([name,val]) => `
                <div class="flex justify-between border-b border-gray-700 py-1">
                    <span>${name}</span>
                    <span>${val}‚ÇΩ</span>
                </div>
            `).join("")}
        </div>

        <div class="bg-gray-800 p-3 rounded">
            <div class="font-bold mb-2">–ü—Ä–æ–≥—Ä–µ—Å—Å –∫ 1,000,000‚ÇΩ</div>
            <div>${profit}‚ÇΩ / 1,000,000‚ÇΩ (${(profit/1e6*100).toFixed(1)}%)</div>
        </div>
    `;
}

// ======================= –°–í–û–î–ö–ê ==========================
function renderSummary() {
    const el = document.getElementById("summaryContent");

    let incD = data.dolgo.reduce((a,b)=>a+Number(b.profit),0);
    let incI = data.indi.reduce((a,b)=>a+Number(b.sum),0);
    let incA = data.arenda.reduce((a,b)=>a+Number(b.sum),0);
    let incP = data.passive.reduce((a,b)=>a+Number(b.sum),0);
    let ex = data.exp.reduce((a,b)=>a+Number(b.sum),0);

    let total = incD + incI + incA + incP - ex;

    el.innerHTML = `
        <div>–î–æ–ª–≥–æ–ª–µ—Ç–∏–µ: ${incD}‚ÇΩ</div>
        <div>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª–∫–∏: ${incI}‚ÇΩ</div>
        <div>–ê—Ä–µ–Ω–¥–∞ –∑–∞–ª–∞: ${incA}‚ÇΩ</div>
        <div>–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥: ${incP}‚ÇΩ</div>
        <div>–†–∞—Å—Ö–æ–¥—ã: -${ex}‚ÇΩ</div>
        <div class="font-bold mt-2">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å: ${total}‚ÇΩ</div>
    `;
}

// ======================= –î–û–ë–ê–í–õ–ï–ù–ò–ï / –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï ======================
function openAddForm() {
    editing = null;
    showModal(currentTab, null);
}
function editEntry(type, i) {
    editing = {type, index:i};
    showModal(type, data[type][i]);
}
function deleteEntry(type, i) {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?")) return;
    data[type].splice(i,1);
    saveData(type, data[type]);
    render();
}

function showModal(type, record) {
    document.getElementById("modal").classList.remove("hidden");
    const form = document.getElementById("modalForm");
    const title = document.getElementById("modalTitle");

    title.innerText = editing ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" : "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ";

    // –°–ï–ô–ß–ê–° –í–°–¢–ê–í–õ–Ø–Æ –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ï –§–û–†–ú–´
    // –î–æ–ª–≥–æ–ª–µ—Ç–∏–µ
    if (type === "dolgo") {
        const dateVal = record?.date || new Date().toISOString().slice(0,10);
        form.innerHTML = `
            <label>–î–∞—Ç–∞<input id="f_date" type="date" value="${dateVal}" class="w-full bg-gray-800 p-2 rounded"></label>
            <label>–õ–æ–∫–∞—Ü–∏—è<select id=\"f_loc\" class=\"w-full bg-gray-800 p-2 rounded\">
                <option ${record?.loc==="–ë—É–¥–µ–Ω–Ω–æ–≥–æ"?"selected":""}>–ë—É–¥–µ–Ω–Ω–æ–≥–æ</option>
                <option ${record?.loc==="–ß–µ—Ä–∫–∏–∑–æ–≤—Å–∫–∞—è"?"selected":""}>–ß–µ—Ä–∫–∏–∑–æ–≤—Å–∫–∞—è</option>
                <option ${record?.loc==="–ü–∞—Ä–∫"?"selected":""}>–ü–∞—Ä–∫</option>
            </select></label>
            <label>–ü–µ–¥–∞–≥–æ–≥<input id="f_teacherName" class="w-full bg-gray-800 p-2 rounded" value="${record?.teacherName||""}"></label>
            <label>–°—Ç–∞–≤–∫–∞<select id="f_rate" class="w-full bg-gray-800 p-2 rounded">
                <option ${record?.rate==="50%"?"selected":""}>50%</option>
                <option ${record?.rate==="700"?"selected":""}>700</option>
                <option ${record?.rate==="1000"?"selected":""}>1000</option>
                <option ${record?.rate==="100%"?"selected":""}>100%</option>
            </select></label>
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫<input id="f_people" class="w-full bg-gray-800 p-2 rounded" value="${record?.people||""}"></label>
            <label>–†–∞—Å—Ö–æ–¥ –∑–∞–ª–∞<input id="f_hall" class="w-full bg-gray-800 p-2 rounded" value="${record?.hall||0}"></label>
        `;
    }

    // –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª–∫–∏
    if (type === "indi") {
        const dateVal = record?.date || new Date().toISOString().slice(0,10);
        form.innerHTML = `
            <label>–î–∞—Ç–∞<input id="f_date" type="date" value="${dateVal}" class="w-full bg-gray-800 p-2 rounded"></label>
            <label>–¢–∏–ø<select id="f_type" class="w-full bg-gray-800 p-2 rounded">
                <option>–ê–∑–±—É–∫–∞ —Ç–∞–Ω—Ü–∞</option>
                <option>–õ–∞—Ç–∏–Ω—Å–∫–∏–π –∫–≤–∞—Ä—Ç–µ—Ç</option>
                <option>–ü—Ä–æ–∞–º</option>
                <option>–ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞</option>
                <option>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</option>
                <option>–û—Å—Ç–∞–ª—å–Ω—ã–µ</option>
            </select></label>
            <label>–ö–ª–∏–µ–Ω—Ç<input id="f_client" class="w-full bg-gray-800 p-2 rounded" value="${record?.client||""}"></label>
            <label>–°—É–º–º–∞<input id="f_sum" class="w-full bg-gray-800 p-2 rounded" value="${record?.sum||""}"></label>
        `;
    }

    // –ê—Ä–µ–Ω–¥–∞
    if (type === "arenda") {
        const dateVal = record?.date || new Date().toISOString().slice(0,10);
        form.innerHTML = `
            <label>–î–∞—Ç–∞<input id="f_date" type="date" value="${dateVal}" class="w-full bg-gray-800 p-2 rounded"></label>
            <label>–ò–º—è<input id="f_name" class="w-full bg-gray-800 p-2 rounded" value="${record?.name||""}"></label>
            <label>–°—É–º–º–∞<input id="f_sum" class="w-full bg-gray-800 p-2 rounded" value="${record?.sum||""}"></label>
        `;
    }

    // –†–∞—Å—Ö–æ–¥—ã
    if (type === "exp") {
        const dateVal = record?.date || new Date().toISOString().slice(0,10);
        form.innerHTML = `
            <label>–î–∞—Ç–∞<input id="f_date" type="date" value="${dateVal}" class="w-full bg-gray-800 p-2 rounded"></label>
            <label>–¢–∏–ø<select id="f_type" class="w-full bg-gray-800 p-2 rounded">
                <option>–ê—Ä–µ–Ω–¥–∞ –∑–∞–ª–∞</option>
                <option>–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</option>
                <option>–£–≤–ª–µ—á–µ–Ω–∏—è</option>
            </select></label>
            <label>–ß—Ç–æ<input id="f_what" class="w-full bg-gray-800 p-2 rounded" value="${record?.what||""}"></label>
            <label>–°—É–º–º–∞<input id="f_sum" class="w-full bg-gray-800 p-2 rounded" value="${record?.sum||""}"></label>
        `;
    }

    // –ü–∞—Å—Å–∏–≤
    if (type === "passive") {
        const dateVal = record?.date || new Date().toISOString().slice(0,10);
        form.innerHTML = `
            <label>–î–∞—Ç–∞<input id="f_date" type="date" value="${dateVal}" class="w-full bg-gray-800 p-2 rounded"></label>
            <label>–ò—Å—Ç–æ—á–Ω–∏–∫<input id="f_src" class="w-full bg-gray-800 p-2 rounded" value="${record?.src||""}"></label>
            <label>–°—É–º–º–∞<input id="f_sum" class="w-full bg-gray-800 p-2 rounded" value="${record?.sum||""}"></label>
        `;
    }

    // –£—á–µ–Ω–∏–∫–∏
    if (type === "students") {
        form.innerHTML = `
            <label>–ò–º—è<input id="f_name" class="w-full bg-gray-800 p-2 rounded" value="${record?.name||""}"></label>
            <label>–¢–µ–ª–µ—Ñ–æ–Ω<input id="f_phone" class="w-full bg-gray-800 p-2 rounded" value="${record?.phone||""}"></label>
            <label>–ì—Ä—É–ø–ø–∞<select id="f_group" class="w-full bg-gray-800 p-2 rounded">
                <option>–î–æ–ª–≥–æ–ª–µ—Ç–∏–µ –ë—É–¥–µ–Ω–Ω–æ–≥–æ</option>
                <option>–î–æ–ª–≥–æ–ª–µ—Ç–∏–µ –ß–µ—Ä–∫–∏–∑–æ–≤—Å–∫–∞—è</option>
                <option>–õ–∞—Ç–∏–Ω—Å–∫–∏–π</option>
                <option>–ü—Ä–æ–∞–º</option>
                <option>–í–Ω—É–∫–æ–≤–æ</option>
            </select></label>
            <label>–ê–±–æ–Ω–µ–º–µ–Ω—Ç<input id="f_abon" class="w-full bg-gray-800 p-2 rounded" value="${record?.abon||""}"></label>
            <label>–î–æ<input id="f_until" type="date" class="w-full bg-gray-800 p-2 rounded" value="${record?.until||""}"></label>
            <label>–°—Ç–∞—Ç—É—Å<select id="f_status" class="w-full bg-gray-800 p-2 rounded">
                <option>–ê–∫—Ç–∏–≤–Ω—ã–π</option>
                <option>–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π</option>
                <option>–ü—Ä–æ–±–Ω—ã–π</option>
            </select></label>
        `;
    }

    // –ü–æ –º–µ—Å—è—Ü–∞–º
    if (type === "months") {
        form.innerHTML = `
            <label>–ú–µ—Å—è—Ü<input id="f_m" class="w-full bg-gray-800 p-2 rounded" value="${record?.m||""}"></label>
            <label>–ì–æ–¥<input id="f_y" class="w-full bg-gray-800 p-2 rounded" value="${record?.y||""}"></label>
            <label>–î–æ–ª–≥–æ–ª–µ—Ç–∏–µ<input id="f_d" class="w-full bg-gray-800 p-2 rounded" value="${record?.d||""}"></label>
            <label>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª–∫–∏<input id="f_i" class="w-full bg-gray-800 p-2 rounded" value="${record?.i||""}"></label>
            <label>–ê—Ä–µ–Ω–¥–∞<input id="f_a" class="w-full bg-gray-800 p-2 rounded" value="${record?.a||""}"></label>
            <label>–ü–∞—Å—Å–∏–≤<input id="f_p" class="w-full bg-gray-800 p-2 rounded" value="${record?.p||""}"></label>
            <label>–†–∞—Å—Ö–æ–¥—ã<input id="f_e" class="w-full bg-gray-800 p-2 rounded" value="${record?.e||""}"></label>
        `;
    }
}

function closeModal() {
    document.getElementById("modal").classList.add("hidden");
}

// ======================= –°–û–•–†–ê–ù–ï–ù–ò–ï ======================
function saveEntry() {
    let type = currentTab;
    if (editing) type = editing.type;

    const f = id => document.getElementById(id)?.value;

    let rec = {};

    if (type === "dolgo") {
        const income = Number(f("f_people")) * 280;
        let teacher = 0;

        const rate = f("f_rate");
        if (rate === "50%") teacher = income * 0.5;
        if (rate === "100%") teacher = income;
        if (rate === "700") teacher = 700;
        if (rate === "1000") teacher = 1000;

        rec = {
            date: f("f_date"),
            loc: f("f_loc"),
            teacherName: f("f_teacherName"),
            rate: rate,
            people: f("f_people"),
            income: income,
            teacher: teacher,
            hall: Number(f("f_hall")),
            profit: income - teacher - Number(f("f_hall"))
        };
    }

    if (type === "indi") {
        rec = {
            date: f("f_date"),
            type: f("f_type"),
            client: f("f_client"),
            sum: Number(f("f_sum"))
        };
    }

    if (type === "arenda") {
        rec = {
            date: f("f_date"),
            name: f("f_name"),
            sum: Number(f("f_sum"))
        };
    }

    if (type === "exp") {
        rec = {
            date: f("f_date"),
            type: f("f_type"),
            what: f("f_what"),
            sum: Number(f("f_sum"))
        };
    }

    if (type === "passive") {
        rec = {
            date: f("f_date"),
            src: f("f_src"),
            sum: Number(f("f_sum"))
        };
    }

    if (type === "students") {
        rec = {
            name: f("f_name"),
            phone: f("f_phone"),
            group: f("f_group"),
            abon: f("f_abon"),
            until: f("f_until"),
            status: f("f_status")
        };
    }

    if (type === "months") {
        const sum = Number(f("f_d")) + Number(f("f_i")) + Number(f("f_a")) + Number(f("f_p")) - Number(f("f_e"));

        rec = {
            m: f("f_m"),
            y: f("f_y"),
            d: Number(f("f_d")),
            i: Number(f("f_i")),
            a: Number(f("f_a")),
            p: Number(f("f_p")),
            e: Number(f("f_e")),
            pr: sum
        };
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    if (editing) {
        data[type][editing.index] = rec;
    } else {
        data[type].push(rec);
    }

    saveData(type, data[type]);
    closeModal();
    render();
}

// ======================= CSV ======================
function exportCSV() {
    let csv = "–ö–∞—Ç–µ–≥–æ—Ä–∏—è,–î–æ—Ö–æ–¥,–†–∞—Å—Ö–æ–¥,–ü—Ä–∏–±—ã–ª—å\n";

    csv += "–î–æ–ª–≥–æ–ª–µ—Ç–∏–µ," +
        document.getElementById("dolgoIncome").innerText + "," +
        (Number(document.getElementById("dolgoTeacher").innerText) + Number(document.getElementById("dolgoHall").innerText)) + "," +
        document.getElementById("dolgoProfit").innerText + "\n";

    csv += "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª–∫–∏," + document.getElementById("indiTotal").innerText + ",0," + document.getElementById("indiTotal").innerText + "\n";
    csv += "–ê—Ä–µ–Ω–¥–∞," + document.getElementById("arendaTotal").innerText + ",0," + document.getElementById("arendaTotal").innerText + "\n";
    csv += "–ü–∞—Å—Å–∏–≤–Ω—ã–π," + document.getElementById("passiveTotal").innerText + ",0," + document.getElementById("passiveTotal").innerText + "\n";
    csv += "–†–∞—Å—Ö–æ–¥—ã,0," + document.getElementById("expTotal").innerText + ",-" + document.getElementById("expTotal").innerText + "\n";

    const blob = new Blob([csv], {type: "text/csv"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "–û—Ç—á—ë—Ç.csv";
    a.click();
}

// ======================= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ======================
render();

</script>

</body>
</html>
