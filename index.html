<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Финансовый бот</title>
<style>
:root{--brand:#2563eb;--muted:#6b7280}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:#f3f4f6; color:#111}
header{background:var(--brand); color:#fff; padding:14px 16px; display:flex; gap:12px; align-items:center}
header h1{font-size:16px; margin:0; flex:1}
main{max-width:1100px; margin:12px auto; padding:12px; background:#fff; border-radius:10px}
nav.tabs{display:flex; gap:8px; margin-bottom:10px; overflow:auto; padding-bottom:6px}
.tab{padding:8px 12px; border-radius:8px; background:#eef2ff; color:var(--brand); font-weight:600; cursor:pointer}
.tab.active{background:var(--brand); color:#fff}
.toolbar{display:flex; gap:8px; align-items:center;margin-bottom:10px; flex-wrap:wrap}
.btn{background:var(--brand); color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer}
.btn.ghost{background:#fff; color:var(--brand); border:1px solid var(--brand)}
table{width:100%; border-collapse:collapse; margin-top:8px; font-size:14px}
th,td{padding:8px; border:1px solid #e6edf3; text-align:left}
th{background:#f8fafc}
.card{background:#f8fafc; padding:10px; border-radius:8px;border:1px solid #eef2ff;min-width:140px}
.card-row{display:flex; gap:8px; margin:8px 0; flex-wrap:wrap}
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:999}
.modal .box{background:#fff;padding:14px;border-radius:8px;width:720px;max-width:95%;max-height:86%;overflow:auto}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef9;margin-bottom:8px}
.small{font-size:13px;padding:6px 8px;border-radius:6px}
.link-like{color:var(--brand); cursor:pointer; text-decoration:underline}
</style>
</head>
<body>
<header><h1>Финансовый бот</h1></header>

<main id="app">
  <nav class="tabs"></nav>
  <div class="toolbar"></div>
  <div id="content"></div>
</main>

<div id="modal-root"></div>

<script>
/*** DATA ***/
let state = JSON.parse(localStorage.getItem('finData_v2')||'{}');
// initialize structures if missing
if(!state.monthlyData) state.monthlyData=[];
if(!state.locationsMD) state.locationsMD = {
 "Буденного":{rent:0,rate:0,type:"%"},
 "Черкизовская":{rent:0,rate:0,type:"%"},
 "Парк":{rent:0,rate:0,type:"фикс"},
};
if(!state.students) state.students = [];
if(!state.monthlyResults) state.monthlyResults = [];
const TABS=["Месячный отчёт","Аналитика","База учеников","По месяцам","Настройки"];

function save(){localStorage.setItem('finData_v2',JSON.stringify(state));}

/* UI helpers */
function renderTabs(){
 const nav=document.querySelector(".tabs");
 nav.innerHTML="";
 TABS.forEach(t=>{
   const b=document.createElement("div");
   b.className="tab"+(t===active?" active":"");
   b.textContent=t;
   b.onclick=()=>{ active=t; saveActive(); render(); }
   nav.appendChild(b);
 })
}

let active = localStorage.getItem('activeTab2')||"Месячный отчёт";
function saveActive(){localStorage.setItem('activeTab2',active);}

function render(){
 renderTabs();
 const toolbar=document.querySelector(".toolbar");
 const content=document.getElementById("content");
 toolbar.innerHTML=""; content.innerHTML="";
 // toolbar buttons common
 if(active==="Месячный отчёт"){
   renderMonthlyToolbar(toolbar);
   renderMonthly(toolbar,content);
 } else if(active==="Аналитика"){
   renderAnalytics(content, toolbar);
 } else if(active==="База учеников"){
   renderStudents(content, toolbar);
 } else if(active==="По месяцам"){
   renderByMonths(content, toolbar);
 } else if(active==="Настройки"){
   renderSettings(content, toolbar);
 }
}

function addBtn(text,cb, cls){
 const b=document.createElement("button");
 b.className = cls ? ('btn '+cls) : 'btn';
 b.textContent=text;
 b.onclick=cb;
 return b;
}

function modal(inner){
 const root=document.getElementById("modal-root");
 root.innerHTML="";
 const m=document.createElement("div");
 m.className="modal";
 const box=document.createElement("div");
 box.className="box";
 if(inner instanceof HTMLElement) box.appendChild(inner);
 else box.innerHTML = inner;
 m.appendChild(box);
 root.appendChild(m);
 m.onclick=e=>{ if(e.target===m) root.innerHTML=""; };
}
function closeModal(){ document.getElementById("modal-root").innerHTML=""; }

function label(t){const e=document.createElement("label"); e.textContent = t; return e; }
function i(name,type="text", val=''){ const e=document.createElement("input"); e.name=name; e.type=type; e.value = val; return e;}
function s(options, val){ const e=document.createElement("select"); options.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; if(v===val) o.selected=true; e.appendChild(o);}); return e;}
function fmt(n){ return (Number(n)||0).toLocaleString('ru-RU'); }

/*** MONTHLY tab toolbar + table ***/
function renderMonthlyToolbar(toolbar){
 toolbar.appendChild(addBtn("Добавить",()=> modal(monthForm())));
 const exp = addBtn("Экспорт CSV", ()=> exportCSV(), 'btn ghost');
 toolbar.appendChild(exp);
 const imp = addBtn("Импорт JSON", ()=> openImportModal(), 'btn ghost');
 toolbar.appendChild(imp);
 const info = document.createElement('div'); info.className='small'; info.style.marginLeft='auto'; info.textContent = `Записей: ${state.monthlyData.length}`;
 toolbar.appendChild(info);
}

function renderMonthly(tb,content){
 const tbl = document.createElement("table");
 tbl.innerHTML = `<thead><tr>
 <th>Дата</th><th>Категория</th><th>Локация</th><th>Чел.</th><th>Доход</th><th>Аренда</th><th>Педагог</th><th>Прочие</th><th>Прибыль</th><th></th>
 </tr></thead><tbody></tbody>`;
 const tbody = tbl.querySelector('tbody');

 state.monthlyData.slice().reverse().forEach(r=>{
   const tr = document.createElement('tr');
   tr.innerHTML = `<td>${r.date||''}</td>
     <td>${r.category||''}</td>
     <td>${r.location||''}</td>
     <td>${r.people||0}</td>
     <td>${fmt(r.income)}</td>
     <td>${fmt(r.hall)}</td>
     <td>${fmt(r.teacher)}</td>
     <td>${fmt(r.expense)}</td>
     <td>${fmt(r.profit)}</td>
     <td><button class="small" data-edit="${r._id||r.date+Math.random()}">Ред.</button></td>`;
   // attach edit: map to index via reference
   tbody.appendChild(tr);
 });

 // simple sum footer
 const sums = state.monthlyData.reduce((s,r)=>{ s.income+=Number(r.income||0); s.hall+=Number(r.hall||0); s.teacher+=Number(r.teacher||0); s.exp+=Number(r.expense||0); s.profit+=Number(r.profit||0); return s; }, {income:0,hall:0,teacher:0,exp:0,profit:0});
 const foot = document.createElement('div'); foot.className='card-row';
 ['Доход','Аренда','Педагоги','Прочие','Прибыль'].forEach((title,i)=>{
   const c = document.createElement('div'); c.className='card'; c.innerHTML = `<div style="color:var(--muted);font-size:13px">${title}</div><div style="font-weight:700">${[fmt(sums.income),fmt(sums.hall),fmt(sums.teacher),fmt(sums.exp),fmt(sums.profit)][i]} ₽</div>`;
   foot.appendChild(c);
 });
 content.appendChild(tbl);
 content.appendChild(foot);

 // attach event for edit by row (simple approach: edit by index via date+income matching)
 tbl.addEventListener('click', (ev)=>{
   const edit = ev.target.getAttribute('data-edit');
   if(edit){
     // find candidate by matching row index (approx)
     // We'll open edit modal with select of record by index id
     openEditModal();
   }
 });
}

/* Month record form (add) */
function monthForm(existingIndex){
 const box = document.createElement('div');
 box.innerHTML = '<h3>Новая запись</h3>';
 const date = i('date','date','');
 const category = s(["Московское долголетие","Индивидуальные","Аренда зала","Пассив","Другое"], "Московское долголетие");
 const loc = s(Object.keys(state.locationsMD), Object.keys(state.locationsMD)[0]);
 const people = i('people','number','0');
 const expense = i('expense','number','0');
 const hall = i('hall','number',''); // allow auto
 const rate = i('rate','number','');
 const rateType = s(['%','фикс'], '%');
 const note = document.createElement('textarea'); note.rows=2;

 box.appendChild(label('Дата')); box.appendChild(date);
 box.appendChild(label('Категория')); box.appendChild(category);

 // MD fields container
 const mdDiv = document.createElement('div');
 mdDiv.style.marginTop='6px';
 mdDiv.appendChild(label('Локация')); mdDiv.appendChild(loc);
 mdDiv.appendChild(label('Ставка педагога')); mdDiv.appendChild(rate);
 mdDiv.appendChild(label('Тип ставки')); mdDiv.appendChild(rateType);
 mdDiv.appendChild(label('Аренда зала (если пусто подставится настройка)')); mdDiv.appendChild(hall);

 box.appendChild(mdDiv);

 box.appendChild(label('Кол-во человек')); box.appendChild(people);
 box.appendChild(label('Прочие расходы')); box.appendChild(expense);
 box.appendChild(label('Примечание')); box.appendChild(note);

 // show/hide mdDiv based on category
 function toggleMD(){ mdDiv.style.display = (category.value==="Московское долголетие") ? 'block' : 'none'; }
 category.onchange = toggleMD; toggleMD();

 // auto calc preview
 const preview = document.createElement('div'); preview.className='card-row';
 const pIncome = document.createElement('div'); pIncome.className='card';
 pIncome.innerHTML = '<div class="muted">Доход</div><div class="bold" id="v-income">0 ₽</div>';
 const pTeacher = document.createElement('div'); pTeacher.className='card';
 pTeacher.innerHTML = '<div class="muted">Педагог</div><div class="bold" id="v-teacher">0 ₽</div>';
 const pProfit = document.createElement('div'); pProfit.className='card';
 pProfit.innerHTML = '<div class="muted">Прибыль</div><div class="bold" id="v-profit">0 ₽</div>';
 preview.appendChild(pIncome); preview.appendChild(pTeacher); preview.appendChild(pProfit);
 box.appendChild(preview);

 function recalc(){
   const p = Number(people.value||0);
   let income = 0, teacherCost = 0;
   let h = Number(hall.value||0);
   if(category.value === "Московское долголетие"){
     income = p * 280;
     const conf = state.locationsMD[loc.value] || {};
     if(!hall.value) h = Number(conf.rent||0);
     if(!rate.value) rate.value = conf.rate||0;
     if(!rateType.value) rateType.value = conf.type||"%";
     if(rateType.value === "%") teacherCost = income * (Number(rate.value||0)/100);
     else teacherCost = Number(rate.value||0);
   } else {
     // for non MD leave income zero unless you want custom -> keep 0
     income = Number(0);
     teacherCost = 0;
   }
   const others = Number(expense.value||0);
   const profit = income - h - teacherCost - others;
   document.getElementById('v-income').innerText = fmt(income) + ' ₽';
   document.getElementById('v-teacher').innerText = fmt(teacherCost) + ' ₽';
   document.getElementById('v-profit').innerText = fmt(profit) + ' ₽';
 }

 people.oninput = recalc; rate.oninput = recalc; rateType.onchange = recalc; hall.oninput = recalc; expense.oninput = recalc; loc.onchange = recalc; category.onchange = recalc;

 const saveBtn = addBtn('Сохранить', ()=>{
   const p = Number(people.value||0);
   let income=0, teacherCost=0, h = Number(hall.value||0);
   if(category.value==="Московское долголетие"){
     income = p * 280;
     const conf = state.locationsMD[loc.value] || {};
     if(!hall.value) h = Number(conf.rent||0);
     if(!rate.value) rate.value = conf.rate||0;
     if(!rateType.value) rateType.value = conf.type||"%";
     if(rateType.value === "%") teacherCost = income * (Number(rate.value||0)/100);
     else teacherCost = Number(rate.value||0);
   }
   const rec = {
     _id: Date.now() + Math.random(),
     date: date.value || new Date().toISOString().slice(0,10),
     category: category.value,
     location: category.value==="Московское долголетие" ? loc.value : '',
     people: p,
     income: income,
     hall: h,
     teacher: teacherCost,
     expense: Number(expense.value||0),
     note: note.value || '',
   };
   rec.profit = rec.income - rec.hall - rec.teacher - rec.expense;
   state.monthlyData.push(rec);
   save();
   closeModal();
   render();
 });

 box.appendChild(saveBtn);
 return box;
}

/*** ANALYTICS ***/
function renderAnalytics(content){
 const wrapper = document.createElement('div');
 wrapper.innerHTML = '<h3>Аналитика</h3><div class="muted">Рейтинг педагогов и локаций (по доходу)</div>';
 // totals and simple KPI
 let income=0, hall=0, teachers=0, exp=0, profit=0;
 state.monthlyData.forEach(r=>{ income+=Number(r.income||0); hall+=Number(r.hall||0); teachers+=Number(r.teacher||0); exp+=Number(r.expense||0); profit+=Number(r.profit||0); });

 const kpi = document.createElement('div'); kpi.className='card-row';
 [['Доход',fmt(income)],['Аренда',fmt(hall)],['Педагоги',fmt(teachers)],['Прочие',fmt(exp)],['Прибыль',fmt(profit)]].forEach(it=>{
   const c = document.createElement('div'); c.className='card'; c.innerHTML = `<div style="color:var(--muted)">${it[0]}</div><div style="font-weight:700">${it[1]} ₽</div>`; kpi.appendChild(c);
 });
 wrapper.appendChild(kpi);

 // ranking teachers
 const tmap = {};
 state.monthlyData.forEach(r=>{
   const t = r.teacherName || 'Без имени';
   if(!tmap[t]) tmap[t]={name:t,income:0,hall:0,net:0};
   tmap[t].income += Number(r.income||0);
   tmap[t].hall += Number(r.hall||0);
   tmap[t].net += Number(r.profit||0);
 });
 // include individual lessons? (not implemented separately here)
 const teachers = Object.values(tmap).sort((a,b)=>b.income-a.income);
 if(teachers.length){
   const ttable = document.createElement('table');
   ttable.innerHTML = '<thead><tr><th>#</th><th>Педагог</th><th>Доход</th><th>Аренда</th><th>Чистая прибыль</th></tr></thead><tbody></tbody>';
   teachers.slice(0,20).forEach((t,i)=>{
     const tr = document.createElement('tr');
     tr.innerHTML = `<td>${i+1}</td><td>${t.name}</td><td>${fmt(t.income)}</td><td>${fmt(t.hall)}</td><td>${fmt(t.net)}</td>`;
     ttable.querySelector('tbody').appendChild(tr);
   });
   wrapper.appendChild(document.createElement('h4')).textContent = 'Рейтинг педагогов';
   wrapper.appendChild(ttable);
 }

 // ranking locations
 const lmap = {};
 state.monthlyData.forEach(r=>{
   const l = r.location || 'Без локации';
   if(!lmap[l]) lmap[l] = {name:l,income:0,hall:0,net:0};
   lmap[l].income += Number(r.income||0);
   lmap[l].hall += Number(r.hall||0);
   lmap[l].net += Number(r.profit||0);
 });
 const clubs = Object.values(lmap).sort((a,b)=>b.income-a.income);
 if(clubs.length){
   const ltable = document.createElement('table');
   ltable.innerHTML = '<thead><tr><th>#</th><th>Локация</th><th>Доход</th><th>Аренда</th><th>Чистая прибыль</th></tr></thead><tbody></tbody>';
   clubs.slice(0,20).forEach((c,i)=>{
     const tr = document.createElement('tr');
     tr.innerHTML = `<td>${i+1}</td><td>${c.name}</td><td>${fmt(c.income)}</td><td>${fmt(c.hall)}</td><td>${fmt(c.net)}</td>`;
     ltable.querySelector('tbody').appendChild(tr);
   });
   wrapper.appendChild(document.createElement('h4')).textContent = 'Рейтинг локаций';
   wrapper.appendChild(ltable);
 }

 content.appendChild(wrapper);
}

/*** Students (База учеников) ***/
function renderStudents(content, toolbar){
 toolbar.appendChild(addBtn('Новый ученик', ()=> modal(studentForm())));
 const box = document.createElement('div');
 box.innerHTML = '<h3>База учеников</h3>';
 const tbl = document.createElement('table');
 tbl.innerHTML = '<thead><tr><th>Имя</th><th>Телефон</th><th>Группы</th><th></th></tr></thead><tbody></tbody>';
 const tbody = tbl.querySelector('tbody');
 state.students.forEach(s=>{
   const tr = document.createElement('tr');
   tr.innerHTML = `<td>${s.name}</td><td>${s.phone||''}</td><td>${(s.groups||[]).join(', ')}</td><td><button class="small" data-edit="${s.id}">Ред.</button> <button class="small" data-del="${s.id}">Удалить</button></td>`;
   tbody.appendChild(tr);
 });
 tbl.addEventListener('click', e=>{
   const id = e.target.getAttribute('data-edit');
   const del = e.target.getAttribute('data-del');
   if(id){ const s = state.students.find(x=>x.id===id); modal(studentForm(s)); }
   if(del){ if(confirm('Удалить ученика?')){ state.students = state.students.filter(x=>x.id!==del); save(); render(); } }
 });
 box.appendChild(tbl);
 content.appendChild(box);
}

function studentForm(existing){
 const box = document.createElement('div'); box.innerHTML = `<h3>${existing ? 'Редактировать' : 'Новый'} ученик</h3>`;
 const name = i('sname','text', existing?existing.name:'');
 const phone = i('sphone','text', existing?existing.phone:'');
 const groups = i('sgroups','text', existing?(existing.groups||[]).join(', '):'');
 box.appendChild(label('Имя')); box.appendChild(name);
 box.appendChild(label('Телефон')); box.appendChild(phone);
 box.appendChild(label('Группы (через запятую)')); box.appendChild(groups);
 const saveBtn = addBtn('Сохранить', ()=>{
   const nm = name.value.trim();
   if(!nm){ alert('Введите имя'); return; }
   const obj = { id: existing? existing.id : (Date.now()+Math.random()), name: nm, phone: phone.value.trim(), groups: groups.value.split(',').map(x=>x.trim()).filter(Boolean) };
   if(existing){ const idx = state.students.findIndex(x=>x.id===existing.id); state.students[idx]=obj; } else state.students.push(obj);
   save(); closeModal(); render();
 });
 box.appendChild(saveBtn);
 const cancel = addBtn('Отмена', ()=> closeModal(), 'btn ghost');
 box.appendChild(cancel);
 return box;
}

/*** По месяцам (monthlyResults) ***/
function renderByMonths(content, toolbar){
 const box = document.create
